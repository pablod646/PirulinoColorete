<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PirulinoColorete</title>
    <style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

/* Main Layout Styles */
* {
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    background: #f5f7fa;
    color: #1a1a1a;
    line-height: 1.6;
    height: 100vh;
    overflow: hidden;
    display: flex;
}

/* Sidebar Navigation */
.sidebar {
    width: 260px;
    background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
    color: white;
    display: flex;
    flex-direction: column;
    box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1);
    z-index: 10;
}

.sidebar-header {
    padding: 24px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.sidebar-logo {
    font-size: 18px;
    font-weight: 700;
    background: linear-gradient(135deg, #18A0FB 0%, #60d5ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 4px;
}

.sidebar-subtitle {
    font-size: 11px;
    color: #94a3b8;
    font-weight: 500;
    letter-spacing: 0.5px;
}

.sidebar-nav {
    flex: 1;
    overflow-y: auto;
    padding: 12px 0;
}

.nav-item {
    padding: 12px 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    font-weight: 500;
    color: #cbd5e1;
    border-left: 3px solid transparent;
}

.nav-item:hover {
    background: rgba(255, 255, 255, 0.05);
    color: white;
}

.nav-item.active {
    background: rgba(24, 160, 251, 0.15);
    color: #60d5ff;
    border-left-color: #18A0FB;
}

.nav-item-icon {
    font-size: 18px;
    width: 24px;
    text-align: center;
}

.nav-item-label {
    flex: 1;
}

/* Main Content Area */
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.content-header {
    background: white;
    padding: 20px 32px;
    border-bottom: 1px solid #e5e7eb;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.content-header h1 {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
    color: #0d0d0d;
    letter-spacing: -0.02em;
}

.content-header p {
    margin: 4px 0 0 0;
    font-size: 14px;
    color: #6b7280;
}

.content-body {
    flex: 1;
    overflow-y: auto;
    padding: 32px;
    background: #f9fafb;
}

.content-container {
    max-width: 900px;
    margin: 0 auto;
}

/* Section Content */
.section-content {
    display: none;
}

.section-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Custom Scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Resize Handle Hover Effect */
#resize-handle:hover path {
    stroke: #18A0FB;
}
/* Base Design Tokens */
:root {
    --primary: #18A0FB;
    --primary-hover: #148ad6;
    --primary-light: rgba(24, 160, 251, 0.1);

    --bg-main: #f5f7fa;
    --bg-card: #ffffff;
    --bg-hover: #f9fafb;

    --text-main: #1a1a1a;
    --text-secondary: #6b7280;
    --text-tertiary: #9ca3af;

    --border-light: #e5e7eb;
    --border-focus: #3b82f6;

    --radius-sm: 4px;
    --radius-md: 6px;
    --radius-lg: 8px;

    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* Typography Overrides */
h2 {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-main);
    margin: 0 0 16px 0;
}

h3 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-main);
    margin: 0 0 12px 0;
}

p.description,
.section-description {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 24px;
    line-height: 1.5;
}

.section-title {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-tertiary);
    font-weight: 600;
    margin: 24px 0 12px 0;
}

/* Forms & Inputs */
.input-group,
.form-group {
    margin-bottom: 16px;
}

label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 6px;
}

.sub-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    margin-top: 20px;
    margin-bottom: 12px;
    display: block;
}

input[type="text"],
input[type="number"],
select,
textarea,
.input-text {
    width: 100%;
    padding: 10px 12px;
    font-size: 13px;
    line-height: 1.5;
    color: var(--text-main);
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
    font-family: inherit;
    appearance: none;
    /* Uniform look */
}

input:focus,
select:focus,
textarea:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

input::placeholder {
    color: #d1d5db;
}

/* Custom Select Arrow */
select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
}

.select-wrapper {
    position: relative;
}

/* Buttons */
button,
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 16px;
    font-size: 13px;
    font-weight: 500;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    line-height: 1;
    gap: 8px;
}

/* Primary Button */
button.primary,
.btn-primary {
    background: var(--primary);
    color: white;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

button.primary:hover,
.btn-primary:hover {
    background: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(24, 160, 251, 0.2);
}

button.primary:active,
.btn-primary:active {
    transform: translateY(0);
}

/* Secondary Button */
button.secondary,
.btn-secondary {
    background: white;
    border: 1px solid var(--border-light);
    color: var(--text-main);
}

button.secondary:hover,
.btn-secondary:hover {
    background: var(--bg-hover);
    border-color: #d1d5db;
    color: #000;
}

/* Disabled State */
button:disabled,
.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #e5e7eb;
    color: #9ca3af;
    box-shadow: none;
    pointer-events: none;
}

/* Big Button Modifier */
.big-btn {
    padding: 14px 20px;
    font-size: 14px;
    font-weight: 600;
}

/* Layout Utilities */
.separator {
    height: 1px;
    background: var(--border-light);
    margin: 24px 0;
}

.flex-row {
    display: flex;
    gap: 16px;
}

.flex-row>* {
    flex: 1;
}

/* Interactive Elements */
.tab-toggle {
    background: #f1f5f9;
    padding: 4px;
    border-radius: var(--radius-lg);
    display: inline-flex;
    gap: 2px;
}

.toggle-btn {
    padding: 6px 16px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    background: transparent;
    border: none;
    cursor: pointer;
}

.toggle-btn.active {
    background: white;
    color: var(--primary);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* Accordion / Details */
details {
    margin-bottom: 12px;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: white;
}

summary {
    padding: 12px 16px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-main);
    background: #f9fafb;
    user-select: none;
    display: flex;
    align-items: center;
    list-style: none;
    /* Hide default triangle in some browsers */
}

summary::-webkit-details-marker {
    display: none;
}

summary::after {
    content: '+';
    margin-left: auto;
    font-size: 16px;
    color: var(--text-tertiary);
    font-weight: 300;
}

details[open] summary::after {
    content: '-';
}

details[open] summary {
    border-bottom: 1px solid var(--border-light);
}

/* Token Grid */
.token-grid {
    padding: 16px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
}

/* Preview Board */
#theme-preview-board {
    background: var(--bg-main);
    min-height: 200px;
    padding: 24px;
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    align-content: flex-start;
}

/* Token Highlighter */
.preview-highlight {
    outline: 2px solid #FF00FF !important;
    box-shadow: 0 0 15px rgba(255, 0, 255, 0.5) !important;
    position: relative;
    z-index: 10;

    transition: all 0.2s;
}

/* Editor Row Flash */
@keyframes flashRow {
    0% {
        background-color: rgba(24, 160, 251, 0.4);
        outline: 2px solid #18A0FB;
        transform: scale(1.02);
    }

    100% {
        background-color: #f9fafb;
        outline: none;
        transform: scale(1);
    }
}

.editor-flash {
    animation: flashRow 1.5s ease-out forwards !important;
    z-index: 100;
    position: relative;
    border-color: #18A0FB !important;
}
/* Custom Select Component Styles */
.custom-select {
    position: relative;
    flex: 1;
    font-size: 11px;
    user-select: none;
}

.custom-select-trigger {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 8px;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    cursor: pointer;
    transition: border-color 0.2s;
}

.custom-select-trigger:hover {
    border-color: #9ca3af;
}

.custom-select.open .custom-select-trigger {
    border-color: #18A0FB;
    box-shadow: 0 0 0 1px #18A0FB;
}

.custom-select .color-swatch {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 1px solid rgba(0, 0, 0, 0.1);
    flex-shrink: 0;
}

.custom-select .scale-value {
    flex: 1;
    font-family: monospace;
    font-size: 11px;
}

.custom-select .dropdown-arrow {
    font-size: 8px;
    color: #6b7280;
    transition: transform 0.2s;
}

.custom-select.open .dropdown-arrow {
    transform: rotate(180deg);
}

.custom-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin-top: 2px;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.custom-select.open .custom-options {
    display: block;
}

.custom-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    cursor: pointer;
    transition: background-color 0.15s;
}

.custom-option:hover {
    background-color: #f3f4f6;
}

.custom-option.selected {
    background-color: #eff6ff;
    color: #1e40af;
    font-weight: 500;
}

.custom-option .color-swatch {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 1px solid rgba(0, 0, 0, 0.1);
    flex-shrink: 0;
}

.custom-option .scale-value {
    font-family: monospace;
    font-size: 11px;
}

    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">PirulinoColorete</div>
            <div class="sidebar-subtitle">DESIGN ARCHITECT</div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item active" data-section="scale">
                <span class="nav-item-icon">üé®</span>
                <span class="nav-item-label">Colors</span>
            </div>
            <div class="nav-item" data-section="measures">
                <span class="nav-item-icon">üìè</span>
                <span class="nav-item-label">Measures</span>
            </div>
            <div class="nav-item" data-section="typography">
                <span class="nav-item-icon">‚úçÔ∏è</span>
                <span class="nav-item-label">Typography</span>
            </div>
            <div class="nav-item" data-section="aliases">
                <span class="nav-item-icon">üîó</span>
                <span class="nav-item-label">Aliases</span>
            </div>
            <div class="nav-item" data-section="theme">
                <span class="nav-item-icon">üåì</span>
                <span class="nav-item-label">Theme</span>
            </div>
            <div class="nav-item" data-section="collections">
                <span class="nav-item-icon">üìö</span>
                <span class="nav-item-label">Documentation</span>
            </div>
        </nav>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="content-header">
            <h1 id="page-title">Color Palettes</h1>
            <p id="page-description">Generate color scales for your design system.</p>
        </div>
        <div class="content-body">
            <div class="content-container">
                <!-- Sections -->
<div id="section-scale" class="section-content active">
    <h2>Color Palettes</h2>
    <p class="description">Generate color scales for your design system.</p>

    <!-- Step 1: Collection -->
    <div class="section-title">1. Collection</div>
    <div class="input-group">
        <label>Target Collection</label>
        <select id="var-collection-select">
            <option value="" disabled selected>Select Collection...</option>
            <option value="NEW_COLLECTION">+ Create New Collection...</option>
        </select>
    </div>
    <input type="text" id="var-collection-custom" placeholder="Enter new collection name"
        style="display: none; width: 100%; padding: 10px 12px; border-radius: 8px; border: 1.5px solid #3b82f6; font-size: 14px; margin-top: 8px; margin-bottom: 16px; background: #eff6ff; transition: all 0.2s ease;">

    <!-- Step 2: Group -->
    <div class="section-title">2. Group (Optional)</div>
    <div class="input-group">
        <label>Target Group</label>
        <select id="var-group-select">
            <option value="">(Root / No Group)</option>
            <option value="NEW_GROUP">+ New Group...</option>
        </select>
    </div>
    <input type="text" id="var-group-custom" placeholder="Enter new group name"
        style="display: none; width: 100%; padding: 10px 12px; border-radius: 8px; border: 1.5px solid #3b82f6; font-size: 14px; margin-top: 8px; margin-bottom: 24px; background: #eff6ff; transition: all 0.2s ease;">

    <div class="separator"></div>

    <!-- Step 3: Add Colors -->
    <div class="section-title">3. Add Colors</div>
    <div
        style="margin-bottom: 20px; background: white; padding: 16px; border-radius: 8px; border: 1.5px solid #e5e7eb;">
        <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 12px; color: #374151;">Add New
            Color</label>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
            <div>
                <input type="text" id="new-color-name" placeholder="Name (e.g. Primary)"
                    style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1.5px solid #d1d5db; font-size: 14px;">
            </div>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="new-color-hex" placeholder="#Hex"
                    style="flex: 1; padding: 10px 12px; border-radius: 8px; border: 1.5px solid #d1d5db; font-family: monospace; font-size: 14px;">
                <div id="new-color-swatch"
                    style="width: 40px; height: 40px; border-radius: 8px; background: #f3f4f6; border: 1.5px solid #d1d5db;">
                </div>
            </div>
        </div>

        <button id="add-color-btn" class="secondary" style="width: 100%;">+ Add to Queue</button>
        <p id="add-error" style="color: #dc2626; font-size: 12px; margin-top: 8px; display: none;">Invalid Input</p>
    </div>

    <!-- Color Queue List -->
    <div id="color-queue-container" style="margin-bottom: 24px;">
        <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 8px; color: #444;">Colors to
            Generate (<span id="queue-count">0</span>)</label>
        <div id="color-queue"
            style="display: flex; flex-direction: column; gap: 8px; min-height: 40px; margin-bottom: 12px;">
            <p id="empty-queue-msg" style="font-size: 11px; color: #999; font-style: italic;">No colors added yet.</p>
        </div>
        <button id="preview-scale-btn" class="primary" disabled style="width: 100%;">Preview
            Palettes</button>
    </div>

    <!-- Preview Section -->
    <div id="scale-preview-container" style="display: none; border-top: 1px solid #eee; padding-top: 20px;">
        <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 12px; color: #444;">Palettes
            Preview</label>
        <div id="scale-list" style="display: flex; flex-direction: column; gap: 24px; margin-bottom: 24px;"></div>
        <button id="create-vars-btn" class="primary" style="width: 100%;">Create All Variables</button>
    </div>
</div>
<div id="section-measures" class="section-content">
    <h2>Measure Generator</h2>
    <div style="margin-bottom: 20px;">
        <div style="margin-bottom: 12px;">
            <label style="display: block; font-size: 11px; font-weight: 500; margin-bottom: 4px; color: #444;">Values
                (comma separated)</label>
            <textarea id="measure-values"
                style="width: 100%; height: 80px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-family: monospace; font-size: 12px; resize: vertical;">0.5, 1, 2, 4, 8, 12, 16, 20, 24, 32, 40, 48, 64, 80, 96</textarea>
            <p style="font-size: 10px; color: #888; margin-top: 4px;">Standard scale. Edit to customize.</p>
        </div>
        <button id="preview-measures-btn" class="secondary" style="margin-bottom: 20px;">Preview
            Measures</button>
    </div>

    <!-- Preview Section -->
    <div id="measure-preview-container" style="display: none; border-top: 1px solid #eee; padding-top: 20px;">
        <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 12px; color: #444;">2.
            Preview</label>
        <div id="measure-list"
            style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; max-height: 150px; overflow-y: auto; padding-right: 4px;">
        </div>

        <!-- Configuration Form -->
        <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 12px; color: #444;">3.
            Configuration</label>

        <div style="margin-bottom: 12px;">
            <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Target Collection</label>
            <select id="measure-collection-select"
                style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                <option value="" disabled selected>Select Collection...</option>
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Target Group
                (Parent)</label>
            <select id="measure-group-select"
                style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                <option value="">(Root / No Group)</option>
                <option value="NEW_GROUP">+ New Group...</option>
            </select>
            <input type="text" id="measure-group-custom" placeholder="e.g. Spacing"
                style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px; margin-top: 8px; display: none;">
        </div>

        <button id="create-measures-btn" style="background-color: #18A0FB;">Create Variables</button>
    </div>
</div>
<div id="section-typography" class="section-content">
    <h2>Typography System</h2>

    <!-- Section 1: Fonts -->
    <div style="margin-bottom: 24px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
        <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 12px; color: #333;">1. Font
            Families</label>

        <div style="margin-bottom: 12px;">
            <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Heading Font</label>
            <select id="font-heading" class="font-select"
                style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                <option value="" disabled selected>Loading fonts...</option>
            </select>
        </div>
        <div style="margin-bottom: 12px;">
            <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Body Font</label>
            <select id="font-body" class="font-select"
                style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                <option value="" disabled selected>Loading fonts...</option>
            </select>
        </div>
        <div style="margin-bottom: 12px;">
            <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Code/Mono Font</label>
            <select id="font-code" class="font-select"
                style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                <option value="" disabled selected>Loading fonts...</option>
            </select>
        </div>
    </div>

    <!-- Section 2: Scale Lists -->
    <div style="margin-bottom: 24px;">
        <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 12px; color: #333;">2.
            Scales</label>

        <div style="margin-bottom: 16px;">
            <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Font Weights
                (Numeric)</label>
            <textarea id="typo-weights"
                style="width: 100%; height: 50px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-family: monospace; font-size: 12px; resize: vertical;">100, 200, 300, 400, 500, 600, 700, 800, 900</textarea>
        </div>

        <div style="margin-bottom: 16px;">
            <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Letter Spacing (%)</label>
            <textarea id="typo-spacing"
                style="width: 100%; height: 50px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-family: monospace; font-size: 12px; resize: vertical;">-2, -1, 0, 1, 2, 4, 8, 10</textarea>
        </div>

        <div style="margin-bottom: 16px;">
            <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Font Sizes (px)</label>
            <textarea id="typo-sizes"
                style="width: 100%; height: 50px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-family: monospace; font-size: 12px; resize: vertical;">8, 10, 12, 14, 16, 18, 20, 24, 30, 36, 48, 60, 72</textarea>
            <p style="font-size: 10px; color: #888; margin-top: 4px;">Will define generic sizes (3xs, 2xs, xs, sm, base,
                lg...).</p>
        </div>
    </div>

    <!-- Configuration -->
    <div style="border-top: 1px solid #eee; padding-top: 20px;">
        <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 12px; color: #333;">3.
            Target</label>

        <div style="margin-bottom: 12px;">
            <select id="typo-collection-select"
                style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                <option value="" disabled selected>Select Collection...</option>
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <select id="typo-group-select"
                style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                <option value="">(Root / No Group)</option>
                <option value="NEW_GROUP">+ New Group...</option>
            </select>
            <input type="text" id="typo-group-custom" placeholder="e.g. Typography" value="Typography"
                style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px; margin-top: 8px; display: none;">
        </div>

        <button id="create-typo-btn" style="background-color: #18A0FB;">Create Typography Variables</button>
    </div>
</div>
<div id="section-aliases" class="section-content">
    <div class="section-title">Responsive Semantics üì±üíª</div>
    <p class="description">Generate semantic tokens (H1, Body, Spacers) that adapt to viewport size using Variable
        Modes.</p>

    <!-- Source Config -->
    <div style="margin-bottom: 24px; background: #f9f9f9; padding: 12px; border-radius: 6px; border: 1px solid #eee;">
        <label style="display: block; font-size: 11px; font-weight: 600; margin-bottom: 12px; color: #555;">1. Source
            Primitives</label>

        <!-- Collection Selection -->
        <div style="margin-bottom: 12px;">
            <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">Collection with
                Primitives</label>
            <select id="alias-source-collection"
                style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;">
                <option value="" disabled selected>Select Collection...</option>
            </select>
        </div>

        <!-- Measures Group -->
        <div style="margin-bottom: 12px;">
            <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">Measures Group (e.g.
                Primitives)</label>
            <select id="alias-measures-group"
                style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;"
                disabled>
                <option value="">(Loading...)</option>
            </select>
        </div>

        <!-- Typography Group -->
        <div style="margin-bottom: 8px;">
            <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">Typography Group</label>
            <select id="alias-typo-group"
                style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;"
                disabled>
                <option value="">(Loading...)</option>
            </select>
        </div>
    </div>

    <!-- Target Config -->
    <div class="input-group">
        <label>Target Collection Name</label>
        <input type="text" id="alias-target-name" value="Tokens" placeholder="e.g. Tokens">
    </div>

    <button id="create-aliases-btn" class="primary">Generate Responsive Tokens</button>

    <div class="separator"></div>

    <div class="section-title">Step 2: Text Styles (Atomic Matrix)</div>
    <p class="description">Creates Figma Text Styles (e.g. "H1 / Bold", "H1 / Light") derived from your responsive
        tokens.</p>
    <button id="create-styles-btn" class="secondary" disabled>Generate Text Styles</button>
</div>
<div class="section-content" id="section-theme">
    <div class="header-actions" style="margin-bottom: 24px;">
        <div class="tab-toggle"
            style="background: #f3f4f6; padding: 4px; border-radius: 6px; display: flex; width: 100%;">
            <button id="mode-generate" class="toggle-btn active"
                style="flex: 1; padding: 8px; border: none; background: white; border-radius: 4px; font-size: 13px; font-weight: 500; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">Generate
                New</button>
            <button id="mode-edit" class="toggle-btn"
                style="flex: 1; padding: 8px; border: none; background: transparent; font-size: 13px; font-weight: 500; color: #666;">Edit
                Existing</button>
        </div>
    </div>

    <!-- Mode: Generate -->
    <div id="theme-mode-generate">
        <!-- Step 1: Source -->
        <div class="form-section">
            <h3>Step 1: Source Collection</h3>
            <p class="section-description">Select where your color palettes are stored</p>

            <div class="form-group">
                <label>Collection</label>
                <div class="select-wrapper">
                    <select id="theme-source-collection">
                        <option value="" disabled selected>Select collection...</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Group (Optional)</label>
                <div class="select-wrapper">
                    <select id="theme-source-group" disabled>
                        <option value="">All groups</option>
                    </select>
                </div>
            </div>

            <button id="load-palettes-btn" class="btn btn-secondary" style="width: 100%;">Load Palettes</button>
        </div>
    </div>

    <!-- Mode: Edit (New) -->
    <div id="theme-mode-edit" style="display: none;">
        <div class="form-section">
            <h3>Select Theme Collection</h3>
            <p class="section-description">Choose an existing theme collection to edit</p>

            <div class="form-group">
                <label>Theme Collection</label>
                <div class="select-wrapper">
                    <select id="theme-edit-collection">
                        <option value="" disabled selected>Select theme...</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Theme Group (Optional)</label>
                <div class="select-wrapper">
                    <select id="theme-edit-group" disabled>
                        <option value="">(Root)</option>
                    </select>
                </div>
            </div>

            <button id="load-existing-theme-btn" class="btn btn-primary" style="width: 100%;">Load Theme Tokens</button>
        </div>
    </div>

    <!-- Step 2: Configuration -->
    <div class="form-section">
        <h3>Step 2: Semantic Mapping</h3>
        <p class="section-description">Map your palettes to semantic roles</p>

        <div class="flex-row">
            <div class="form-group">
                <label>Accent / Brand</label>
                <div class="select-wrapper">
                    <select id="theme-accent-palette" disabled></select>
                </div>
            </div>
            <div class="form-group">
                <label>Neutral / Surface</label>
                <div class="select-wrapper">
                    <select id="theme-neutral-palette" disabled></select>
                </div>
            </div>
        </div>

        <div class="separator"></div>
        <label class="sub-label">Status Palettes (Optional)</label>

        <div class="flex-row">
            <div class="form-group">
                <label>Success</label>
                <div class="select-wrapper">
                    <select id="theme-success-palette" disabled></select>
                </div>
            </div>
            <div class="form-group">
                <label>Warning</label>
                <div class="select-wrapper">
                    <select id="theme-warning-palette" disabled></select>
                </div>
            </div>
            <div class="form-group">
                <label>Error</label>
                <div class="select-wrapper">
                    <select id="theme-error-palette" disabled></select>
                </div>
            </div>
        </div>

        <div class="form-group" style="margin-top: 16px;">
            <label>Theme Name</label>
            <input type="text" id="theme-name" class="input-text" value="Theme" placeholder="e.g. My Product Theme">
        </div>

        <button id="generate-theme-btn" class="btn btn-primary" style="width: 100%;" disabled>Generate Theme</button>
    </div>

    <!-- Step 3: Editor & Preview (Hidden initially) -->
    <div id="theme-preview-section"
        style="display: none; margin-top: 32px; border-top: 1px solid #eee; padding-top: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3>Theme Editor</h3>
            <div class="tab-toggle" style="background: #f3f4f6; padding: 4px; border-radius: 6px; display: flex;">
                <button id="view-light" class="toggle-btn active"
                    style="padding: 4px 12px; border: none; background: white; border-radius: 4px; font-size: 12px; font-weight: 500; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">Light</button>
                <button id="view-dark" class="toggle-btn"
                    style="padding: 4px 12px; border: none; background: transparent; font-size: 12px; font-weight: 500; color: #666;">Dark</button>
            </div>
        </div>

        <!-- Live Preview Board -->
        <div id="theme-preview-board"
            style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; margin-bottom: 24px; transition: all 0.3s ease;">
            <!-- Rendered via JS based on tokens -->
        </div>

        <!-- Token Editor Accordion -->
        <div class="editor-accordion">
            <details open>
                <summary>Background & Surface</summary>
                <div class="token-grid" id="editor-bg"></div>
            </details>
            <details>
                <summary>Text & Content</summary>
                <div class="token-grid" id="editor-text"></div>
            </details>
            <details>
                <summary>Actions & Buttons</summary>
                <div class="token-grid" id="editor-action"></div>
            </details>
            <details>
                <summary>Borders & Dividers</summary>
                <div class="token-grid" id="editor-border"></div>
            </details>
            <details>
                <summary>Status & Feedback</summary>
                <div class="token-grid" id="editor-status"></div>
            </details>
        </div>

        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #eee;">
            <button id="create-theme-btn" class="btn btn-primary big-btn" style="width: 100%; padding: 12px;">Create
                Variables Collection</button>
        </div>
    </div>
</div>
<div id="section-collections" class="section-content">
    <h2>Select Collection</h2>
    <select id="collection-select">
        <option value="" disabled selected>Loading collections...</option>
    </select>

    <h2>Select Group (Optional)</h2>
    <select id="group-select" disabled>
        <option value="">All Groups</option>
    </select>

    <div style="display: flex; gap: 8px;">
        <button id="convert-btn" class="secondary" style="flex: 1;">List in UI</button>
        <button id="generate-btn" class="primary" style="flex: 1;">Generate on Canvas</button>
    </div>

    <div id="result"
        style="margin-top: 24px; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); min-height: 100px;">
        <p style="color: #888; text-align: center; margin-top: 30px;">Select a collection to see colors.</p>
    </div>
</div>

            </div>
        </div>
    </div>

    <script>
/* --- common.js --- */
// Global State
let currentThemeData = null;
let paletteCache = {}; // Start empty, filled by theme-generated
let tokenOverrides = {}; // { 'Status/error': { light: '50', dark: '900' } }

// Backend Messages Handler
window.onmessage = (event) => {
    const { type, payload } = event.data.pluginMessage;

    // Dispatch custom event so modules can listen to specific messages
    // This allows decoupling the switch statement
    const customEvent = new CustomEvent('plugin-message', { detail: { type, payload } });
    window.dispatchEvent(customEvent);

    // Common handlers
    if (type === 'show-progress') {
        const overlay = document.getElementById('progress-overlay');
        if (overlay) {
            overlay.style.display = 'flex';
            document.getElementById('progress-message').textContent = payload.message;
        }
    } else if (type === 'hide-progress') {
        const overlay = document.getElementById('progress-overlay');
        if (overlay) overlay.style.display = 'none';

    } else if (type === 'notify') {
        // Display a temporary notification
        showNotification(payload.message, payload.status);
    }
};

// Helper: Show Notification
function showNotification(message, status = 'info') {
    let notification = document.getElementById('notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        notification.style.cssText = `
            display: none;
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            background: #333;
            color: white;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        `;
        document.body.appendChild(notification);
    }

    notification.textContent = message;

    // Style based on status
    if (status === 'error') notification.style.background = '#ef4444';
    else if (status === 'success') notification.style.background = '#10b981';
    else notification.style.background = '#333';

    notification.style.display = 'block';
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Add Progress Overlay HTML if not present
document.addEventListener('DOMContentLoaded', () => {
    if (!document.getElementById('progress-overlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'progress-overlay';
        overlay.style.cssText = `
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        `;
        overlay.innerHTML = `
            <div class="spinner" style="
                width: 40px; 
                height: 40px; 
                border: 4px solid #f3f3f3; 
                border-top: 4px solid #3498db; 
                border-radius: 50%; 
                animation: spin 1s linear infinite;"></div>
            <div id="progress-message" style="margin-top: 16px; font-weight: 600; color: #333;">Processing...</div>
            <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
        `;
        document.body.appendChild(overlay);
    }
});

// Custom Resize Handle Logic
document.addEventListener('DOMContentLoaded', () => {
    // Check if handle already exists
    if (document.getElementById('resize-handle')) return;

    // Inject resize handle
    const handle = document.createElement('div');
    handle.id = 'resize-handle';
    handle.style.cssText = 'position: fixed; bottom: 0; right: 0; width: 16px; height: 16px; cursor: nwse-resize; z-index: 10000;';

    // Add visual indicator (triangle) using SVG
    handle.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 8L8 14M14 4L4 14" stroke="#94a3b8" stroke-width="2" stroke-linecap="round"/></svg>`;

    document.body.appendChild(handle);

    let isResizing = false;

    handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        e.preventDefault(); // Prevent text selection

        // Notify parent we are starting resize? (Optional)
        window.addEventListener('mousemove', handleMouseMove);
        window.addEventListener('mouseup', handleMouseUp);
    });

    function handleMouseMove(e) {
        if (!isResizing) return;

        // Calculate new size based on mouse position
        const newWidth = Math.max(300, e.clientX); // Min width 300
        const newHeight = Math.max(300, e.clientY); // Min height 300

        // Send message to code.js
        parent.postMessage({
            pluginMessage: { type: 'resize-window', width: newWidth, height: newHeight }
        }, '*');
    }

    function handleMouseUp() {
        isResizing = false;
        window.removeEventListener('mousemove', handleMouseMove);
        window.removeEventListener('mouseup', handleMouseUp);
    }
});


/* --- colors.js --- */
// Colors Section Logic
console.log('üé® Colors script loaded');

function initColors() {
    console.log('üé® Initializing Colors section...');

    // UI Elements
    const collectionSelect = document.getElementById('var-collection-select');
    const customCollectionInput = document.getElementById('var-collection-custom');
    const groupSelect = document.getElementById('var-group-select');
    const customGroupInput = document.getElementById('var-group-custom');
    const newColorName = document.getElementById('new-color-name');
    const newColorHex = document.getElementById('new-color-hex');
    const newColorSwatch = document.getElementById('new-color-swatch');
    const addColorBtn = document.getElementById('add-color-btn');
    const addError = document.getElementById('add-error');
    const colorQueueDiv = document.getElementById('color-queue');
    const queueCountSpan = document.getElementById('queue-count');
    const previewScaleBtn = document.getElementById('preview-scale-btn');
    const scalePreviewContainer = document.getElementById('scale-preview-container');
    const scaleList = document.getElementById('scale-list');
    const createVarsBtn = document.getElementById('create-vars-btn');

    if (!addColorBtn) {
        console.error('‚ùå Critical Error: add-color-btn not found. DOM might not be ready.');
        return;
    }

    // Initial Load
    console.log('üì® Requesting collections...');
    parent.postMessage({ pluginMessage: { type: 'load-collections' } }, '*');

    // State
    let colorQueue = [];

    // Message Listener
    window.addEventListener('plugin-message', (event) => {
        const { type, payload } = event.detail;
        console.log(`üé® Colors received message: ${type}`, payload);

        if (type === 'load-collections') {
            // Populate Collection Select
            // Reset but keep first 2 options
            while (collectionSelect.options.length > 2) {
                collectionSelect.remove(2);
            }

            payload.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                collectionSelect.appendChild(option);
            });
            console.log(`‚úÖ Loaded ${payload.length} collections into dropdown`);

        } else if (type === 'load-groups-tab1') {
            // Populate Group Select
            groupSelect.innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';
            payload.forEach(g => {
                const option = document.createElement('option');
                option.value = g;
                option.textContent = g;
                groupSelect.appendChild(option);
            });
            groupSelect.disabled = false;

        } else if (type === 'preview-scale-batch-result') {
            // Render Previews
            scaleList.innerHTML = '';

            payload.forEach(item => {
                const row = document.createElement('div');
                row.style.marginBottom = '24px';

                const title = document.createElement('div');
                title.style.fontWeight = '600';
                title.style.marginBottom = '8px';
                title.style.fontSize = '13px';
                title.textContent = item.name;
                row.appendChild(title);

                const swatches = document.createElement('div');
                swatches.style.display = 'flex';
                swatches.style.borderRadius = '8px';
                swatches.style.overflow = 'hidden';
                swatches.style.height = '40px';

                // Sort keys: 50, 100, ... 950
                const steps = Object.keys(item.steps).sort((a, b) => parseInt(a) - parseInt(b));

                steps.forEach(step => {
                    const data = item.steps[step];
                    const hex = data.hex;
                    const isDark = (step >= 500); // Simple heuristic for text color

                    const chip = document.createElement('div');
                    chip.style.flex = '1';
                    chip.style.backgroundColor = hex;
                    chip.style.display = 'flex';
                    chip.style.alignItems = 'center';
                    chip.style.justifyContent = 'center';
                    chip.style.color = isDark ? 'white' : 'black';
                    chip.style.fontSize = '10px';
                    chip.innerText = step;

                    swatches.appendChild(chip);
                });

                row.appendChild(swatches);
                scaleList.appendChild(row);
            });

            scalePreviewContainer.style.display = 'block';
            createVarsBtn.disabled = false;

        } else if (type === 'variables-created-success') {
            colorQueue = [];
            updateQueueUI();
            scalePreviewContainer.style.display = 'none';
        }
    });

    // Event Handlers

    // Collection Select Change
    collectionSelect.onchange = () => {
        const val = collectionSelect.value;
        if (val === 'NEW_COLLECTION') {
            customCollectionInput.style.display = 'block';
            // Enable group selection so user can create a group in the new collection
            groupSelect.disabled = false;
            // Reset to default options: Root and New Group
            groupSelect.innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';
        } else {
            customCollectionInput.style.display = 'none';
            // Load groups for this collection
            parent.postMessage({ pluginMessage: { type: 'get-groups-for-tab1', collectionId: val } }, '*');
        }
    };

    // Group Select Change
    groupSelect.onchange = () => {
        if (groupSelect.value === 'NEW_GROUP') {
            customGroupInput.style.display = 'block';
        } else {
            customGroupInput.style.display = 'none';
        }
    };

    // Hex/Color Input Preview (Supports Hex, RGB, HSL, OKLCH, etc.)
    newColorHex.oninput = () => {
        const val = newColorHex.value.trim();
        // Try to set the background color. If it's valid CSS, the browser will apply it.
        if (val) {
            newColorSwatch.style.backgroundColor = val;
            // Check if it worked (simple validation hack)
            // Note: This isn't perfect but allows flexibility
        } else {
            newColorSwatch.style.backgroundColor = '#f3f4f6';
        }
    };

    // Add to Queue
    addColorBtn.onclick = () => {
        console.log('‚ûï Add Color Button Clicked');
        const name = newColorName.value.trim();
        const colorVal = newColorHex.value.trim();

        // Validation: Just check if not empty. Let CSS/Backend handle exact validity.
        if (!name || !colorVal) {
            addError.style.display = 'block';
            addError.textContent = 'Name and Value are required';
            console.warn('‚ö†Ô∏è Empty input');
            return;
        }
        addError.style.display = 'none';

        colorQueue.push({ name, hex: colorVal, id: Date.now() }); // We use 'hex' key but it can store any string
        updateQueueUI();

        // Clear inputs
        newColorName.value = '';
        newColorHex.value = '';
        newColorSwatch.style.backgroundColor = '#f3f4f6';
        newColorName.focus(); // Focus back to name for fast entry
    };

    function updateQueueUI() {
        queueCountSpan.textContent = colorQueue.length;
        colorQueueDiv.innerHTML = '';

        if (colorQueue.length === 0) {
            colorQueueDiv.innerHTML = '<p id="empty-queue-msg" style="font-size: 11px; color: #999; font-style: italic;">No colors added yet.</p>';
            previewScaleBtn.disabled = true;
            return;
        }

        previewScaleBtn.disabled = false;

        colorQueue.forEach((item, index) => {
            const el = document.createElement('div');
            el.className = 'color-item'; // Defined in CSS
            // Basic styles for queue item just in case CSS missed it
            el.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 8px; background: white; border: 1px solid #eee; border-radius: 4px; margin-bottom: 4px;';

            el.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="color-preview" style="width: 24px; height: 24px; border-radius: 4px; background-color: ${item.hex}; border: 1px solid rgba(0,0,0,0.1);"></div>
                    <div class="color-info">
                        <div class="color-name" style="font-size: 12px; font-weight: 500;">${item.name}</div>
                        <div class="color-value" style="font-size: 10px; color: #666; font-family: monospace;">${item.hex}</div>
                    </div>
                </div>
                <button class="remove-btn" data-index="${index}" style="width: 24px; height: 24px; padding: 0; background: transparent; color: #999; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px;">‚úï</button>
            `;
            colorQueueDiv.appendChild(el);
        });

        // Add remove listeners
        document.querySelectorAll('.remove-btn').forEach(btn => {
            btn.onclick = (e) => {
                const idx = parseInt(e.currentTarget.dataset.index); // Use currentTarget to ensure we get the button
                colorQueue.splice(idx, 1);
                updateQueueUI();
            };
        });
    }

    // Preview
    previewScaleBtn.onclick = () => {
        console.log('üëÅÔ∏è Preview Scale Clicked', colorQueue);
        parent.postMessage({ pluginMessage: { type: 'preview-scale-batch', colors: colorQueue } }, '*');
    };

    // Create Variables
    createVarsBtn.onclick = () => {
        console.log('üöÄ Create Variables Clicked');
        if (colorQueue.length === 0) return;

        let collectionId = collectionSelect.value;
        let collectionName = null;
        if (collectionId === 'NEW_COLLECTION') {
            collectionName = customCollectionInput.value.trim();
            if (!collectionName) {
                alert('Please enter a collection name');
                return;
            }
            collectionId = null; // Backend handles creation
        }

        let groupName = groupSelect.value;
        if (groupName === 'NEW_GROUP') {
            groupName = customGroupInput.value.trim();
        } else if (groupName === '') {
            groupName = null; // Root
        }

        const config = {
            collectionId,
            collectionName,
            groupName
        };

        parent.postMessage({
            pluginMessage: {
                type: 'create-variables-batch',
                colors: colorQueue,
                config
            }
        }, '*');
    };
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initColors);
} else {
    initColors();
}


/* --- measures.js --- */
// Measures Section Logic
console.log('üìè Measures script loaded');

function initMeasures() {
    console.log('üìè Initializing Measures section...');

    // UI Elements
    const measureValues = document.getElementById('measure-values');
    const previewBtn = document.getElementById('preview-measures-btn');
    const measurePreviewContainer = document.getElementById('measure-preview-container');
    const measureList = document.getElementById('measure-list');
    const collectionSelect = document.getElementById('measure-collection-select');
    const groupSelect = document.getElementById('measure-group-select');
    const customGroupInput = document.getElementById('measure-group-custom');
    const createBtn = document.getElementById('create-measures-btn');

    if (!collectionSelect) {
        console.error('‚ùå Critical: measure-collection-select not found in DOM!');
        return;
    }

    if (!createBtn) {
        console.warn('‚ö†Ô∏è Measures UI create-btn not found. Structure check required.');
    }

    // Message Listener
    window.addEventListener('plugin-message', (event) => {
        const { type, payload } = event.detail;

        if (type === 'load-collections') {
            console.log('üìè Measures received load-collections. Payload:', payload);

            if (!collectionSelect) {
                console.error('‚ùå measure-collection-select lost reference!');
                return;
            }

            try {
                // Populate Collection Select
                const currentVal = collectionSelect.value;
                collectionSelect.innerHTML = '<option value="" disabled selected>Select Collection...</option>';

                if (payload && Array.isArray(payload)) {
                    payload.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        collectionSelect.appendChild(option);
                    });
                    console.log(`‚úÖ Measures: Populated ${payload.length} collections.`);

                    // Restore selection if valid
                    if (currentVal && payload.find(c => c.id === currentVal)) {
                        collectionSelect.value = currentVal;
                    }
                } else {
                    console.warn('‚ö†Ô∏è Payload is not an array:', payload);
                }
            } catch (err) {
                console.error('‚ùå Error populating measure collections:', err);
            }

        } else if (type === 'load-groups-measures') {
            console.log('üìè Measures: Loaded groups', payload);
            groupSelect.innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';
            payload.forEach(g => {
                const option = document.createElement('option');
                option.value = g;
                option.textContent = g;
                groupSelect.appendChild(option);
            });
            groupSelect.disabled = false;

        } else if (type === 'measures-created-success') {
            alert('Measures created successfully!');
            measurePreviewContainer.style.display = 'none';
        }
    });

    // UI Events
    previewBtn.onclick = () => {
        console.log('üìè Preview Measures Clicked');
        const raw = measureValues.value;
        const values = raw.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));

        if (values.length === 0) {
            alert('Please enter valid numbers (comma separated)');
            return;
        }

        // Render Preview
        measureList.innerHTML = '';
        values.forEach(v => {
            const chip = document.createElement('div');
            chip.style.cssText = `
                padding: 4px 8px;
                background: #f3f4f6;
                border-radius: 4px;
                border: 1px solid #e5e7eb;
                font-size: 12px;
                font-family: monospace;
                color: #374151;
            `;
            chip.textContent = `${v}px`;
            measureList.appendChild(chip);
        });

        measurePreviewContainer.style.display = 'block';

        // Always request collections to ensure freshness
        console.log('üìè Requesting collections refresh from preview...');
        parent.postMessage({ pluginMessage: { type: 'load-collections' } }, '*');
    };

    collectionSelect.onchange = () => {
        const val = collectionSelect.value;
        console.log('üìè Collection changed:', val);
        // Request groups
        parent.postMessage({ pluginMessage: { type: 'get-groups-for-measures', collectionId: val } }, '*');
    };

    if (createBtn) {
        createBtn.onclick = () => {
            if (!collectionSelect.value) {
                alert('Select a collection');
                return;
            }

            const raw = measureValues.value;
            const values = raw.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));

            let groupName = groupSelect.value;
            if (groupName === 'NEW_GROUP') {
                groupName = customGroupInput.value.trim();
            } else if (groupName === '') {
                groupName = null;
            }

            const config = {
                collectionId: collectionSelect.value,
                groupName
            };

            console.log('üìè Creating measures:', values, config);

            parent.postMessage({
                pluginMessage: {
                    type: 'create-measure-variables',
                    values,
                    config
                }
            }, '*');
        };
    }

    groupSelect.onchange = () => {
        if (groupSelect.value === 'NEW_GROUP') {
            customGroupInput.style.display = 'block';
        } else {
            customGroupInput.style.display = 'none';
        }
    };

    // Initial load request
    // This handles the case where navigation.js might have missed it or we reloaded the script context
    console.log('üìè Sending initial load-collections request from init.');
    parent.postMessage({ pluginMessage: { type: 'load-collections' } }, '*');
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMeasures);
} else {
    initMeasures();
}


/* --- typography.js --- */
// Typography Section Logic
console.log('‚úçÔ∏è Typography script loaded');

function initTypography() {
    console.log('‚úçÔ∏è Initializing Typography section...');

    // UI Elements
    const fontHeading = document.getElementById('font-heading');
    const fontBody = document.getElementById('font-body');
    const fontCode = document.getElementById('font-code');
    const typoWeights = document.getElementById('typo-weights');
    const typoSpacing = document.getElementById('typo-spacing');
    const typoSizes = document.getElementById('typo-sizes');
    const typoCollection = document.getElementById('typo-collection-select');
    const typoGroup = document.getElementById('typo-group-select');
    const typoGroupCustom = document.getElementById('typo-group-custom');
    const createBtn = document.getElementById('create-typo-btn');

    if (!createBtn) {
        console.warn('‚ö†Ô∏è Typography UI elements not found');
        return;
    }

    // Initial Load of Fonts
    console.log('‚úçÔ∏è Requesting font list...');
    parent.postMessage({ pluginMessage: { type: 'get-fonts' } }, '*');

    // Message Listener
    window.addEventListener('plugin-message', (event) => {
        const { type, payload } = event.detail;

        if (type === 'load-fonts') {
            const fonts = payload; // ['Inter', 'Roboto', ...]
            console.log('‚úçÔ∏è Fonts loaded:', fonts.length);
            const updateSelect = (sel) => {
                sel.innerHTML = '<option value="" disabled selected>Select Font...</option>';
                fonts.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f;
                    opt.textContent = f;
                    sel.appendChild(opt);
                });
            };

            updateSelect(fontHeading);
            updateSelect(fontBody);
            updateSelect(fontCode);

            // Set defaults if available
            if (fonts.includes('Inter')) {
                fontHeading.value = 'Inter';
                fontBody.value = 'Inter';
            }
            if (fonts.includes('Roboto Mono')) fontCode.value = 'Roboto Mono';

        } else if (type === 'load-collections') {
            typoCollection.innerHTML = '<option value="" disabled selected>Select Collection...</option>';
            payload.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                typoCollection.appendChild(opt);
            });
            console.log('‚úçÔ∏è Typography: Collections loaded');

        } else if (type === 'load-groups-typo') {
            console.log('‚úçÔ∏è Typography: Groups loaded');
            typoGroup.innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';
            payload.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = g;
                typoGroup.appendChild(opt);
            });
            typoGroup.disabled = false;
        }
    });

    // Events
    typoCollection.onchange = () => {
        console.log('‚úçÔ∏è Typography: Collection changed');
        parent.postMessage({ pluginMessage: { type: 'get-groups-for-typo', collectionId: typoCollection.value } }, '*');
    };

    typoGroup.onchange = () => {
        if (typoGroup.value === 'NEW_GROUP') {
            typoGroupCustom.style.display = 'block';
        } else {
            typoGroupCustom.style.display = 'none';
        }
    };

    createBtn.onclick = () => {
        if (!typoCollection.value) {
            alert('Select a collection');
            return;
        }

        const families = {
            heading: fontHeading.value,
            body: fontBody.value,
            code: fontCode.value
        };

        const parseList = (el) => el.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));

        const weights = parseList(typoWeights);
        const spacing = parseList(typoSpacing);
        const sizes = parseList(typoSizes);

        let groupName = typoGroup.value;
        if (groupName === 'NEW_GROUP') {
            groupName = typoGroupCustom.value.trim();
        } else if (groupName === '') {
            groupName = null;
        }

        const config = {
            collectionId: typoCollection.value,
            groupName
        };

        console.log('‚úçÔ∏è Creating typography...', config);

        parent.postMessage({
            pluginMessage: {
                type: 'create-typography',
                families,
                weights,
                spacing,
                sizes,
                config
            }
        }, '*');
    };
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTypography);
} else {
    initTypography();
}


/* --- aliases.js --- */
// Aliases (Responsive Semantics) Section Logic
console.log('üîó Aliases script loaded');

function initAliases() {
    console.log('üîó Initializing Aliases section...');

    // UI Elements
    const sourceCollection = document.getElementById('alias-source-collection');
    const measureGroup = document.getElementById('alias-measures-group');
    const typoGroup = document.getElementById('alias-typo-group');
    const targetNameInput = document.getElementById('alias-target-name');
    const createBtn = document.getElementById('create-aliases-btn');
    const createStylesBtn = document.getElementById('create-styles-btn');

    if (!createBtn) {
        console.warn('‚ö†Ô∏è Aliases UI elements not found');
        return;
    }

    // Message Listener
    window.addEventListener('plugin-message', (event) => {
        const { type, payload } = event.detail;

        if (type === 'load-collections') {
            sourceCollection.innerHTML = '<option value="" disabled selected>Select Collection...</option>';
            payload.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                sourceCollection.appendChild(opt);
            });
            console.log('üîó Aliases: Loaded collections');

        } else if (type === 'load-groups-alias') {
            const fill = (sel, label) => {
                sel.innerHTML = `<option value="" disabled selected>${label}</option>`;
                payload.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g;
                    opt.textContent = g;
                    sel.appendChild(opt);
                });
                sel.disabled = false;
            };

            fill(measureGroup, 'Select Measures Group...');
            fill(typoGroup, 'Select Typography Group...');
            console.log('üîó Aliases: Loaded groups');
        }
    });

    // Events
    sourceCollection.onchange = () => {
        console.log('üîó Aliases: Collection changed', sourceCollection.value);
        parent.postMessage({ pluginMessage: { type: 'get-groups-for-alias', collectionId: sourceCollection.value } }, '*');
    };

    createBtn.onclick = () => {
        if (!sourceCollection.value || !measureGroup.value || !typoGroup.value) {
            alert('Please select Source Collection, Measures Group and Typography Group');
            return;
        }

        const targetName = targetNameInput.value.trim() || 'Tokens';

        const config = {
            sourceCollectionId: sourceCollection.value,
            measureGroup: measureGroup.value,
            typoGroup: typoGroup.value,
            targetName: targetName
        };

        console.log('üîó Creating aliases with config:', config);

        parent.postMessage({
            pluginMessage: {
                type: 'create-aliases',
                config
            }
        }, '*');

        // Enable next step
        createStylesBtn.disabled = false;
    };

    createStylesBtn.onclick = () => {
        // Validation re-check because user might simply click this if enabled previously
        if (!sourceCollection.value || !typoGroup.value) {
            alert('Please select Source Collection and Typography Group (required for linking variables)');
            return;
        }

        const config = {
            sourceCollectionId: sourceCollection.value,
            measureGroup: measureGroup.value, // Passed for consistency though mostly typo needed
            typoGroup: typoGroup.value,
            targetName: targetNameInput.value.trim() || 'Tokens'
        };

        console.log('üîó Creating text styles with config:', config);

        parent.postMessage({
            pluginMessage: {
                type: 'create-text-styles',
                config
            }
        }, '*');
    };
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAliases);
} else {
    initAliases();
}


/* --- theme.js --- */
// Theme Generator Logic
console.log('üåì Theme script loaded');

function initTheme() {
    console.log('üåì Initializing Theme section...');

    // UI Elements
    const sourceCollection = document.getElementById('theme-source-collection');
    const sourceGroup = document.getElementById('theme-source-group');
    const loadBtn = document.getElementById('load-palettes-btn');

    // Selects
    const accentSelect = document.getElementById('theme-accent-palette');
    const neutralSelect = document.getElementById('theme-neutral-palette');
    const successSelect = document.getElementById('theme-success-palette');
    const warningSelect = document.getElementById('theme-warning-palette');
    const errorSelect = document.getElementById('theme-error-palette');

    // Main Actions
    const themeNameInput = document.getElementById('theme-name');
    const generateBtn = document.getElementById('generate-theme-btn');
    const createThemeBtn = document.getElementById('create-theme-btn');

    // Preview Sections
    const previewSection = document.getElementById('theme-preview-section');
    const previewBoard = document.getElementById('theme-preview-board');
    const viewLightBtn = document.getElementById('view-light');
    const viewDarkBtn = document.getElementById('view-dark');

    if (!loadBtn) {
        console.warn('‚ö†Ô∏è Theme UI elements not found');
        return;
    }

    // State
    let loadedPalettes = [];
    let generatedThemeData = null;
    let tokenOverrides = {}; // Store user overrides
    let currentPreviewMode = 'light'; // 'light' or 'dark'

    // Mode Elements
    const modeGenerateBtn = document.getElementById('mode-generate');
    const modeEditBtn = document.getElementById('mode-edit');
    const modeGenerateSection = document.getElementById('theme-mode-generate');
    const modeEditSection = document.getElementById('theme-mode-edit');
    const configSection = document.querySelector('.form-section:nth-of-type(3)'); // Step 2

    // Edit Elements
    const editCollectionSelect = document.getElementById('theme-edit-collection');
    const editGroupSelect = document.getElementById('theme-edit-group');
    const loadExistingBtn = document.getElementById('load-existing-theme-btn');

    // Message Listener
    window.addEventListener('plugin-message', (event) => {
        const { type, payload } = event.detail;

        if (type === 'load-collections') {
            sourceCollection.innerHTML = '<option value="" disabled selected>Select collection...</option>';
            editCollectionSelect.innerHTML = '<option value="" disabled selected>Select theme...</option>';

            payload.forEach(c => {
                // Populate both dropdowns
                const opt1 = document.createElement('option');
                opt1.value = c.id;
                opt1.textContent = c.name;
                sourceCollection.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = c.id;
                opt2.textContent = c.name;
                editCollectionSelect.appendChild(opt2);
            });
            console.log('üåì Theme: Collections loaded');

        } else if (type === 'load-groups-theme') {
            sourceGroup.innerHTML = '<option value="">All groups</option>';
            payload.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = g;
                sourceGroup.appendChild(opt);
            });
            console.log('üåì Theme: Groups loaded');
            sourceGroup.disabled = false;

        } else if (type === 'load-groups-theme-edit') { // For Edit Mode
            if (editGroupSelect) {
                editGroupSelect.innerHTML = '<option value="">All groups</option>';
                payload.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g;
                    opt.textContent = g;
                    editGroupSelect.appendChild(opt);
                });
                editGroupSelect.disabled = false;
            }

        } else if (type === 'load-palettes') {
            loadedPalettes = payload;

            const fill = (sel, placeholder) => {
                sel.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
                loadedPalettes.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    opt.textContent = p.name;
                    sel.appendChild(opt);
                });
                sel.disabled = false;
            };

            fill(accentSelect, 'Select accent palette...');
            fill(neutralSelect, 'Select neutral palette...');
            fill(successSelect, 'Select success palette...');
            fill(warningSelect, 'Select warning palette...');
            fill(errorSelect, 'Select error palette...');

            generateBtn.disabled = false;
            alert(`Loaded ${loadedPalettes.length} palettes!`);

        } else if (type === 'theme-generated' || type === 'theme-regenerated' || type === 'theme-loaded-for-edit') {
            generatedThemeData = payload;

            // Hide Step 2 if in Edit Mode? NO, we want to SHOW it now if we have config
            if (type === 'theme-loaded-for-edit') {
                generatedThemeData = payload; // Important: update global data

                // 1. Populate Dropdowns if availablePalettes sent
                if (payload.availablePalettes && payload.availablePalettes.length > 0) {
                    const palettes = payload.availablePalettes;
                    const fill = (sel, placeholder) => {
                        sel.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
                        palettes.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p.name;
                            opt.textContent = p.name;
                            sel.appendChild(opt);
                        });
                        sel.disabled = false;
                    };

                    fill(accentSelect, 'Select accent palette...');
                    fill(neutralSelect, 'Select neutral palette...');
                    fill(successSelect, 'Select success palette...');
                    fill(warningSelect, 'Select warning palette...');
                    fill(errorSelect, 'Select error palette...');
                }

                // 2. Select Detected Values
                if (payload.detectedConfig) {
                    const c = payload.detectedConfig;
                    if (c.accent && accentSelect) accentSelect.value = c.accent;
                    if (c.neutral && neutralSelect) neutralSelect.value = c.neutral;
                    if (c.status.success && successSelect) successSelect.value = c.status.success;
                    if (c.status.warning && warningSelect) warningSelect.value = c.status.warning;
                    if (c.status.error && errorSelect) errorSelect.value = c.status.error;
                }

                // 3. Show Config Section (Step 2)
                if (configSection) {
                    configSection.style.display = 'block';
                    // Update header to indicate editing?
                    const h3 = configSection.querySelector('h3');
                    if (h3) h3.textContent = 'Step 2: Re-Map Palettes (Edit Mode)';
                }

                if (previewSection) previewSection.style.display = 'block';
                if (payload.themeName && themeNameInput) themeNameInput.value = payload.themeName;
                if (createThemeBtn) createThemeBtn.textContent = 'Update Theme Collection'; // Rebrand button
                if (createThemeBtn) createThemeBtn.disabled = false;
                if (generateBtn) generateBtn.disabled = false; // Allow regeneration

            } else {
                if (previewSection) previewSection.style.display = 'block';
                if (createThemeBtn) createThemeBtn.disabled = false;
            }

            console.log('üåì Theme Data Ready:', payload);
            renderPreview();
            renderTokenEditor();
        }
    });

    // --- Mode Toggles ---
    const setMode = (mode) => {
        if (!modeGenerateBtn || !modeEditBtn) return;

        if (mode === 'generate') {
            modeGenerateBtn.classList.add('active');
            modeGenerateBtn.style.background = 'white';
            modeGenerateBtn.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
            modeEditBtn.classList.remove('active');
            modeEditBtn.style.background = 'transparent';
            modeEditBtn.style.boxShadow = 'none';

            if (modeGenerateSection) modeGenerateSection.style.display = 'block';
            if (modeEditSection) modeEditSection.style.display = 'none';
            if (configSection) configSection.style.display = 'block'; // Show Step 2
        } else {
            modeEditBtn.classList.add('active');
            modeEditBtn.style.background = 'white';
            modeEditBtn.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
            modeGenerateBtn.classList.remove('active');
            modeGenerateBtn.style.background = 'transparent';
            modeGenerateBtn.style.boxShadow = 'none';

            if (modeEditSection) modeEditSection.style.display = 'block';
            if (modeGenerateSection) modeGenerateSection.style.display = 'none';
            if (configSection) configSection.style.display = 'none'; // Hide Step 2
        }
    };

    modeGenerateBtn.onclick = () => setMode('generate');
    modeEditBtn.onclick = () => setMode('edit');

    // --- Events ---

    sourceCollection.onchange = () => {
        parent.postMessage({ pluginMessage: { type: 'get-groups-for-theme', collectionId: sourceCollection.value } }, '*');
    };

    // Edit Collection Change
    if (editCollectionSelect) {
        editCollectionSelect.onchange = () => {
            parent.postMessage({ pluginMessage: { type: 'get-groups-custom', collectionId: editCollectionSelect.value, returnType: 'load-groups-theme-edit' } }, '*');
        };
    }

    loadBtn.onclick = () => {
        if (!sourceCollection.value) {
            alert('Select a collection first');
            return;
        }
        loadBtn.textContent = 'Loading...';
        parent.postMessage({
            pluginMessage: {
                type: 'load-palettes',
                collectionId: sourceCollection.value,
                groupName: sourceGroup.value
            }
        }, '*');
        setTimeout(() => loadBtn.textContent = 'Load Palettes', 1500);
    };

    if (loadExistingBtn) {
        loadExistingBtn.onclick = () => {
            if (!editCollectionSelect.value) {
                alert('Select a theme collection to edit');
                return;
            }
            // Request to load theme data
            parent.postMessage({
                pluginMessage: {
                    type: 'load-existing-theme',
                    collectionId: editCollectionSelect.value,
                    groupName: editGroupSelect ? editGroupSelect.value : null
                }
            }, '*');
        };
    }

    // Live Preview / Regeneration Logic
    const triggerRegeneration = () => {
        if (!accentSelect.value || !neutralSelect.value) return;

        // Gather current overrides from the UI if any
        const currentOverrides = {};
        document.querySelectorAll('.token-override-select').forEach(sel => {
            const token = sel.dataset.token;
            const mode = sel.dataset.mode;
            const val = sel.value;
            if (val) {
                if (!currentOverrides[token]) currentOverrides[token] = {};
                currentOverrides[token][mode] = val;
            }
        });

        const msg = {
            type: 'generate-theme',
            accentPalette: accentSelect.value,
            neutralPalette: neutralSelect.value,
            statusPalettes: {
                success: successSelect.value,
                warning: warningSelect.value,
                error: errorSelect.value
            },
            themeName: themeNameInput.value.trim(),
            tokenOverrides: currentOverrides, // Send existing overrides so they aren't lost
            isRegenerate: true // Flag to tell backend this is a live update
        };

        console.log('üîÑ Auto-updating preview...', msg);
        parent.postMessage({ pluginMessage: msg }, '*');
    };

    // Attach listeners for Validated Live Preview
    [accentSelect, neutralSelect, successSelect, warningSelect, errorSelect].forEach(sel => {
        if (sel) sel.onchange = triggerRegeneration;
    });

    generateBtn.onclick = () => {
        if (!accentSelect.value || !neutralSelect.value) {
            alert('Accent and Neutral palettes are required');
            return;
        }
        triggerRegeneration();
    };

    createThemeBtn.onclick = () => {
        if (!generatedThemeData) return;
        parent.postMessage({
            pluginMessage: {
                type: 'create-theme',
                themeData: generatedThemeData
            }
        }, '*');
    };

    // Toggle Preview Mode
    viewLightBtn.onclick = () => {
        currentPreviewMode = 'light';
        viewLightBtn.className = 'toggle-btn active';
        viewLightBtn.style.background = 'white';
        viewLightBtn.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
        viewDarkBtn.className = 'toggle-btn';
        viewDarkBtn.style.background = 'transparent';
        viewDarkBtn.style.boxShadow = 'none';
        renderPreview();
    };

    viewDarkBtn.onclick = () => {
        currentPreviewMode = 'dark';
        viewDarkBtn.className = 'toggle-btn active';
        viewDarkBtn.style.background = 'white';
        viewDarkBtn.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
        viewLightBtn.className = 'toggle-btn';
        viewLightBtn.style.background = 'transparent';
        viewLightBtn.style.boxShadow = 'none';
        renderPreview();
    };

    // --- Render Logic ---

    function renderPreview() {
        if (!generatedThemeData || !generatedThemeData.preview) return;

        const p = generatedThemeData.preview[currentPreviewMode];
        const isDark = currentPreviewMode === 'dark';

        // Helper for consistent small styles
        const cardStyle = `background-color: ${p.surface.card}; border: 1px solid ${p.border.default}; border-radius: 8px; padding: 20px;box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);`;
        const labelStyle = `display: block; font-size: 11px; font-weight: 600; margin-bottom: 6px; color: ${p.text.secondary}; letter-spacing: 0.025em; text-transform: uppercase;`;

        previewBoard.innerHTML = `
            <div data-tokens="Background/primary Text/primary" style="background-color: ${p.bg.primary}; color: ${p.text.primary}; padding: 32px; transition: background 0.3s; font-family: 'Inter', sans-serif; min-height: 480px;">
                
                <!-- Navbar -->
                <nav data-tokens="Border/subtle Text/brand Text/primary Text/secondary" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 40px; padding-bottom: 16px; border-bottom: 1px solid ${p.border.subtle || p.border.default};">
                    <div data-tokens="Text/brand" style="font-weight: 700; font-size: 18px; color: ${p.text.brand || p.text.primary}; letter-spacing: -0.02em;">Acme Inc.</div>
                    <div style="display: flex; gap: 24px; font-size: 14px;">
                        <span data-tokens="Text/primary" style="color: ${p.text.primary}; font-weight: 500;">Dashboard</span>
                        <span data-tokens="Text/secondary" style="color: ${p.text.secondary};">Team</span>
                        <span data-tokens="Text/secondary" style="color: ${p.text.secondary};">Projects</span>
                    </div>
                </nav>

                <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; max-width: 900px; margin: 0 auto;">
                    
                    <!-- Main Content Column -->
                    <div style="display: flex; flex-direction: column; gap: 24px;">
                        
                        <!-- Header -->
                        <div>
                            <h1 data-tokens="Text/primary" style="font-size: 24px; font-weight: 700; color: ${p.text.primary}; margin: 0 0 8px 0;">Settings</h1>
                            <p data-tokens="Text/secondary" style="color: ${p.text.secondary}; margin: 0; font-size: 14px;">Manage your team members and permissions.</p>
                        </div>

                        <!-- Main Form Card -->
                        <div data-tokens="Surface/card Border/default" style="${cardStyle}">
                            <div style="margin-bottom: 20px;">
                                <h2 data-tokens="Text/primary" style="font-size: 16px; font-weight: 600; margin: 0 0 4px 0; color: ${p.text.primary};">Profile Information</h2>
                                <p data-tokens="Text/secondary" style="font-size: 13px; color: ${p.text.secondary}; margin: 0;">Update your account's profile information and email address.</p>
                            </div>

                            <!-- Input Group -->
                            <div style="margin-bottom: 16px;">
                                <label data-tokens="Text/secondary" style="${labelStyle}">Username</label>
                                <div data-tokens="Border/default Background/tertiary" style="display: flex; border: 1px solid ${p.border.default}; border-radius: 6px; overflow: hidden;">
                                    <span data-tokens="Background/tertiary Text/secondary" style="background: ${p.bg.tertiary || p.bg.secondary}; color: ${p.text.secondary}; padding: 8px 12px; font-size: 13px; border-right: 1px solid ${p.border.default};">acme.com/</span>
                                    <input data-tokens="Background/primary Text/primary" type="text" value="johndoe" style="flex: 1; border: none; padding: 8px 12px; font-size: 13px; background: ${p.bg.primary}; color: ${p.text.primary}; outline: none;">
                                </div>
                            </div>
                            
                            <!-- Input Focus State Mockup -->
                            <div style="margin-bottom: 24px;">
                                <label data-tokens="Text/secondary" style="${labelStyle}">Email Address</label>
                                <input data-tokens="Border/focus Action/primary Background/primary Text/primary" type="text" value="john@example.com" style="width: 100%; border: 1px solid ${p.border.focus}; box-shadow: 0 0 0 3px ${p.action.primary}20; border-radius: 6px; padding: 8px 12px; font-size: 13px; background: ${p.bg.primary}; color: ${p.text.primary}; outline: none;">
                                <span data-tokens="Text/secondary" style="display: block; margin-top: 4px; font-size: 11px; color: ${p.text.tertiary || p.text.secondary};">We'll never share your email with anyone else.</span>
                            </div>

                            <!-- Actions -->
                            <div data-tokens="Border/subtle" style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid ${p.border.subtle || p.border.default};">
                                <button data-tokens="Action/primary" style="background-color: ${p.action.primary}; color: #ffffff; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 500; font-size: 13px; cursor: pointer;">Save Changes</button>
                                <button data-tokens="Text/primary Border/default" style="background-color: transparent; color: ${p.text.primary}; border: 1px solid ${p.border.strong || p.border.default}; padding: 8px 16px; border-radius: 6px; font-weight: 500; font-size: 13px; cursor: pointer;">Cancel</button>
                            </div>
                        </div>

                    </div>

                    <!-- Sidebar Column -->
                    <div style="display: flex; flex-direction: column; gap: 24px;">
                        
                        <!-- Status Cards -->
                        <div data-tokens="Surface/card Border/default" style="${cardStyle}">
                            <h3 data-tokens="Text/secondary" style="font-size: 13px; font-weight: 600; text-transform: uppercase; color: ${p.text.secondary}; margin: 0 0 16px 0; letter-spacing: 0.05em;">System Status</h3>
                            
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <!-- Success -->
                                <div data-tokens="Status/successBg Status/success" style="display: flex; gap: 12px; align-items: start; padding: 12px; border-radius: 6px; background: ${p.status.successBg}; border: 1px solid ${p.status.success}30;">
                                    <div data-tokens="Status/success" style="width: 8px; height: 8px; border-radius: 50%; background: ${p.status.success}; margin-top: 6px;"></div>
                                    <div>
                                        <div data-tokens="Status/success" style="font-size: 13px; font-weight: 600; color: ${p.status.success};">All Systems Operational</div>
                                        <div data-tokens="Status/success" style="font-size: 12px; color: ${p.status.success}; opacity: 0.9;">No incidents reported today.</div>
                                    </div>
                                </div>

                                <!-- Warning -->
                                <div data-tokens="Status/warningBg Status/warning" style="display: flex; gap: 12px; align-items: start; padding: 12px; border-radius: 6px; background: ${p.status.warningBg}; border: 1px solid ${p.status.warning}30;">
                                    <div data-tokens="Status/warning" style="width: 8px; height: 8px; border-radius: 50%; background: ${p.status.warning}; margin-top: 6px;"></div>
                                    <div>
                                        <div data-tokens="Status/warning" style="font-size: 13px; font-weight: 600; color: ${p.status.warning};">Storage Warning</div>
                                        <div data-tokens="Status/warning" style="font-size: 12px; color: ${p.status.warning}; opacity: 0.9;">85% of standard storage used.</div>
                                    </div>
                                </div>

                                <!-- Error -->
                                <div data-tokens="Status/errorBg Status/error" style="display: flex; gap: 12px; align-items: start; padding: 12px; border-radius: 6px; background: ${p.status.errorBg}; border: 1px solid ${p.status.error}30;">
                                    <div data-tokens="Status/error" style="width: 8px; height: 8px; border-radius: 50%; background: ${p.status.error}; margin-top: 6px;"></div>
                                    <div>
                                        <div data-tokens="Status/error" style="font-size: 13px; font-weight: 600; color: ${p.status.error};">Connection Failed</div>
                                        <div data-tokens="Status/error" style="font-size: 12px; color: ${p.status.error}; opacity: 0.9;">Unable to sync with database.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal/Overlay Preview (Mini) -->
                        <div data-tokens="Surface/overlay Border/default" style="position: relative; height: 160px; border-radius: 8px; overflow: hidden; border: 1px solid ${p.border.default};">
                             <div data-tokens="Surface/overlay" style="position: absolute; inset: 0; background: ${p.surface.overlay || '#00000080'}; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
                                <div data-tokens="Surface/modal Text/primary" style="background: ${p.surface.modal}; padding: 16px; border-radius: 8px; width: 80%; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                                    <div data-tokens="Text/primary" style="font-size: 13px; font-weight: 600; color: ${p.text.primary}; margin-bottom: 4px;">Confirm Deletion</div>
                                    <p data-tokens="Text/secondary" style="font-size: 11px; color: ${p.text.secondary}; margin-bottom: 12px;">Are you sure?</p>
                                    <button data-tokens="Action/destructive" style="width: 100%; background: ${p.action.destructive}; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; font-weight: 500;">Delete Everything</button>
                                </div>
                             </div>
                        </div>

                    </div>
                </div>
            </div>
        `;

        // --- NEW PREVIEW INTERACTION LOGIC ---

        // 1. Tooltip Element
        let tooltip = document.getElementById('preview-tooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'preview-tooltip';
            tooltip.style.cssText = `
                position: fixed; pointer-events: none; z-index: 9999;
                background: rgba(0,0,0,0.85); color: white; padding: 6px 10px;
                border-radius: 4px; font-size: 11px; font-weight: 500;
                display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1);
            `;

            document.body.appendChild(tooltip);
        }

        // 2. Attach Events to Elements with Tokens
        setTimeout(() => {
            const elements = previewBoard.querySelectorAll('[data-tokens]');
            elements.forEach(el => {
                // Style cursor to indicate clickable
                el.style.cursor = 'crosshair';

                el.addEventListener('mouseenter', (e) => {
                    e.stopPropagation(); // Prefer inner elements
                    // Highlight self
                    el.style.outline = '2px dashed #18A0FB';

                    // Show Tooltip
                    const tokenList = el.dataset.tokens.replace(/ /g, ', ');
                    tooltip.textContent = tokenList;
                    tooltip.style.display = 'block';
                });

                el.addEventListener('mousemove', (e) => {
                    tooltip.style.left = (e.clientX + 12) + 'px';
                    tooltip.style.top = (e.clientY + 12) + 'px';
                });

                el.addEventListener('mouseleave', () => {
                    el.style.outline = '';
                    tooltip.style.display = 'none';
                });

                el.addEventListener('click', (e) => {
                    // Check if there's a more specific child element with data-tokens
                    // between the click target and this element
                    let target = e.target;
                    let hasMoreSpecificChild = false;

                    // Walk up from target to this element
                    while (target && target !== el) {
                        if (target.hasAttribute && target.hasAttribute('data-tokens')) {
                            // Found a child element with data-tokens
                            hasMoreSpecificChild = true;
                            break;
                        }
                        target = target.parentElement;
                    }

                    if (hasMoreSpecificChild) {
                        // Let the more specific child handle it
                        return;
                    }

                    // This is the most specific element, handle the click
                    e.stopPropagation();

                    // Robust parsing: split by space, trim, remove empty strings
                    const tokens = el.dataset.tokens.split(' ').map(t => t.trim()).filter(Boolean);

                    console.log('üñ±Ô∏è Clicked element with tokens:', tokens);

                    if (tokens.length > 0) {
                        let scrolled = false;
                        let foundAny = false;

                        tokens.forEach(tokenName => {
                            const safeName = tokenName.replace(/\//g, '-');
                            const targetId = `token-row-${safeName}`;
                            const targetRow = document.getElementById(targetId);

                            console.log(`  Looking for ID: "${targetId}"`, targetRow ? '‚úÖ Found' : '‚ùå Not found');

                            if (targetRow) {
                                foundAny = true;
                                // Scroll to the FIRST compatible row found
                                if (!scrolled) {
                                    // First, ensure the parent <details> is open
                                    const parentDetails = targetRow.closest('details');
                                    if (parentDetails && !parentDetails.open) {
                                        console.log('üìÇ Opening parent accordion');
                                        parentDetails.open = true;
                                    }

                                    // Use scrollIntoView which works better with accordions
                                    console.log('üìú Scrolling to row');
                                    setTimeout(() => {
                                        targetRow.scrollIntoView({
                                            behavior: 'smooth',
                                            block: 'center',
                                            inline: 'nearest'
                                        });
                                    }, parentDetails && !parentDetails.open ? 100 : 0);

                                    scrolled = true;
                                }
                                // Flash ALL compatible rows
                                console.log('‚ö° Adding flash effect to row');
                                targetRow.classList.add('editor-flash');
                                setTimeout(() => targetRow.classList.remove('editor-flash'), 1500);
                            } else {
                                console.warn('Target row not found:', safeName);
                            }
                        });

                        if (!foundAny) {
                            console.warn('No valid token rows found for:', tokens);
                        }
                    }
                });
            });
        }, 100); // Small delay to ensure DOM render
    }

    function renderTokenEditor() {
        if (!generatedThemeData || !generatedThemeData.tokens) return;

        console.log('üåì Rendering Token Editor...');
        const { tokens, paletteData } = generatedThemeData;

        // Clear containers
        const containers = {
            bg: document.getElementById('editor-bg'),
            text: document.getElementById('editor-text'),
            action: document.getElementById('editor-action'),
            border: document.getElementById('editor-border'),
            status: document.getElementById('editor-status')
        };

        Object.values(containers).forEach(el => { if (el) el.innerHTML = ''; });

        // DEBUG: Log palette data to see what we're working with
        console.log('üìä Palette Data received:', paletteData);
        Object.keys(paletteData).forEach(paletteName => {
            console.log(`  ${paletteName}:`, Object.keys(paletteData[paletteName]).length, 'colors', paletteData[paletteName]);
        });

        // Helper: Determine which palette a token should use
        const getPaletteForToken = (tokenName) => {
            // Status tokens
            if (tokenName.startsWith('Status/success')) return 'success';
            if (tokenName.startsWith('Status/warning')) return 'warning';
            if (tokenName.startsWith('Status/error')) return 'error';
            if (tokenName.startsWith('Status/info')) return 'accent';

            // Destructive actions (use error palette)
            if (tokenName.startsWith('Action/destructive')) return 'error';

            // Other actions and buttons (use accent)
            if (tokenName.startsWith('Action/') || tokenName.startsWith('Button/')) return 'accent';

            // Backgrounds
            if (tokenName.startsWith('Background/brand') || tokenName.startsWith('Background/accent')) return 'accent';

            // Text
            if (tokenName.startsWith('Text/brand') || tokenName.startsWith('Text/link')) return 'accent';

            // Badges
            if (tokenName.startsWith('Badge/brand')) return 'accent';

            // Navigation
            if (tokenName.startsWith('Nav/')) return 'accent';

            // Icons
            if (tokenName.startsWith('Icon/brand')) return 'accent';

            // Borders - check error first, then brand/focus
            if (tokenName.startsWith('Border/error')) return 'error';
            if (tokenName.startsWith('Border/brand') || tokenName.startsWith('Border/focus')) return 'accent';

            // Inputs
            if (tokenName.startsWith('Input/borderFocus')) return 'accent';

            // Default to neutral for everything else
            return 'neutral';
        };

        // Generate custom dropdown with color swatches
        const generateCustomSelect = (paletteColors, currentValue, overrideValue, tokenName, mode) => {
            if (!paletteColors || Object.keys(paletteColors).length === 0) {
                // Fallback to generic if palette data missing
                const steps = [0, 50, 100, 200, 300, 400, 500, 600, 700, 800, 900, 950];
                paletteColors = {};
                steps.forEach(s => paletteColors[s] = '#cccccc');
            }

            const targetVal = overrideValue ? String(overrideValue) : String(currentValue);

            // Smart fallback: if targetVal doesn't exist in palette, find nearest available value
            let actualTargetVal = targetVal;
            if (!paletteColors[targetVal]) {
                const availableScales = Object.keys(paletteColors).map(Number).sort((a, b) => a - b);
                const requestedScale = Number(targetVal);

                // Find closest scale
                let closest = availableScales[0];
                let minDiff = Math.abs(requestedScale - closest);

                for (const scale of availableScales) {
                    const diff = Math.abs(requestedScale - scale);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closest = scale;
                    }
                }

                actualTargetVal = String(closest);
                console.warn(`‚ö†Ô∏è ${tokenName} ${mode} requested ${targetVal} but palette only has ${availableScales.join(', ')}. Using closest: ${closest}`);
            }

            const selectedHex = paletteColors[actualTargetVal] || '#cccccc';

            // Create unique ID for this dropdown
            const dropdownId = `dropdown-${tokenName.replace(/\//g, '-')}-${mode}`;

            // Generate options HTML
            const optionsHtml = Object.entries(paletteColors)
                .sort((a, b) => Number(a[0]) - Number(b[0]))
                .map(([scale, hex]) => {
                    const isSelected = actualTargetVal === scale;
                    return `
                        <div class="custom-option ${isSelected ? 'selected' : ''}" data-value="${scale}" data-hex="${hex}">
                            <span class="color-swatch" style="background: ${hex};"></span>
                            <span class="scale-value">${scale}</span>
                        </div>
                    `;
                }).join('');

            return `
                <div class="custom-select" data-token="${tokenName}" data-mode="${mode}" id="${dropdownId}">
                    <div class="custom-select-trigger">
                        <span class="color-swatch" style="background: ${selectedHex};"></span>
                        <span class="scale-value">${actualTargetVal}</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="custom-options">
                        ${optionsHtml}
                    </div>
                </div>
            `;
        };

        // Helper: Create Token Row
        const createRow = (name, token) => {
            const row = document.createElement('div');
            // Create a safe ID string: replace / with -
            const safeName = name.replace(/\//g, '-');
            row.id = `token-row-${safeName}`;
            row.className = 'token-row';
            row.style.cssText = `
                display: flex; flex-direction: column; gap: 4px; 
                padding: 12px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;
            `;

            const getScale = (n) => {
                if (!n) return '500';
                const parts = n.split(/[\/\- ]/);
                return parts[parts.length - 1];
            };

            const lightStep = getScale(token.light.name);
            const darkStep = getScale(token.dark.name);

            // Get Overrides if any
            const overrideLight = tokenOverrides[name] && tokenOverrides[name].light;
            const overrideDark = tokenOverrides[name] && tokenOverrides[name].dark;

            // Determine which palette to use for this token
            const paletteName = getPaletteForToken(name);
            const paletteColors = paletteData[paletteName] || {};

            row.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 11px; font-weight: 600; color: #374151;">${name.split('/')[1]}</span>
                    <span style="font-size: 9px; color: #9ca3af; text-transform: uppercase;">${paletteName}</span>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <label style="font-size: 10px; color: #666; width: 12px;">L</label>
                    <div style="width: 16px; height: 16px; border-radius: 50%; background: ${token.light.hex}; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0;" title="${token.light.hex}"></div>
                    ${generateCustomSelect(paletteColors, lightStep, overrideLight, name, 'light')}
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <label style="font-size: 10px; color: #666; width: 12px;">D</label>
                    <div style="width: 16px; height: 16px; border-radius: 50%; background: ${token.dark.hex}; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0;" title="${token.dark.hex}"></div>
                    ${generateCustomSelect(paletteColors, darkStep, overrideDark, name, 'dark')}
                </div>
            `;

            // Highlighter Events
            const highlightMatch = () => {
                document.querySelectorAll(`[data-tokens]`).forEach(el => {
                    const tokens = el.dataset.tokens.split(' ');
                    if (tokens.includes(name)) {
                        el.classList.add('preview-highlight');
                    } else {
                        el.classList.remove('preview-highlight');
                    }
                });
            };

            const removeHighlight = () => {
                document.querySelectorAll('.preview-highlight').forEach(el => el.classList.remove('preview-highlight'));
            };

            row.addEventListener('mouseenter', highlightMatch);
            row.addEventListener('mouseleave', removeHighlight);

            return row;
        };

        // Group Tokens into Categories
        Object.entries(tokens).forEach(([name, token]) => {
            let container = containers.bg; // Fallback

            if (name.startsWith('Background/') || name.startsWith('Surface/') || name.startsWith('Overlay/')) {
                container = containers.bg;
            } else if (name.startsWith('Text/') || name.startsWith('Icon/')) {
                container = containers.text;
            } else if (name.startsWith('Action/') || name.startsWith('Button/') || name.startsWith('Input/')) {
                container = containers.action;
            } else if (name.startsWith('Border/')) {
                container = containers.border;
            } else if (name.startsWith('Status/') || name.startsWith('Badge/') || name.startsWith('A11y/')) {
                container = containers.status;
            }

            if (container) {
                container.appendChild(createRow(name, token));
            }
        });

        // Add Listeners for Custom Selects
        document.querySelectorAll('.custom-select').forEach(customSelect => {
            const trigger = customSelect.querySelector('.custom-select-trigger');
            const options = customSelect.querySelectorAll('.custom-option');
            const tokenName = customSelect.dataset.token;
            const mode = customSelect.dataset.mode;

            // Toggle dropdown
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                // Close other dropdowns
                document.querySelectorAll('.custom-select.open').forEach(other => {
                    if (other !== customSelect) other.classList.remove('open');
                });
                customSelect.classList.toggle('open');
            });

            // Handle option selection
            options.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const value = option.dataset.value;
                    const hex = option.dataset.hex;

                    // Update UI
                    options.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');

                    // Update trigger
                    const triggerSwatch = trigger.querySelector('.color-swatch');
                    const triggerValue = trigger.querySelector('.scale-value');
                    triggerSwatch.style.background = hex;
                    triggerValue.textContent = value;

                    // Close dropdown
                    customSelect.classList.remove('open');

                    // Update Overrides
                    if (!tokenOverrides) tokenOverrides = {};
                    if (!tokenOverrides[tokenName]) tokenOverrides[tokenName] = {};
                    tokenOverrides[tokenName][mode] = value;

                    // Trigger Regeneration
                    const msg = {
                        type: 'regenerate-theme',
                        accentPalette: accentSelect.value,
                        neutralPalette: neutralSelect.value,
                        statusPalettes: {
                            success: successSelect.value,
                            warning: warningSelect.value,
                            error: errorSelect.value
                        },
                        themeName: themeNameInput.value.trim(),
                        tokenOverrides: tokenOverrides
                    };

                    // Store scroll position to restore after re-render
                    window.lastEditorScroll = document.getElementById('editor-panel') ? document.getElementById('editor-panel').scrollTop : 0;

                    parent.postMessage({ pluginMessage: msg }, '*');
                });
            });
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.custom-select.open').forEach(select => {
                select.classList.remove('open');
            });
        });

        // Restore Scroll Position if available
        if (typeof window.lastEditorScroll !== 'undefined') {
            const editorPanel = document.getElementById('editor-panel');
            if (editorPanel) {
                editorPanel.scrollTop = window.lastEditorScroll;
                // Optional: clear it to avoid sticking on next manual render
                // window.lastEditorScroll = undefined; 
            }
        }
    }
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTheme);
} else {
    initTheme();
}


/* --- collections.js --- */
// Collections (Documentation) Section Logic
console.log('üìö Collections script loaded');

function initCollections() {
    console.log('üìö Initializing Collections section...');

    // UI Elements
    const collectionSelect = document.getElementById('collection-select');
    const groupSelect = document.getElementById('group-select');
    const convertBtn = document.getElementById('convert-btn');
    const generateBtn = document.getElementById('generate-btn');
    const resultDiv = document.getElementById('result');

    if (!convertBtn) {
        console.warn('‚ö†Ô∏è Collections UI elements not found');
        return;
    }

    // Message Listener
    window.addEventListener('plugin-message', (event) => {
        const { type, payload } = event.detail;

        if (type === 'load-collections') {
            collectionSelect.innerHTML = '<option value="" disabled selected>Select collection...</option>';
            payload.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                collectionSelect.appendChild(opt);
            });
            console.log('üìö Collections loaded');

        } else if (type === 'load-groups') {
            groupSelect.innerHTML = '<option value="">All Groups</option>';
            payload.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = g;
                groupSelect.appendChild(opt);
            });
            groupSelect.disabled = false;
            console.log('üìö Groups loaded');

        } else if (type === 'conversion-result') {
            // Render result in UI
            resultDiv.innerHTML = '';

            if (payload.length === 0) {
                resultDiv.innerHTML = '<p style="color:#666; text-align:center;">No variables found.</p>';
                return;
            }

            payload.forEach(item => {
                const row = document.createElement('div');
                row.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;';

                const info = document.createElement('div');
                info.innerHTML = `
                    <div style="font-weight: 500; font-size: 13px;">${item.name}</div>
                    <div style="font-size: 11px; color: #888;">${item.type}</div>
                `;

                const val = document.createElement('div');
                if (item.type === 'COLOR') {
                    val.style.cssText = 'display:flex; align-items:center; gap:8px;';
                    val.innerHTML = '<span style="font-size: 14px;">üé®</span>';
                } else {
                    val.textContent = 'Variable';
                }

                row.appendChild(info);
                row.appendChild(val);
                resultDiv.appendChild(row);
            });
        }
    });

    // Events
    collectionSelect.onchange = () => {
        const id = collectionSelect.value;
        console.log('üìö Collection changed:', id);
        parent.postMessage({ pluginMessage: { type: 'get-groups', collectionId: id } }, '*');
    };

    convertBtn.onclick = () => {
        const id = collectionSelect.value;
        if (!id) return;

        console.log('üìö Converting/Listing JSON...');
        parent.postMessage({
            pluginMessage: {
                type: 'convert-json',
                collectionId: id,
                groupName: groupSelect.value
            }
        }, '*');
        resultDiv.innerHTML = '<p style="color:#666; text-align:center;">Loading...</p>';
    };

    generateBtn.onclick = () => {
        const id = collectionSelect.value;
        if (!id) return;

        console.log('üìö Generating canvas documentation...');
        parent.postMessage({
            pluginMessage: {
                type: 'generate-canvas',
                collectionId: id,
                groupName: groupSelect.value
            }
        }, '*');
    };
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCollections);
} else {
    initCollections();
}


/* --- navigation.js --- */
// Navigation and Section Management
const sectionTitles = {
    'scale': { title: 'Color Palettes', desc: 'Generate color scales for your design system.' },
    'measures': { title: 'Measure Generator', desc: 'Create spacing and sizing variables.' },
    'typography': { title: 'Typography System', desc: 'Define font families, sizes, and weights.' },
    'aliases': { title: 'Responsive Semantics', desc: 'Generate semantic tokens that adapt to viewport size.' },
    'theme': { title: 'Theme Generator', desc: 'Create intelligent Light/Dark themes from your color primitives.' },
    'components': { title: 'Atomic Component System', desc: 'Create visual components using your existing tokens and variables.' },
    'collections': { title: 'Documentation', desc: 'View and manage your variable collections.' }
};

function initNavigation() {
    console.log('üß≠ Initializing Navigation...');
    const navItems = document.querySelectorAll('.nav-item');

    if (navItems.length === 0) {
        console.warn('‚ö†Ô∏è No nav items found. DOM might not be ready.');
        return;
    }

    navItems.forEach(navItem => {
        navItem.addEventListener('click', () => {
            const section = navItem.dataset.section;
            console.log(`üìç Navigating to: ${section}`);

            // Remove active class from all nav items and sections
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));

            // Add active class to clicked nav item and corresponding section
            navItem.classList.add('active');
            const sectionElement = document.getElementById('section-' + section);
            if (sectionElement) {
                sectionElement.classList.add('active');
            } else {
                console.error(`‚ùå Section element #section-${section} not found!`);
            }

            // Update page title and description
            const titleInfo = sectionTitles[section];
            if (titleInfo) {
                const titleEl = document.getElementById('page-title');
                const descEl = document.getElementById('page-description');
                if (titleEl) titleEl.textContent = titleInfo.title;
                if (descEl) descEl.textContent = titleInfo.desc;
            }

            // Load collections when entering sections that require them
            if (['theme', 'measures', 'scale', 'typography', 'aliases', 'collections'].includes(section)) {
                console.log(`Using common loader for ${section}`);
                parent.postMessage({ pluginMessage: { type: 'load-collections' } }, '*');
            }
        });
    });
    console.log('‚úÖ Navigation initialized');
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNavigation);
} else {
    initNavigation();
}




        // Initialize navigation immediately
        initNavigation();
    </script>
</body>
</html>