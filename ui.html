<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PirulinoColorete</title>
    <style>
/**
 * PirulinoColorete Design System - Design Tokens
 * Premium UI/UX Upgrade v2.0
 */

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

:root {
  /* ========================================
     COLOR PALETTE - Premium Dark Theme
     ======================================== */
  
  /* Background Hierarchy */
  --bg-base: #0a0a0b;
  --bg-elevated: #111113;
  --bg-surface: #18181b;
  --bg-surface-hover: #1f1f23;
  --bg-surface-active: #27272a;
  --bg-overlay: rgba(0, 0, 0, 0.8);
  
  /* Accent Colors */
  --accent-primary: #6366f1;
  --accent-primary-hover: #818cf8;
  --accent-primary-active: #4f46e5;
  --accent-primary-subtle: rgba(99, 102, 241, 0.12);
  --accent-primary-muted: rgba(99, 102, 241, 0.08);
  
  /* Figma Brand Integration */
  --figma-blue: #0d99ff;
  --figma-blue-hover: #2eaaff;
  --figma-blue-subtle: rgba(13, 153, 255, 0.15);
  
  /* Secondary Colors */
  --accent-success: #10b981;
  --accent-success-subtle: rgba(16, 185, 129, 0.12);
  --accent-warning: #f59e0b;
  --accent-warning-subtle: rgba(245, 158, 11, 0.12);
  --accent-error: #ef4444;
  --accent-error-subtle: rgba(239, 68, 68, 0.12);
  
  /* Text Hierarchy */
  --text-primary: #fafafa;
  --text-secondary: #a1a1aa;
  --text-tertiary: #71717a;
  --text-quaternary: #52525b;
  --text-inverse: #09090b;
  
  /* Border Colors */
  --border-subtle: rgba(255, 255, 255, 0.06);
  --border-default: rgba(255, 255, 255, 0.1);
  --border-strong: rgba(255, 255, 255, 0.16);
  --border-focus: var(--accent-primary);
  
  /* ========================================
     GRADIENTS
     ======================================== */
  --gradient-sidebar: linear-gradient(180deg, #111113 0%, #09090b 100%);
  --gradient-header: linear-gradient(90deg, rgba(99, 102, 241, 0.05) 0%, transparent 100%);
  --gradient-accent: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
  --gradient-card: linear-gradient(145deg, rgba(255, 255, 255, 0.03) 0%, transparent 100%);
  --gradient-glow: radial-gradient(ellipse at center, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
  
  /* ========================================
     SHADOWS & EFFECTS
     ======================================== */
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.3);
  --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.2);
  --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5), 0 4px 8px rgba(0, 0, 0, 0.3);
  --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.6), 0 8px 16px rgba(0, 0, 0, 0.4);
  --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.3);
  --shadow-glow-intense: 0 0 40px rgba(99, 102, 241, 0.5), 0 0 80px rgba(99, 102, 241, 0.2);
  
  /* Glassmorphism */
  --glass-bg: rgba(24, 24, 27, 0.8);
  --glass-blur: blur(20px);
  --glass-border: rgba(255, 255, 255, 0.1);
  
  /* ========================================
     SPACING SCALE
     ======================================== */
  --space-0: 0;
  --space-1: 4px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-5: 20px;
  --space-6: 24px;
  --space-7: 28px;
  --space-8: 32px;
  --space-10: 40px;
  --space-12: 48px;
  --space-16: 64px;
  
  /* ========================================
     TYPOGRAPHY
     ======================================== */
  --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 13px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 22px;
  --font-size-3xl: 28px;
  
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;
  --font-weight-extrabold: 800;
  
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --line-height-relaxed: 1.7;
  
  --letter-spacing-tight: -0.02em;
  --letter-spacing-normal: 0;
  --letter-spacing-wide: 0.05em;
  
  /* ========================================
     BORDER RADIUS
     ======================================== */
  --radius-xs: 4px;
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --radius-2xl: 20px;
  --radius-full: 9999px;
  
  /* ========================================
     TRANSITIONS
     ======================================== */
  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-normal: 200ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-spring: 400ms cubic-bezier(0.34, 1.56, 0.64, 1);
  
  /* ========================================
     Z-INDEX SCALE
     ======================================== */
  --z-base: 1;
  --z-dropdown: 100;
  --z-sticky: 200;
  --z-overlay: 300;
  --z-modal: 400;
  --z-toast: 500;
  --z-tooltip: 600;
  
  /* ========================================
     SIDEBAR
     ======================================== */
  --sidebar-width: 260px;
  --sidebar-collapsed-width: 64px;
}

/* ========================================
   LIGHT THEME OVERRIDE
   ======================================== */
@media (prefers-color-scheme: light) {
  :root.auto-theme {
    --bg-base: #ffffff;
    --bg-elevated: #f8fafc;
    --bg-surface: #f1f5f9;
    --bg-surface-hover: #e2e8f0;
    --bg-surface-active: #cbd5e1;
    
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-tertiary: #64748b;
    --text-quaternary: #94a3b8;
    
    --border-subtle: rgba(0, 0, 0, 0.04);
    --border-default: rgba(0, 0, 0, 0.08);
    --border-strong: rgba(0, 0, 0, 0.12);
    
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
  }
}

/**
 * PirulinoColorete - Premium Layout System
 * Modern UI with Glassmorphism and Smooth Animations
 */

/* ========================================
   BASE RESET & DEFAULTS
   ======================================== */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

*::before,
*::after {
    box-sizing: border-box;
}

html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
}

body {
    font-family: var(--font-family);
    font-size: var(--font-size-base);
    line-height: var(--line-height-normal);
    color: var(--text-primary);
    background: var(--bg-base);
    height: 100vh;
    overflow: hidden;
    display: flex;
}

/* ========================================
   SIDEBAR NAVIGATION
   ======================================== */
.sidebar {
    width: var(--sidebar-width);
    min-width: var(--sidebar-width);
    height: 100vh;
    background: var(--gradient-sidebar);
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border-subtle);
    position: relative;
    z-index: var(--z-sticky);
}

/* Subtle glow effect */
.sidebar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 200px;
    background: var(--gradient-glow);
    pointer-events: none;
    opacity: 0.5;
}

.sidebar-header {
    padding: var(--space-6) var(--space-5);
    border-bottom: 1px solid var(--border-subtle);
    position: relative;
}

.sidebar-logo {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    letter-spacing: var(--letter-spacing-tight);
    background: var(--gradient-accent);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-1);
}

.sidebar-subtitle {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
    font-weight: var(--font-weight-semibold);
    letter-spacing: var(--letter-spacing-wide);
    text-transform: uppercase;
}

.sidebar-nav {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-3) 0;
}

/* Navigation Item */
.nav-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-5);
    margin: var(--space-1) var(--space-2);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-normal);
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    position: relative;
    overflow: hidden;
}

.nav-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 0;
    background: var(--gradient-accent);
    border-radius: var(--radius-full);
    transition: height var(--transition-normal);
}

.nav-item:hover {
    background: var(--bg-surface);
    color: var(--text-primary);
}

.nav-item:hover::before {
    height: 50%;
}

.nav-item.active {
    background: var(--accent-primary-subtle);
    color: var(--accent-primary-hover);
}

.nav-item.active::before {
    height: 70%;
}

.nav-item-icon {
    font-size: var(--font-size-lg);
    width: 24px;
    text-align: center;
    opacity: 0.9;
}

.nav-item-label {
    flex: 1;
}

/* ========================================
   MAIN CONTENT AREA
   ======================================== */
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg-base);
    position: relative;
}

/* Content Header */
.content-header {
    padding: var(--space-5) var(--space-8);
    background: var(--bg-elevated);
    border-bottom: 1px solid var(--border-subtle);
    position: relative;
    z-index: 10;
}

.content-header::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--gradient-header);
    pointer-events: none;
}

.content-header h1 {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    letter-spacing: var(--letter-spacing-tight);
    color: var(--text-primary);
    margin: 0 0 var(--space-1) 0;
    position: relative;
}

.content-header p {
    font-size: var(--font-size-sm);
    color: var(--text-tertiary);
    margin: 0;
    position: relative;
}

/* Content Body */
.content-body {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-8);
    background: var(--bg-base);
}

.content-container {
    max-width: 960px;
    margin: 0 auto;
}

/* ========================================
   SECTION CONTENT
   ======================================== */
.section-content {
    display: none;
    animation: fadeSlideIn 0.4s var(--transition-spring);
}

.section-content.active {
    display: block;
}

@keyframes fadeSlideIn {
    from {
        opacity: 0;
        transform: translateY(12px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ========================================
   CUSTOM SCROLLBAR
   ======================================== */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background: var(--border-strong);
    border-radius: var(--radius-full);
    transition: background var(--transition-fast);
}

::-webkit-scrollbar-thumb:hover {
    background: var(--text-quaternary);
}

/* Firefox scrollbar */
* {
    scrollbar-width: thin;
    scrollbar-color: var(--border-strong) transparent;
}

/* ========================================
   RESIZE HANDLE
   ======================================== */
#resize-handle {
    position: fixed;
    bottom: 0;
    right: 0;
    width: 16px;
    height: 16px;
    cursor: nwse-resize;
    z-index: var(--z-tooltip);
    opacity: 0.5;
    transition: opacity var(--transition-fast);
}

#resize-handle:hover {
    opacity: 1;
}

#resize-handle:hover svg path {
    stroke: var(--accent-primary);
}
/**
 * PirulinoColorete - Premium Components
 * Modern UI Components with Micro-animations
 */

/* ========================================
   CARDS & SURFACES
   ======================================== */
.card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
}

.card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--gradient-card);
    pointer-events: none;
}

.card:hover {
    border-color: var(--border-default);
    box-shadow: var(--shadow-md);
}

.card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-4);
}

.card-title {
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
}

.card-subtitle {
    font-size: var(--font-size-sm);
    color: var(--text-tertiary);
    margin-top: var(--space-1);
}

/* Glass Card Variant */
.card-glass {
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border: 1px solid var(--glass-border);
}

/* ========================================
   TYPOGRAPHY
   ======================================== */
h1,
h2,
h3,
h4,
h5,
h6 {
    color: var(--text-primary);
    font-weight: var(--font-weight-semibold);
    letter-spacing: var(--letter-spacing-tight);
    line-height: var(--line-height-tight);
}

h2 {
    font-size: var(--font-size-lg);
    margin: 0 0 var(--space-4) 0;
}

h3 {
    font-size: var(--font-size-md);
    margin: 0 0 var(--space-3) 0;
}

p.description,
.section-description {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-bottom: var(--space-6);
    line-height: var(--line-height-relaxed);
}

.section-title {
    font-size: var(--font-size-xs);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
    color: var(--text-tertiary);
    font-weight: var(--font-weight-semibold);
    margin: var(--space-6) 0 var(--space-3) 0;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border-subtle);
}

/* ========================================
   FORM CONTROLS
   ======================================== */
.form-group,
.input-group {
    margin-bottom: var(--space-4);
}

label {
    display: block;
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    color: var(--text-secondary);
    margin-bottom: var(--space-2);
    letter-spacing: var(--letter-spacing-wide);
    text-transform: uppercase;
}

.sub-label {
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
    margin-top: var(--space-5);
    margin-bottom: var(--space-3);
    display: block;
}

/* Input Fields */
input[type="text"],
input[type="number"],
input[type="email"],
input[type="password"],
select,
textarea,
.input-text {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    font-size: var(--font-size-sm);
    font-family: inherit;
    line-height: var(--line-height-normal);
    color: var(--text-primary);
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
    appearance: none;
    outline: none;
}

input:hover,
select:hover,
textarea:hover {
    border-color: var(--border-strong);
}

input:focus,
select:focus,
textarea:focus {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px var(--accent-primary-muted);
    background: var(--bg-surface-hover);
}

input::placeholder,
textarea::placeholder {
    color: var(--text-quaternary);
}

/* Color Input Special */
input[type="color"] {
    width: 48px;
    height: 48px;
    padding: 2px;
    border-radius: var(--radius-lg);
    cursor: pointer;
}

input[type="color"]::-webkit-color-swatch-wrapper {
    padding: 0;
}

input[type="color"]::-webkit-color-swatch {
    border: none;
    border-radius: var(--radius-md);
}

/* Select Arrow */
select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2371717a'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right var(--space-3) center;
    background-size: 16px;
    padding-right: var(--space-10);
}

/* ========================================
   BUTTONS
   ======================================== */
button,
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    font-family: inherit;
    line-height: 1;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
    overflow: hidden;
}

/* Button Ripple Effect */
button::after,
.btn::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at var(--ripple-x, 50%) var(--ripple-y, 50%), rgba(255, 255, 255, 0.3), transparent 70%);
    opacity: 0;
    transition: opacity var(--transition-fast);
}

button:active::after,
.btn:active::after {
    opacity: 1;
}

/* Primary Button */
button.primary,
.btn-primary {
    background: var(--gradient-accent);
    color: white;
    box-shadow: var(--shadow-sm);
}

button.primary:hover,
.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md), var(--shadow-glow);
}

button.primary:active,
.btn-primary:active {
    transform: translateY(0);
}

/* Secondary Button */
button.secondary,
.btn-secondary {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    color: var(--text-primary);
}

button.secondary:hover,
.btn-secondary:hover {
    background: var(--bg-surface-hover);
    border-color: var(--border-strong);
}

/* Ghost Button */
button.ghost,
.btn-ghost {
    background: transparent;
    color: var(--text-secondary);
}

button.ghost:hover,
.btn-ghost:hover {
    background: var(--bg-surface);
    color: var(--text-primary);
}

/* Danger Button */
button.danger,
.btn-danger {
    background: var(--accent-error);
    color: white;
}

button.danger:hover,
.btn-danger:hover {
    background: #dc2626;
}

/* Button Sizes */
.btn-sm {
    padding: var(--space-2) var(--space-3);
    font-size: var(--font-size-xs);
}

.btn-lg,
.big-btn {
    padding: var(--space-4) var(--space-6);
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-semibold);
}

/* Disabled State */
button:disabled,
.btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
}

/* Icon Only Button */
.btn-icon {
    padding: var(--space-2);
    border-radius: var(--radius-md);
}

/* ========================================
   TOGGLE BUTTONS
   ======================================== */
.tab-toggle {
    display: inline-flex;
    padding: var(--space-1);
    gap: var(--space-1);
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
}

.toggle-btn {
    padding: var(--space-2) var(--space-4);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    color: var(--text-tertiary);
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.toggle-btn:hover {
    color: var(--text-secondary);
}

.toggle-btn.active {
    background: var(--bg-surface-active);
    color: var(--text-primary);
    box-shadow: var(--shadow-xs);
}

/* ========================================
   ACCORDION / DETAILS
   ======================================== */
details {
    margin-bottom: var(--space-3);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--bg-surface);
    transition: all var(--transition-normal);
}

details:hover {
    border-color: var(--border-default);
}

details[open] {
    box-shadow: var(--shadow-sm);
}

summary {
    padding: var(--space-4) var(--space-5);
    cursor: pointer;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--text-primary);
    background: var(--bg-surface);
    user-select: none;
    display: flex;
    align-items: center;
    list-style: none;
    transition: background var(--transition-fast);
}

summary::-webkit-details-marker {
    display: none;
}

summary:hover {
    background: var(--bg-surface-hover);
}

summary::before {
    content: '';
    width: 6px;
    height: 6px;
    margin-right: var(--space-3);
    border-right: 2px solid var(--text-tertiary);
    border-bottom: 2px solid var(--text-tertiary);
    transform: rotate(-45deg);
    transition: transform var(--transition-fast);
}

details[open] summary::before {
    transform: rotate(45deg);
}

details[open] summary {
    border-bottom: 1px solid var(--border-subtle);
}

/* ========================================
   BADGES & CHIPS
   ======================================== */
.badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-2);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    border-radius: var(--radius-full);
    background: var(--accent-primary-subtle);
    color: var(--accent-primary-hover);
}

.badge-success {
    background: var(--accent-success-subtle);
    color: var(--accent-success);
}

.badge-warning {
    background: var(--accent-warning-subtle);
    color: var(--accent-warning);
}

.badge-error {
    background: var(--accent-error-subtle);
    color: var(--accent-error);
}

/* ========================================
   COLOR SWATCHES
   ======================================== */
.color-swatch {
    width: 100%;
    aspect-ratio: 1;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
    position: relative;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.color-swatch:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-md);
}

.color-swatch-label {
    position: absolute;
    bottom: var(--space-2);
    left: var(--space-2);
    right: var(--space-2);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    padding: var(--space-1) var(--space-2);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: var(--radius-sm);
    text-align: center;
    opacity: 0;
    transform: translateY(4px);
    transition: all var(--transition-fast);
}

.color-swatch:hover .color-swatch-label {
    opacity: 1;
    transform: translateY(0);
}

/* ========================================
   TOKEN GRID
   ======================================== */
.token-grid {
    padding: var(--space-4);
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: var(--space-3);
}

/* ========================================
   DIVIDERS & SEPARATORS
   ======================================== */
.separator {
    height: 1px;
    background: var(--border-subtle);
    margin: var(--space-6) 0;
}

.separator-vertical {
    width: 1px;
    height: 100%;
    background: var(--border-subtle);
}

/* ========================================
   FLEX UTILITIES
   ======================================== */
.flex-row {
    display: flex;
    gap: var(--space-4);
}

.flex-row>* {
    flex: 1;
}

.flex-center {
    display: flex;
    align-items: center;
    justify-content: center;
}

.flex-between {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

/* ========================================
   ANIMATIONS
   ======================================== */
@keyframes pulse {

    0%,
    100% {
        opacity: 1;
    }

    50% {
        opacity: 0.5;
    }
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }

    to {
        transform: rotate(360deg);
    }
}

@keyframes shimmer {
    0% {
        background-position: -200% 0;
    }

    100% {
        background-position: 200% 0;
    }
}

.animate-pulse {
    animation: pulse 2s ease-in-out infinite;
}

.animate-spin {
    animation: spin 1s linear infinite;
}

/* ========================================
   PREVIEW HIGHLIGHT
   ======================================== */
.preview-highlight {
    outline: 2px solid var(--accent-primary) !important;
    box-shadow: var(--shadow-glow-intense) !important;
    position: relative;
    z-index: 10;
    transition: all var(--transition-fast);
}

/* Editor Row Flash - MÃ¡s visible con borde brillante */
@keyframes flashRow {
    0% {
        background-color: var(--accent-primary-subtle);
        box-shadow: 0 0 0 2px var(--accent-primary), 0 0 20px var(--accent-primary);
        transform: scale(1.02);
    }

    50% {
        background-color: var(--accent-primary-muted);
        box-shadow: 0 0 0 2px var(--accent-primary), 0 0 10px var(--accent-primary);
    }

    100% {
        background-color: var(--bg-surface);
        box-shadow: none;
        transform: scale(1);
    }
}

.editor-flash {
    animation: flashRow 1.5s ease-out forwards !important;
    z-index: 100;
    position: relative;
    border-radius: var(--radius-md);
}

/* ========================================
   LOADING STATES
   ======================================== */
.skeleton {
    background: linear-gradient(90deg,
            var(--bg-surface) 0%,
            var(--bg-surface-hover) 50%,
            var(--bg-surface) 100%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: var(--radius-md);
}

/* ========================================
   TOOLTIPS
   ======================================== */
[data-tooltip] {
    position: relative;
}

[data-tooltip]::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-4px);
    padding: var(--space-2) var(--space-3);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    color: white;
    background: var(--bg-overlay);
    border-radius: var(--radius-sm);
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-fast);
    z-index: var(--z-tooltip);
}

[data-tooltip]:hover::after {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(-8px);
}
/**
 * Icon System Styles
 * Professional SVG icons with consistent sizing and colors
 */

.icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    vertical-align: middle;
    line-height: 1;
}

.icon svg {
    width: 100%;
    height: 100%;
    display: block;
}

/* Size variants */
.icon-xs {
    width: 12px;
    height: 12px;
}

.icon-sm {
    width: 14px;
    height: 14px;
}

.icon {
    width: 16px;
    height: 16px;
}

.icon-md {
    width: 18px;
    height: 18px;
}

.icon-lg {
    width: 20px;
    height: 20px;
}

.icon-xl {
    width: 24px;
    height: 24px;
}

/* Color variants */
.icon-primary {
    color: var(--text-primary);
}

.icon-secondary {
    color: var(--text-secondary);
}

.icon-tertiary {
    color: var(--text-tertiary);
}

.icon-accent {
    color: var(--accent-primary);
}

.icon-success {
    color: var(--accent-success);
}

.icon-warning {
    color: var(--accent-warning);
}

.icon-error {
    color: var(--accent-error);
}

/* Button icons */
button .icon,
.btn .icon {
    margin-right: 6px;
}

button .icon:only-child,
.btn .icon:only-child {
    margin-right: 0;
}

/* Mode icon (larger for emphasis) */
.mode-icon {
    width: 24px;
    height: 24px;
    color: var(--accent-primary);
}

.mode-btn.active .mode-icon {
    color: var(--accent-primary);
}

/* Semantic icon */
.semantic-icon {
    width: 20px;
    height: 20px;
    color: var(--accent-primary);
}

/* Summary icon in accordions */
.summary-icon {
    width: 18px;
    height: 18px;
    color: var(--text-secondary);
    transition: color var(--transition-fast);
}

details[open] .summary-icon {
    color: var(--accent-primary);
}

/* Action icon */
.action-icon {
    width: 16px;
    height: 16px;
    color: var(--text-tertiary);
}

/* Label icon */
.label-icon {
    width: 14px;
    height: 14px;
    color: var(--text-tertiary);
    margin-right: 4px;
}

/* Icon in card titles */
.card-title .icon {
    width: 20px;
    height: 20px;
    margin-right: 8px;
    color: var(--accent-primary);
    vertical-align: text-bottom;
}

/* Icon animations */
.icon-spin {
    animation: icon-spin 1s linear infinite;
}

@keyframes icon-spin {
    from {
        transform: rotate(0deg);
    }

    to {
        transform: rotate(360deg);
    }
}

.icon-pulse {
    animation: icon-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes icon-pulse {

    0%,
    100% {
        opacity: 1;
    }

    50% {
        opacity: 0.5;
    }
}

/* Hover effects */
button:hover .icon,
.btn:hover .icon {
    transform: scale(1.05);
    transition: transform var(--transition-fast);
}

button:active .icon,
.btn:active .icon {
    transform: scale(0.95);
}

/* Icon in toggle buttons */
.mode-switch-btn .icon {
    width: 14px;
    height: 14px;
    margin-right: 4px;
}

.mode-switch-btn.active .icon {
    color: var(--accent-primary);
}
/* Custom Select Component Styles - Premium Dark Theme */
.custom-select {
    position: relative;
    flex: 1;
    font-size: 11px;
    user-select: none;
    min-width: 80px;
}

.custom-select-trigger {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 10px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.custom-select-trigger:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.2);
}

.custom-select.open .custom-select-trigger {
    border-color: var(--accent-primary, #6366f1);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    background: rgba(255, 255, 255, 0.1);
}

.custom-select .color-swatch {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    flex-shrink: 0;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

.custom-select .scale-value {
    flex: 1;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 11px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.9);
}

.custom-select .dropdown-arrow {
    font-size: 8px;
    color: rgba(255, 255, 255, 0.5);
    transition: transform 0.2s ease;
}

.custom-select.open .dropdown-arrow {
    transform: rotate(180deg);
    color: var(--accent-primary, #6366f1);
}

.custom-options {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: rgba(26, 27, 30, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    box-shadow:
        0 10px 40px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.05) inset;
    max-height: 240px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    padding: 4px;
}

.custom-select.open .custom-options {
    display: block;
    animation: dropdownFadeIn 0.15s ease-out;
}

@keyframes dropdownFadeIn {
    from {
        opacity: 0;
        transform: translateY(-8px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Custom scrollbar for options */
.custom-options::-webkit-scrollbar {
    width: 6px;
}

.custom-options::-webkit-scrollbar-track {
    background: transparent;
}

.custom-options::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 3px;
}

.custom-options::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.25);
}

.custom-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.15s ease;
    margin: 1px 0;
}

.custom-option:hover {
    background: rgba(255, 255, 255, 0.08);
}

.custom-option.selected {
    background: rgba(99, 102, 241, 0.15);
}

.custom-option.selected .scale-value {
    color: var(--accent-primary, #6366f1);
    font-weight: 600;
}

.custom-option .color-swatch {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    flex-shrink: 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.custom-option .scale-value {
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 12px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.85);
}

/* Token Row Styles for Dark Theme */
.token-row {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 14px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.06);
    transition: all 0.2s ease;
}

.token-row:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

.token-row-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.token-row .token-name {
    font-size: 12px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
}

.token-row .token-palette-badge {
    font-size: 9px;
    color: rgba(255, 255, 255, 0.4);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 2px 6px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.token-mode-row {
    display: flex;
    gap: 10px;
    align-items: center;
}

.token-row .mode-label {
    font-size: 10px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.5);
    width: 14px;
    flex-shrink: 0;
}

.token-row .color-preview {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    border: 2px solid rgba(255, 255, 255, 0.15);
    flex-shrink: 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Flash highlight animation for click-to-edit */
.token-row.highlight-flash {
    animation: tokenHighlight 1s ease-out;
}

@keyframes tokenHighlight {
    0% {
        background: rgba(99, 102, 241, 0.3);
        border-color: rgba(99, 102, 241, 0.5);
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
    }

    100% {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: none;
    }
}

    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">PirulinoColorete</div>
            <div class="sidebar-subtitle">DESIGN ARCHITECT</div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item active" data-section="scale">
                <span class="nav-item-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg></span>
                <span class="nav-item-label">Colors</span>
            </div>
            <div class="nav-item" data-section="measures">
                <span class="nav-item-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/><path d="m14.5 12.5 2-2"/><path d="m11.5 9.5 2-2"/><path d="m8.5 6.5 2-2"/><path d="m17.5 15.5 2-2"/></svg></span>
                <span class="nav-item-label">Measures</span>
            </div>
            <div class="nav-item" data-section="typography">
                <span class="nav-item-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></svg></span>
                <span class="nav-item-label">Typography</span>
            </div>
            <div class="nav-item" data-section="aliases">
                <span class="nav-item-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></span>
                <span class="nav-item-label">Aliases</span>
            </div>
            <div class="nav-item" data-section="theme">
                <span class="nav-item-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg></span>
                <span class="nav-item-label">Theme</span>
            </div>
            <div class="nav-item" data-section="collections">
                <span class="nav-item-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg></span>
                <span class="nav-item-label">Documentation</span>
            </div>
            <div class="nav-item" data-section="devtools">
                <span class="nav-item-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></span>
                <span class="nav-item-label">Dev's Tools</span>
            </div>
        </nav>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="content-header">
            <h1 id="page-title">Color Palettes</h1>
            <p id="page-description">Generate color scales for your design system.</p>
        </div>
        <div class="content-body">
            <div class="content-container">
                <!-- Sections -->
<div id="section-scale" class="section-content active">
    <!-- Step 1: Collection -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="section-title">1. Collection</div>
        <div class="input-group">
            <label>Target Collection</label>
            <select id="var-collection-select">
                <option value="" disabled selected>Select Collection...</option>
                <option value="NEW_COLLECTION">+ Create New Collection...</option>
            </select>
        </div>
        <input type="text" id="var-collection-custom" placeholder="Enter new collection name" class="new-field-input"
            style="display: none; margin-top: var(--space-2);">
    </div>

    <!-- Step 2: Group -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="section-title">2. Group (Optional)</div>
        <div class="input-group">
            <label>Target Group</label>
            <select id="var-group-select">
                <option value="">(Root / No Group)</option>
                <option value="NEW_GROUP">+ New Group...</option>
            </select>
        </div>
        <input type="text" id="var-group-custom" placeholder="Enter new group name" class="new-field-input"
            style="display: none; margin-top: var(--space-2);">
    </div>

    <!-- Existing Palettes -->
    <div id="existing-palettes-container" class="card" style="margin-bottom: var(--space-4); display: none;">
        <div class="flex-between" style="margin-bottom: var(--space-3);">
            <div class="section-title" style="margin: 0;">Existing Palettes</div>
            <span class="badge" id="existing-palettes-count">0 palettes</span>
        </div>
        <div id="existing-palettes-list" class="existing-palettes-grid"></div>
    </div>

    <!-- Step 3: Add Colors -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="section-title">3. Add Colors</div>

        <div class="color-input-group">
            <div class="flex-row" style="margin-bottom: var(--space-3);">
                <div style="flex: 1;">
                    <label>Color Name</label>
                    <input type="text" id="new-color-name" placeholder="e.g. Primary, Brand, Success">
                </div>
                <div style="flex: 1;">
                    <label>Base Color</label>
                    <div style="display: flex; gap: var(--space-2);">
                        <input type="text" id="new-color-hex" placeholder="#6366f1"
                            style="flex: 1; font-family: 'SF Mono', Monaco, monospace;">
                        <div id="new-color-swatch" class="color-preview-swatch"></div>
                    </div>
                </div>
            </div>

            <button id="add-color-btn" class="secondary" style="width: 100%;">
                <span>+</span> Add to Queue
            </button>
            <p id="add-error" class="error-message" style="display: none;">Invalid Input</p>
        </div>
    </div>

    <!-- Color Queue -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="flex-between" style="margin-bottom: var(--space-4);">
            <div class="section-title" style="margin: 0;">Colors Queue</div>
            <span class="badge" id="queue-count-badge">0 colors</span>
        </div>

        <div id="color-queue" class="color-queue-list">
            <div id="empty-queue-msg" class="empty-state">
                <span class="empty-icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                    </svg></span>
                <p>No colors added yet</p>
                <span class="empty-hint">Add colors above to get started</span>
            </div>
        </div>

        <button id="preview-scale-btn" class="primary big-btn" disabled
            style="width: 100%; margin-top: var(--space-4);">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                    <circle cx="12" cy="12" r="3" />
                </svg></span> Preview Palettes
        </button>
    </div>

    <!-- Preview Section -->
    <div id="scale-preview-container" class="card preview-card" style="display: none;">
        <div class="section-title">Palette Preview</div>
        <div id="scale-list" class="scale-preview-grid"></div>

        <div id="creation-progress" style="display: none; margin-top: var(--space-6); margin-bottom: var(--space-2);">
            <div
                style="display: flex; justify-content: space-between; margin-bottom: var(--space-2); font-size: var(--font-size-sm); color: var(--text-secondary);">
                <span id="progress-message">Initializing...</span>
                <span id="progress-percent">0%</span>
            </div>
            <div
                style="height: 6px; background: var(--bg-surface-active); border-radius: var(--radius-full); overflow: hidden;">
                <div id="progress-bar-fill"
                    style="height: 100%; width: 0%; background: var(--accent-primary); transition: width 0.3s ease;">
                </div>
            </div>
        </div>

        <button id="create-vars-btn" class="primary big-btn" style="width: 100%; margin-top: var(--space-4);">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
                    <path d="M5 3v4" />
                    <path d="M19 17v4" />
                    <path d="M3 5h4" />
                    <path d="M17 19h4" />
                </svg></span> Create All Variables
        </button>
    </div>
</div>

<style>
    /* Color Section Specific Styles */
    .color-preview-swatch {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-md);
        background: var(--bg-surface-hover);
        border: 1px solid var(--border-default);
        transition: all var(--transition-fast);
        cursor: pointer;
    }

    .color-preview-swatch:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-md);
    }

    .new-field-input {
        background: var(--accent-primary-subtle) !important;
        border-color: var(--accent-primary) !important;
    }

    .error-message {
        color: var(--accent-error);
        font-size: var(--font-size-xs);
        margin-top: var(--space-2);
    }

    .existing-palettes-grid {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }

    .color-queue-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
        min-height: 60px;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--space-8);
        color: var(--text-tertiary);
        text-align: center;
    }

    .empty-icon {
        font-size: 32px;
        margin-bottom: var(--space-3);
        opacity: 0.5;
    }

    .empty-state p {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        margin-bottom: var(--space-1);
    }

    .empty-hint {
        font-size: var(--font-size-xs);
        color: var(--text-quaternary);
    }

    .color-queue-item {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3);
        background: var(--bg-surface-hover);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-subtle);
        transition: all var(--transition-fast);
    }

    .color-queue-item:hover {
        border-color: var(--border-default);
        background: var(--bg-surface-active);
    }

    .color-queue-item .swatch {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-default);
    }

    .color-queue-item .info {
        flex: 1;
    }

    .color-queue-item .name {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--text-primary);
    }

    .color-queue-item .hex {
        font-size: var(--font-size-xs);
        font-family: 'SF Mono', Monaco, monospace;
        color: var(--text-tertiary);
    }

    .color-queue-item .remove-btn {
        padding: var(--space-1);
        background: transparent;
        border: none;
        color: var(--text-tertiary);
        cursor: pointer;
        border-radius: var(--radius-sm);
        transition: all var(--transition-fast);
    }

    .color-queue-item .remove-btn:hover {
        background: var(--accent-error-subtle);
        color: var(--accent-error);
    }

    .scale-preview-grid {
        display: flex;
        flex-direction: column;
        gap: var(--space-6);
    }

    .scale-preview-item {
        background: var(--bg-surface-hover);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        border: 1px solid var(--border-subtle);
    }

    .scale-preview-item .palette-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-3);
    }

    .scale-preview-item .palette-name {
        font-size: var(--font-size-md);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
    }

    .scale-preview-item .palette-grid {
        display: grid;
        grid-template-columns: repeat(11, 1fr);
        gap: var(--space-1);
    }

    .scale-preview-item .palette-step {
        aspect-ratio: 1;
        border-radius: var(--radius-sm);
        position: relative;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .scale-preview-item .palette-step:hover {
        transform: scale(1.1);
        z-index: 10;
        box-shadow: var(--shadow-lg);
    }

    .scale-preview-item .step-label {
        position: absolute;
        bottom: 2px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 9px;
        font-weight: var(--font-weight-semibold);
        opacity: 0;
        transition: opacity var(--transition-fast);
    }

    .scale-preview-item .palette-step:hover .step-label {
        opacity: 1;
    }

    .preview-card {
        border: 1px solid var(--accent-primary);
        background: linear-gradient(145deg, var(--accent-primary-muted), var(--bg-surface));
    }
</style>
<div id="section-measures" class="section-content">
    <!-- Step 1: Values -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="section-title">1. Define Values</div>

        <div class="input-group">
            <label>Values (comma separated, in pixels)</label>
            <textarea id="measure-values" class="measure-textarea"
                rows="3">0.5, 1, 2, 4, 8, 12, 16, 20, 24, 32, 40, 48, 64, 80, 96</textarea>
            <p class="input-hint">Standard spacing scale. Edit to customize your system.</p>
        </div>

        <div class="measure-presets">
            <span class="preset-label">Quick presets:</span>
            <button class="preset-btn" data-preset="default">Default</button>
            <button class="preset-btn" data-preset="tailwind">Tailwind</button>
            <button class="preset-btn" data-preset="material">Material</button>
            <button class="preset-btn" data-preset="fibonacci">Fibonacci</button>
            <button class="preset-btn" data-preset="golden">Golden (Ï)</button>
        </div>

        <button id="preview-measures-btn" class="secondary" style="width: 100%; margin-top: var(--space-4);">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                    <circle cx="12" cy="12" r="3" />
                </svg></span> Preview Measures
        </button>
    </div>

    <!-- Preview Section -->
    <div id="measure-preview-container" class="card" style="display: none; margin-bottom: var(--space-4);">
        <div class="section-title">2. Preview</div>

        <div id="measure-list" class="measure-preview-grid"></div>
    </div>

    <!-- Configuration -->
    <div id="measure-config-container" class="card" style="display: none;">
        <div class="section-title">3. Configuration</div>

        <div class="flex-row" style="margin-bottom: var(--space-4);">
            <div>
                <label>Target Collection</label>
                <select id="measure-collection-select">
                    <option value="" disabled selected>Select Collection...</option>
                </select>
            </div>
            <div>
                <label>Target Group</label>
                <select id="measure-group-select">
                    <option value="">(Root / No Group)</option>
                    <option value="NEW_GROUP">+ New Group...</option>
                </select>
            </div>
        </div>

        <input type="text" id="measure-group-custom" placeholder="e.g. Spacing" class="new-field-input"
            style="display: none; margin-bottom: var(--space-4);">

        <button id="create-measures-btn" class="primary big-btn" style="width: 100%;">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
                    <path d="M5 3v4" />
                    <path d="M19 17v4" />
                    <path d="M3 5h4" />
                    <path d="M17 19h4" />
                </svg></span> Create Variables
        </button>
    </div>
</div>

<style>
    /* Measures Section Specific Styles */
    .measure-textarea {
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        font-size: var(--font-size-sm);
        resize: vertical;
        min-height: 80px;
    }

    .input-hint {
        font-size: var(--font-size-xs);
        color: var(--text-quaternary);
        margin-top: var(--space-2);
    }

    .measure-presets {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-top: var(--space-3);
        padding-top: var(--space-3);
        border-top: 1px solid var(--border-subtle);
    }

    .preset-label {
        font-size: var(--font-size-xs);
        color: var(--text-tertiary);
    }

    .preset-btn {
        padding: var(--space-1) var(--space-3);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        background: var(--bg-surface-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-full);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .preset-btn:hover {
        background: var(--accent-primary-subtle);
        border-color: var(--accent-primary);
        color: var(--accent-primary-hover);
    }

    .measure-preview-grid {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        max-height: 200px;
        overflow-y: auto;
        padding: var(--space-2);
    }

    .measure-item {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
        background: var(--bg-surface-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        font-family: 'SF Mono', Monaco, monospace;
        color: var(--text-primary);
        transition: all var(--transition-fast);
    }

    .measure-item:hover {
        border-color: var(--accent-primary);
        background: var(--accent-primary-subtle);
    }

    .measure-item .measure-bar {
        height: 6px;
        background: var(--gradient-accent);
        border-radius: var(--radius-full);
        min-width: 20px;
        max-width: 100px;
    }
</style>
<div id="section-typography" class="section-content">
    <!-- Step 1: Font Families -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="section-title">1. Font Families</div>

        <div class="font-selection-grid">
            <div class="font-card">
                <div class="font-card-header">
                    <span class="font-card-icon">Aa</span>
                    <span class="font-card-label">Heading</span>
                </div>
                <select id="font-heading" class="font-select">
                    <option value="" disabled selected>Loading fonts...</option>
                </select>
            </div>

            <div class="font-card">
                <div class="font-card-header">
                    <span class="font-card-icon">Tt</span>
                    <span class="font-card-label">Body</span>
                </div>
                <select id="font-body" class="font-select">
                    <option value="" disabled selected>Loading fonts...</option>
                </select>
            </div>

            <div class="font-card">
                <div class="font-card-header">
                    <span class="font-card-icon">{}</span>
                    <span class="font-card-label">Code / Mono</span>
                </div>
                <select id="font-code" class="font-select">
                    <option value="" disabled selected>Loading fonts...</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Step 2: Scales -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="section-title">2. Type Scales</div>

        <div class="scale-inputs">
            <div class="scale-input-group">
                <label>
                    <span class="label-icon">âï¸</span>
                    Font Weights
                </label>
                <textarea id="typo-weights" class="scale-textarea"
                    rows="2">100, 200, 300, 400, 500, 600, 700, 800, 900</textarea>
            </div>

            <div class="scale-input-group">
                <label>
                    <span class="label-icon">âï¸</span>
                    Letter Spacing (%)
                </label>
                <textarea id="typo-spacing" class="scale-textarea" rows="2">-2, -1, 0, 1, 2, 4, 8, 10</textarea>
            </div>

            <div class="scale-input-group">
                <label>
                    <span class="label-icon">ð</span>
                    Font Sizes (px)
                </label>
                <textarea id="typo-sizes" class="scale-textarea"
                    rows="2">8, 10, 12, 14, 16, 18, 20, 24, 30, 36, 48, 60, 72</textarea>
                <p class="input-hint">Maps to semantic names: 3xs, 2xs, xs, sm, base, lg, xl, 2xl, 3xl, 4xl, 5xl, 6xl,
                    7xl</p>
            </div>
        </div>
    </div>

    <!-- Step 3: Target -->
    <div class="card">
        <div class="section-title">3. Target Collection</div>

        <div class="flex-row" style="margin-bottom: var(--space-4);">
            <div>
                <label>Collection</label>
                <select id="typo-collection-select">
                    <option value="" disabled selected>Select Collection...</option>
                </select>
            </div>
            <div>
                <label>Group</label>
                <select id="typo-group-select">
                    <option value="">(Root / No Group)</option>
                    <option value="NEW_GROUP">+ New Group...</option>
                </select>
            </div>
        </div>

        <input type="text" id="typo-group-custom" placeholder="e.g. Typography" value="Typography"
            class="new-field-input" style="display: none; margin-bottom: var(--space-4);">

        <button id="create-typo-btn" class="primary big-btn" style="width: 100%;">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
                    <path d="M5 3v4" />
                    <path d="M19 17v4" />
                    <path d="M3 5h4" />
                    <path d="M17 19h4" />
                </svg></span> Create Typography Variables
        </button>
    </div>
</div>

<style>
    /* Typography Section Specific Styles */
    .font-selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
    }

    .font-card {
        background: var(--bg-surface-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        transition: all var(--transition-fast);
    }

    .font-card:hover {
        border-color: var(--border-default);
    }

    .font-card-header {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-bottom: var(--space-3);
    }

    .font-card-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--gradient-accent);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-bold);
        color: white;
    }

    .font-card-label {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
    }

    .scale-inputs {
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
    }

    .scale-input-group label {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .label-icon {
        font-size: var(--font-size-md);
    }

    .scale-textarea {
        font-family: 'SF Mono', Monaco, monospace;
        font-size: var(--font-size-sm);
        resize: vertical;
    }
</style>
<div id="section-aliases" class="section-content">
    <!-- Mode Toggle -->
    <div class="tab-toggle" style="margin-bottom: var(--space-6);">
        <button id="mode-tokens" class="toggle-btn active">Create Tokens</button>
        <button id="mode-styles" class="toggle-btn">Figma Styles</button>
    </div>

    <!-- ==================== MODE: CREATE TOKENS ==================== -->
    <div id="aliases-mode-tokens">
        <!-- Step 1: Source Collection -->
        <div class="card" style="margin-bottom: var(--space-4);">
            <div class="section-title">1. Source Collection</div>
            <p class="step-description">Select the collection containing your primitive measures and typography
                variables.</p>
            <div class="form-group">
                <label>Collection</label>
                <select id="alias-source-collection">
                    <option value="" disabled selected>Select Collection...</option>
                </select>
            </div>
            <div class="source-grid">
                <div class="form-group">
                    <label>Measures Group</label>
                    <select id="alias-measures-group" disabled>
                        <option value="" disabled selected>Select Measures Group...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Typography Group</label>
                    <select id="alias-typo-group" disabled>
                        <option value="" disabled selected>Select Typography Group...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Step 2: Target -->
        <div class="card" style="margin-bottom: var(--space-4);">
            <div class="section-title">2. Target Collection</div>
            <p class="step-description">Name for the new semantic tokens collection.</p>
            <div class="form-group">
                <label>Collection Name</label>
                <input type="text" id="alias-target-name" placeholder="Tokens" value="Tokens">
            </div>
        </div>

        <!-- Create Button -->
        <button id="create-aliases-btn" class="primary big-btn" style="width: 100%;">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
                </svg></span> Create Semantic Tokens
        </button>
    </div>

    <!-- ==================== MODE: FIGMA STYLES ==================== -->
    <div id="aliases-mode-styles" style="display: none;">
        <!-- Step 1: Select Source -->
        <div class="card" style="margin-bottom: var(--space-4);">
            <div class="section-title">1. Select Source Collection</div>
            <p class="step-description">Choose a collection with your design tokens. We'll automatically detect what
                styles can be created.</p>

            <div class="form-group">
                <label>Collection</label>
                <select id="styles-source-collection">
                    <option value="" disabled selected>Select Collection...</option>
                </select>
            </div>
        </div>

        <!-- Step 2: Configuration (Hidden) -->
        <div class="card" style="margin-bottom: var(--space-4); display: none;">
            <div class="section-title">2. Style Name Prefix</div>
            <div class="form-group">
                <label>Prefix</label>
                <input type="text" id="styles-prefix" placeholder="Tokens" value="">
                <span class="input-hint">Styles will be named: Prefix/H1 / Bold, etc.</span>
            </div>
        </div>

        <!-- Scan Button -->
        <button id="scan-styles-btn" class="secondary" disabled style="width: 100%; margin-bottom: var(--space-4);">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.3-4.3" />
                </svg></span> Scan Collection
        </button>

        <!-- No Styles Warning -->
        <div id="styles-no-vars-warning" class="warning-card" style="display: none;">
            <div class="warning-icon">â ï¸</div>
            <div class="warning-content">
                <strong>No compatible variables found</strong>
                <p>The selected collection doesn't contain variables that can be converted to Figma styles.</p>
                <button id="go-to-tokens-btn" class="secondary btn-sm" style="margin-top: var(--space-3);">
                    <span class="icon">â</span> Go to Create Tokens
                </button>
            </div>
        </div>

        <!-- Styles Categories -->
        <div id="styles-categories" style="display: none;">
            <!-- Text Styles -->
            <div id="text-styles-section" class="styles-section" style="display: none;">
                <div class="styles-section-header">
                    <div class="styles-section-info">
                        <span class="styles-section-icon">ð</span>
                        <div>
                            <strong>Text Styles</strong>
                            <span class="styles-section-count">0 styles</span>
                        </div>
                    </div>
                    <div class="styles-section-actions">
                        <button class="ghost btn-sm select-all-text">Select All</button>
                        <button class="ghost btn-sm deselect-all-text">Deselect</button>
                    </div>
                </div>
                <div id="text-styles-list" class="styles-list"></div>
            </div>

            <!-- Effect Styles (Shadows) -->
            <div id="effect-styles-section" class="styles-section" style="display: none;">
                <div class="styles-section-header">
                    <div class="styles-section-info">
                        <span class="styles-section-icon">ð</span>
                        <div>
                            <strong>Effect Styles (Shadows)</strong>
                            <span class="styles-section-count">0 styles</span>
                        </div>
                    </div>
                    <div class="styles-section-actions">
                        <button class="ghost btn-sm select-all-effects">Select All</button>
                        <button class="ghost btn-sm deselect-all-effects">Deselect</button>
                    </div>
                </div>
                <div id="effect-styles-list" class="styles-list"></div>
            </div>
        </div>

        <!-- Create Button -->
        <button id="create-styles-btn" class="primary big-btn" disabled
            style="width: 100%; margin-top: var(--space-4); display: none;">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" />
                    <path d="m9 12 2 2 4-4" />
                </svg></span> Create Selected Styles (<span id="selected-styles-count">0</span>)
        </button>
    </div>
</div>

<style>
    /* Aliases Section Specific Styles */
    .step-description {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        margin-bottom: var(--space-4);
    }

    .input-hint {
        display: block;
        font-size: var(--font-size-xs);
        color: var(--text-tertiary);
        margin-top: var(--space-2);
    }

    .source-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
    }

    .warning-card {
        display: flex;
        gap: var(--space-4);
        padding: var(--space-4);
        background: var(--accent-warning-subtle);
        border: 1px solid var(--accent-warning);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-4);
    }

    .warning-icon {
        font-size: 24px;
        flex-shrink: 0;
    }

    .warning-content {
        flex: 1;
    }

    .warning-content strong {
        display: block;
        color: var(--text-primary);
        margin-bottom: var(--space-1);
    }

    .warning-content p {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        margin: 0;
    }

    /* Styles Sections */
    .styles-section {
        background: var(--bg-surface-hover);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin-bottom: var(--space-4);
    }

    .styles-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-3);
        padding-bottom: var(--space-3);
        border-bottom: 1px solid var(--border-subtle);
    }

    .styles-section-info {
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }

    .styles-section-icon {
        font-size: 20px;
    }

    .styles-section-info strong {
        display: block;
        font-size: var(--font-size-sm);
        color: var(--text-primary);
    }

    .styles-section-count {
        font-size: var(--font-size-xs);
        color: var(--text-tertiary);
    }

    .styles-section-actions {
        display: flex;
        gap: var(--space-2);
    }

    .styles-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
        max-height: 600px;
        overflow-y: auto;
    }

    .style-item {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3);
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
    }

    .style-item:hover {
        border-color: var(--border-default);
    }

    .style-item input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: var(--accent-primary);
        flex-shrink: 0;
    }

    .style-item .style-info {
        flex: 1;
        min-width: 0;
    }

    .style-item .style-name {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--text-primary);
        display: block;
    }

    .style-item .style-details {
        font-size: var(--font-size-xs);
        color: var(--text-tertiary);
    }

    .style-item .style-preview {
        font-family: 'Inter', sans-serif;
        color: var(--text-secondary);
        white-space: nowrap;
    }

    .style-item .shadow-preview {
        width: 32px;
        height: 32px;
        background: var(--bg-surface);
        border-radius: var(--radius-sm);
    }
</style>
<div class="section-content" id="section-theme">
    <!-- Mode Toggle -->
    <div class="tab-toggle" style="margin-bottom: var(--space-6);">
        <button id="mode-generate" class="toggle-btn active">Generate New</button>
        <button id="mode-edit" class="toggle-btn">Edit Existing</button>
    </div>

    <!-- Mode: Generate -->
    <div id="theme-mode-generate">
        <!-- Theme Name -->
        <div class="card" style="margin-bottom: var(--space-4);">
            <div class="section-title">Theme Name</div>
            <div class="form-group">
                <input type="text" id="theme-name" value="Theme" placeholder="e.g. My Product Theme">
            </div>
        </div>

        <!-- Step 1: Source -->
        <div class="card" style="margin-bottom: var(--space-4);">
            <div class="section-title">1. Source Palettes</div>
            <p class="step-description">Select where your color palettes are stored</p>

            <div class="flex-row">
                <div class="form-group">
                    <label>Collection</label>
                    <select id="theme-source-collection">
                        <option value="" disabled selected>Select collection...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Group (Optional)</label>
                    <select id="theme-source-group" disabled>
                        <option value="">All groups</option>
                    </select>
                </div>
            </div>

            <button id="load-palettes-btn" class="secondary" style="width: 100%; margin-top: var(--space-3);">
                <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path
                            d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z" />
                    </svg></span> Load Palettes
            </button>
        </div>
    </div>

    <!-- Mode: Edit -->
    <div id="theme-mode-edit" style="display: none;">
        <div class="card" style="margin-bottom: var(--space-4);">
            <div class="section-title">Select Theme Collection</div>
            <p class="step-description">Choose an existing theme collection to edit</p>

            <div class="flex-row">
                <div class="form-group">
                    <label>Theme Collection</label>
                    <select id="theme-edit-collection">
                        <option value="" disabled selected>Select theme...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Theme Group (Optional)</label>
                    <select id="theme-edit-group" disabled>
                        <option value="">(Root)</option>
                    </select>
                </div>
            </div>

            <button id="load-existing-theme-btn" class="primary" style="width: 100%; margin-top: var(--space-3);">
                <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" x2="8" y1="13" y2="13" />
                        <line x1="16" x2="8" y1="17" y2="17" />
                        <line x1="10" x2="8" y1="9" y2="9" />
                    </svg></span> Load Theme Tokens
            </button>
        </div>
    </div>

    <!-- Step 2: Semantic Mapping -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="section-title">2. Semantic Mapping</div>
        <p class="step-description">Map your palettes to semantic roles</p>

        <div class="semantic-grid">
            <div class="semantic-card primary-semantic">
                <span class="semantic-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="13.5" cy="6.5" r=".5" />
                        <circle cx="17.5" cy="10.5" r=".5" />
                        <circle cx="8.5" cy="7.5" r=".5" />
                        <circle cx="6.5" cy="12.5" r=".5" />
                        <path
                            d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z" />
                    </svg></span>
                <span class="semantic-label">Accent / Brand</span>
                <select id="theme-accent-palette" disabled></select>
            </div>
            <div class="semantic-card neutral-semantic">
                <span class="semantic-icon">â¬</span>
                <span class="semantic-label">Neutral / Surface</span>
                <select id="theme-neutral-palette" disabled></select>
            </div>
        </div>

        <div class="sub-label">Status Palettes (Optional)</div>

        <div class="status-grid">
            <div class="status-card success">
                <span class="status-indicator" style="background: #10b981;"></span>
                <span class="status-label">Success</span>
                <select id="theme-success-palette" disabled></select>
            </div>
            <div class="status-card warning">
                <span class="status-indicator" style="background: #f59e0b;"></span>
                <span class="status-label">Warning</span>
                <select id="theme-warning-palette" disabled></select>
            </div>
            <div class="status-card error">
                <span class="status-indicator" style="background: #ef4444;"></span>
                <span class="status-label">Error</span>
                <select id="theme-error-palette" disabled></select>
            </div>
        </div>
    </div>

    <!-- Step 3: Preview & Editor -->
    <div id="theme-preview-section" class="card preview-section" style="display: none;">
        <div class="preview-header">
            <div class="section-title" style="margin: 0;">3. Theme Editor</div>
            <div class="theme-mode-switch">
                <button id="view-light" class="mode-switch-btn active">
                    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="4" />
                            <path d="M12 2v2" />
                            <path d="M12 20v2" />
                            <path d="m4.93 4.93 1.41 1.41" />
                            <path d="m17.66 17.66 1.41 1.41" />
                            <path d="M2 12h2" />
                            <path d="M20 12h2" />
                            <path d="m6.34 17.66-1.41 1.41" />
                            <path d="m19.07 4.93-1.41 1.41" />
                        </svg></span> Light
                </button>
                <button id="view-dark" class="mode-switch-btn">
                    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
                        </svg></span> Dark
                </button>
            </div>
        </div>

        <!-- Live Preview -->
        <div id="theme-preview-board" class="theme-preview-board">
            <!-- Rendered via JS -->
        </div>

        <!-- Token Editor -->
        <div class="editor-accordion">
            <details open>
                <summary>
                    <span class="summary-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="12 2 2 7 12 12 22 7 12 2" />
                            <polyline points="2 17 12 22 22 17" />
                            <polyline points="2 12 12 17 22 12" />
                        </svg></span>
                    Background & Surface
                </summary>
                <div class="token-grid" id="editor-bg"></div>
            </details>
            <details>
                <summary>
                    <span class="summary-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="4 7 4 4 20 4 20 7" />
                            <line x1="9" x2="15" y1="20" y2="20" />
                            <line x1="12" x2="12" y1="4" y2="20" />
                        </svg></span>
                    Text & Content
                </summary>
                <div class="token-grid" id="editor-text"></div>
            </details>
            <details>
                <summary>
                    <span class="summary-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="m3 3 7.07 16.97 2.51-7.39 7.39-2.51L3 3z" />
                            <path d="m13 13 6 6" />
                        </svg></span>
                    Actions & Buttons
                </summary>
                <div class="token-grid" id="editor-action"></div>
            </details>
            <details>
                <summary>
                    <span class="summary-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
                            <line x1="3" x2="21" y1="12" y2="12" />
                            <line x1="12" x2="12" y1="3" y2="21" />
                        </svg></span>
                    Borders & Dividers
                </summary>
                <div class="token-grid" id="editor-border"></div>
            </details>
            <details>
                <summary>
                    <span class="summary-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                        </svg></span>
                    Status & Feedback
                </summary>
                <div class="token-grid" id="editor-status"></div>
            </details>
        </div>

        <div class="separator"></div>

        <button id="create-theme-btn" class="primary big-btn" style="width: 100%;">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
                    <path d="M5 3v4" />
                    <path d="M19 17v4" />
                    <path d="M3 5h4" />
                    <path d="M17 19h4" />
                </svg></span> Create Variables Collection
        </button>
    </div>
</div>

<style>
    /* Theme Section Specific Styles */
    .step-description {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        margin-bottom: var(--space-4);
    }

    .semantic-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }

    .semantic-card {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
        padding: var(--space-4);
        background: var(--bg-surface-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
    }

    .semantic-icon {
        font-size: 20px;
    }

    .semantic-label {
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
    }

    .status-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-3);
    }

    .status-card {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
        padding: var(--space-3);
        background: var(--bg-surface-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: var(--radius-full);
    }

    .status-label {
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        color: var(--text-secondary);
    }

    .preview-section {
        border: 1px solid var(--accent-primary);
        background: linear-gradient(145deg, var(--accent-primary-muted), var(--bg-surface));
    }

    .preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-4);
    }

    .theme-mode-switch {
        display: flex;
        gap: var(--space-1);
        padding: var(--space-1);
        background: var(--bg-surface);
        border-radius: var(--radius-lg);
    }

    .mode-switch-btn {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-2) var(--space-3);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        background: transparent;
        border: none;
        border-radius: var(--radius-md);
        color: var(--text-tertiary);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .mode-switch-btn:hover {
        color: var(--text-secondary);
    }

    .mode-switch-btn.active {
        background: var(--bg-surface-active);
        color: var(--text-primary);
    }

    .theme-preview-board {
        min-height: 250px;
        padding: var(--space-6);
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-6);
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-4);
        align-content: flex-start;
        transition: all var(--transition-normal);
    }

    .editor-accordion details summary {
        gap: var(--space-2);
    }

    .summary-icon {
        font-size: var(--font-size-md);
    }
</style>
<div id="section-collections" class="section-content">
    <!-- Collection Selector -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="section-title">1. Select Collection</div>

        <div class="flex-row">
            <div class="form-group">
                <label>Collection</label>
                <select id="collection-select">
                    <option value="" disabled selected>Loading collections...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Group (Optional)</label>
                <select id="group-select" disabled>
                    <option value="">All Groups</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Text Styles Selector -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="section-title">2. Text Styles (Optional)</div>

        <div class="form-group">
            <label>Title Style</label>
            <select id="title-style-select">
                <option value="">Use default font</option>
            </select>
        </div>

        <div class="form-group">
            <label>Label Style</label>
            <select id="label-style-select">
                <option value="">Use default font</option>
            </select>
        </div>

        <div class="form-group">
            <label>Body Style</label>
            <select id="body-style-select">
                <option value="">Use default font</option>
            </select>
        </div>

        <div class="form-group">
            <label>Code Style (for technical values)</label>
            <select id="code-style-select">
                <option value="">Use default font</option>
            </select>
        </div>

        <p class="hint-text"
            style="margin-top: var(--space-2); font-size: var(--font-size-xs); color: var(--text-tertiary);">
            ð¡ Create text styles in the Typography section first, or use default fonts
        </p>
    </div>

    <!-- Actions -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="section-title">3. Generate</div>

        <div class="action-buttons">
            <button id="convert-btn" class="action-card">
                <span class="action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                    </svg></span>
                <div class="action-info">
                    <span class="action-title">List in UI</span>
                    <span class="action-desc">Preview variables below</span>
                </div>
            </button>
            <button id="generate-btn" class="action-card primary">
                <span class="action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="13.5" cy="6.5" r=".5" />
                        <circle cx="17.5" cy="10.5" r=".5" />
                        <circle cx="8.5" cy="7.5" r=".5" />
                        <circle cx="6.5" cy="12.5" r=".5" />
                        <path
                            d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z" />
                    </svg></span>
                <div class="action-info">
                    <span class="action-title">Generate on Canvas</span>
                    <span class="action-desc">Create visual documentation</span>
                </div>
            </button>
        </div>
    </div>

    <!-- Results -->
    <div class="card">
        <div class="section-title">Preview</div>
        <div id="result" class="result-container">
            <div class="empty-state">
                <span class="empty-icon"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path
                            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                        <polyline points="3.29 7 12 12 20.71 7" />
                        <line x1="12" x2="12" y1="22" y2="12" />
                    </svg></span>
                <p>Select a collection to see variables</p>
                <span class="empty-hint">Choose a collection and group above, then click "List in UI"</span>
            </div>
        </div>
    </div>
</div>

<style>
    /* Collections Section Specific Styles */
    .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-3);
    }

    .action-card {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-4);
        background: rgba(255, 255, 255, 0.08);
        border: 2px solid rgba(255, 255, 255, 0.15);
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: all var(--transition-fast);
        text-align: left;
    }

    .action-card:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .action-card.primary {
        background: var(--gradient-accent);
        border-color: transparent;
        color: white;
    }

    .action-card.primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg), var(--shadow-glow);
    }

    .action-icon {
        font-size: 24px;
        color: rgba(255, 255, 255, 0.7);
    }

    .action-icon {
        font-size: 24px;
        color: rgba(255, 255, 255, 0.9);
    }

    .action-card.primary .action-icon {
        color: white;
    }

    .action-info {
        display: flex;
        flex-direction: column;
    }

    .action-title {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
        color: rgba(255, 255, 255, 0.95);
    }

    .action-card.primary .action-title {
        color: white;
    }

    .action-desc {
        font-size: var(--font-size-xs);
        color: rgba(255, 255, 255, 0.65);
    }

    .action-card.primary .action-desc {
        color: rgba(255, 255, 255, 0.8);
    }

    .result-container {
        min-height: 200px;
        padding: var(--space-4);
        background: var(--bg-surface-hover);
        border-radius: var(--radius-lg);
        overflow-y: auto;
        max-height: 400px;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--space-12);
        color: var(--text-tertiary);
        text-align: center;
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: var(--space-4);
        opacity: 0.4;
    }

    .empty-state p {
        font-size: var(--font-size-md);
        font-weight: var(--font-weight-medium);
        margin-bottom: var(--space-2);
        color: var(--text-secondary);
    }

    .empty-hint {
        font-size: var(--font-size-sm);
        color: var(--text-quaternary);
    }

    /* Variable List Styles */
    .variable-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }

    .variable-item {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3);
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
    }

    .variable-item:hover {
        border-color: var(--border-default);
    }

    .variable-swatch {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-default);
    }

    .variable-info {
        flex: 1;
    }

    .variable-name {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--text-primary);
    }

    .variable-value {
        font-size: var(--font-size-xs);
        font-family: 'SF Mono', Monaco, monospace;
        color: var(--text-tertiary);
    }

    /* Palette visualization styles */
    .palette-card {
        margin-bottom: var(--space-4);
        background: var(--bg-surface-hover);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        border: 1px solid var(--border-subtle);
    }

    .palette-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-3);
    }

    .palette-name {
        font-size: var(--font-size-md);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
    }

    .palette-count {
        font-size: var(--font-size-xs);
        color: var(--text-tertiary);
        background: var(--bg-surface-active);
        padding: 2px 8px;
        border-radius: var(--radius-sm);
    }

    .palette-swatches {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: var(--space-2);
    }

    .color-swatch {
        aspect-ratio: 1;
        border-radius: var(--radius-md);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: var(--space-2);
        cursor: pointer;
        transition: all var(--transition-fast);
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .color-swatch:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 10;
    }

    .swatch-label {
        font-size: 10px;
        font-weight: var(--font-weight-semibold);
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .variable-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-2) var(--space-3);
        background: var(--bg-surface-hover);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-2);
    }

    .variable-row .variable-name {
        font-size: var(--font-size-sm);
        color: var(--text-primary);
    }

    .variable-row .variable-type {
        font-size: var(--font-size-xs);
        color: var(--text-tertiary);
        font-family: 'SF Mono', Monaco, monospace;
    }
</style>
<div id="section-devtools" class="section-content">
    <!-- Step 1: Select Source -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="section-title">1. Select Source</div>
        <div class="flex-row">
            <div class="form-group">
                <label>Collection</label>
                <select id="devtools-collection">
                    <option value="" disabled selected>Select collection...</option>
                    <option value="ALL">All Collections</option>
                </select>
            </div>
            <div class="form-group">
                <label>Group (Optional)</label>
                <select id="devtools-group" disabled>
                    <option value="">All Groups</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Step 2: Export Format -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="section-title">2. Export Format</div>
        <div class="format-grid">
            <label class="format-option active">
                <input type="radio" name="export-format" value="json" checked>
                <span class="format-icon">{ }</span>
                <span class="format-name">JSON</span>
                <span class="format-desc">Design Tokens</span>
            </label>
            <label class="format-option">
                <input type="radio" name="export-format" value="css">
                <span class="format-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m18 16 4-4-4-4" />
                        <path d="m6 8-4 4 4 4" />
                        <path d="m14.5 4-5 16" />
                    </svg>
                </span>
                <span class="format-name">CSS</span>
                <span class="format-desc">Custom Properties</span>
            </label>
            <label class="format-option">
                <input type="radio" name="export-format" value="scss">
                <span class="format-icon">$</span>
                <span class="format-name">SCSS</span>
                <span class="format-desc">Variables</span>
            </label>
            <label class="format-option">
                <input type="radio" name="export-format" value="tailwind">
                <span class="format-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                        fill="currentColor">
                        <path
                            d="M12.001 4.8c-3.2 0-5.2 1.6-6 4.8 1.2-1.6 2.6-2.2 4.2-1.8.913.228 1.565.89 2.288 1.624C13.666 10.618 15.027 12 18.001 12c3.2 0 5.2-1.6 6-4.8-1.2 1.6-2.6 2.2-4.2 1.8-.913-.228-1.565-.89-2.288-1.624C16.337 6.182 14.976 4.8 12.001 4.8zm-6 7.2c-3.2 0-5.2 1.6-6 4.8 1.2-1.6 2.6-2.2 4.2-1.8.913.228 1.565.89 2.288 1.624 1.177 1.194 2.538 2.576 5.512 2.576 3.2 0 5.2-1.6 6-4.8-1.2 1.6-2.6 2.2-4.2 1.8-.913-.228-1.565-.89-2.288-1.624C10.337 13.382 8.976 12 6.001 12z" />
                    </svg>
                </span>
                <span class="format-name">Tailwind</span>
                <span class="format-desc">Config Theme</span>
            </label>
            <label class="format-option">
                <input type="radio" name="export-format" value="typescript">
                <span class="format-icon">TS</span>
                <span class="format-name">TypeScript</span>
                <span class="format-desc">Constants</span>
            </label>
        </div>
    </div>

    <!-- Step 3: Options -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <div class="section-title">3. Options</div>
        <div class="options-grid">
            <label class="checkbox-option">
                <input type="checkbox" id="opt-include-modes" checked>
                <span class="checkbox-label">Include modes (light/dark)</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" id="opt-resolve-refs" checked>
                <span class="checkbox-label">Resolve alias references</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" id="opt-include-metadata">
                <span class="checkbox-label">Include metadata (type, description)</span>
            </label>
        </div>

        <div class="sub-label">Naming Convention</div>
        <div class="naming-options">
            <label class="radio-pill">
                <input type="radio" name="naming-convention" value="kebab" checked>
                <span>kebab-case</span>
            </label>
            <label class="radio-pill">
                <input type="radio" name="naming-convention" value="camel">
                <span>camelCase</span>
            </label>
            <label class="radio-pill">
                <input type="radio" name="naming-convention" value="snake">
                <span>snake_case</span>
            </label>
            <label class="radio-pill">
                <input type="radio" name="naming-convention" value="original">
                <span>Original</span>
            </label>
        </div>
    </div>

    <!-- Step 4: Generate -->
    <div class="card" style="margin-bottom: var(--space-4);">
        <button id="generate-export-btn" class="primary big-btn" style="width: 100%;">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
                </svg></span>
            Generate Export
        </button>
    </div>

    <!-- Output Preview -->
    <div id="export-preview-container" class="card" style="display: none;">
        <div class="flex-between" style="margin-bottom: var(--space-3);">
            <div class="section-title" style="margin: 0;">Output Preview</div>
            <div class="export-actions">
                <button id="copy-export-btn" class="secondary btn-sm">
                    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                            <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                        </svg></span>
                    Copy
                </button>
                <button id="download-export-btn" class="primary btn-sm">
                    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" x2="12" y1="15" y2="3" />
                        </svg></span>
                    Download
                </button>
            </div>
        </div>
        <div class="export-stats">
            <span class="stat-badge" id="export-vars-count">0 variables</span>
            <span class="stat-badge" id="export-format-badge">JSON</span>
        </div>
        <pre id="export-output"
            class="code-preview"><code>// Select a collection and click "Generate Export"</code></pre>
    </div>
</div>

<style>
    /* Dev Tools Specific Styles */
    .format-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: var(--space-2);
    }

    .format-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-3);
        background: var(--bg-surface-hover);
        border: 2px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: all var(--transition-fast);
        text-align: center;
    }

    .format-option:hover {
        border-color: var(--border-default);
    }

    .format-option.active,
    .format-option:has(input:checked) {
        border-color: var(--accent-primary);
        background: var(--accent-primary-subtle);
    }

    .format-option input {
        display: none;
    }

    .format-icon {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .format-name {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
    }

    .format-desc {
        font-size: var(--font-size-xs);
        color: var(--text-tertiary);
    }

    .options-grid {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }

    .checkbox-option {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-2) var(--space-3);
        background: var(--bg-surface-hover);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .checkbox-option:hover {
        background: var(--bg-surface-active);
    }

    .checkbox-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: var(--accent-primary);
    }

    .checkbox-label {
        font-size: var(--font-size-sm);
        color: var(--text-primary);
    }

    .naming-options {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
    }

    .radio-pill {
        display: flex;
        align-items: center;
        cursor: pointer;
    }

    .radio-pill input {
        display: none;
    }

    .radio-pill span {
        padding: var(--space-2) var(--space-3);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        background: var(--bg-surface-hover);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-full);
        color: var(--text-secondary);
        transition: all var(--transition-fast);
    }

    .radio-pill:hover span {
        border-color: var(--border-default);
    }

    .radio-pill input:checked+span {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
        color: white;
    }

    .export-actions {
        display: flex;
        gap: var(--space-2);
    }

    .export-stats {
        display: flex;
        gap: var(--space-2);
        margin-bottom: var(--space-3);
    }

    .stat-badge {
        padding: var(--space-1) var(--space-2);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        background: var(--bg-surface-active);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
    }

    .code-preview {
        background: var(--bg-base);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        overflow: auto;
        max-height: 400px;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        font-size: 12px;
        line-height: 1.5;
        color: var(--text-secondary);
        white-space: pre-wrap;
        word-break: break-word;
    }

    .code-preview code {
        color: inherit;
    }
</style>

            </div>
        </div>
    </div>

    <script>
/* --- common.js --- */
// Global State
let currentThemeData = null;
let paletteCache = {}; // Start empty, filled by theme-generated
let tokenOverrides = {}; // { 'Status/error': { light: '50', dark: '900' } }

// Backend Messages Handler
window.onmessage = (event) => {
    const { type, payload } = event.data.pluginMessage;

    // Dispatch custom event so modules can listen to specific messages
    // This allows decoupling the switch statement
    const customEvent = new CustomEvent('plugin-message', { detail: { type, payload } });
    window.dispatchEvent(customEvent);

    // Common handlers
    if (type === 'show-progress') {
        const overlay = document.getElementById('progress-overlay');
        if (overlay) {
            overlay.style.display = 'flex';
            document.getElementById('progress-message').textContent = payload.message;
        }
    } else if (type === 'hide-progress') {
        const overlay = document.getElementById('progress-overlay');
        if (overlay) overlay.style.display = 'none';

    } else if (type === 'notify') {
        // Display a temporary notification
        showNotification(payload.message, payload.status);
    }
};

// Helper: Show Notification
function showNotification(message, status = 'info') {
    let notification = document.getElementById('notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        notification.style.cssText = `
            display: none;
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            background: #333;
            color: white;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        `;
        document.body.appendChild(notification);
    }

    notification.textContent = message;

    // Style based on status
    if (status === 'error') notification.style.background = '#ef4444';
    else if (status === 'success') notification.style.background = '#10b981';
    else notification.style.background = '#333';

    notification.style.display = 'block';
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Add Progress Overlay HTML if not present
document.addEventListener('DOMContentLoaded', () => {
    if (!document.getElementById('progress-overlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'progress-overlay';
        overlay.style.cssText = `
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        `;
        overlay.innerHTML = `
            <div class="spinner" style="
                width: 40px; 
                height: 40px; 
                border: 4px solid #f3f3f3; 
                border-top: 4px solid #3498db; 
                border-radius: 50%; 
                animation: spin 1s linear infinite;"></div>
            <div id="progress-message" style="margin-top: 16px; font-weight: 600; color: #333;">Processing...</div>
            <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
        `;
        document.body.appendChild(overlay);
    }
});

// Custom Resize Handle Logic
document.addEventListener('DOMContentLoaded', () => {
    // Check if handle already exists
    if (document.getElementById('resize-handle')) return;

    // Inject resize handle
    const handle = document.createElement('div');
    handle.id = 'resize-handle';
    handle.style.cssText = 'position: fixed; bottom: 0; right: 0; width: 16px; height: 16px; cursor: nwse-resize; z-index: 10000;';

    // Add visual indicator (triangle) using SVG
    handle.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 8L8 14M14 4L4 14" stroke="#94a3b8" stroke-width="2" stroke-linecap="round"/></svg>`;

    document.body.appendChild(handle);

    let isResizing = false;

    handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        e.preventDefault(); // Prevent text selection

        // Notify parent we are starting resize? (Optional)
        window.addEventListener('mousemove', handleMouseMove);
        window.addEventListener('mouseup', handleMouseUp);
    });

    function handleMouseMove(e) {
        if (!isResizing) return;

        // Calculate new size based on mouse position
        const newWidth = Math.max(300, e.clientX); // Min width 300
        const newHeight = Math.max(300, e.clientY); // Min height 300

        // Send message to code.js
        parent.postMessage({
            pluginMessage: { type: 'resize-window', width: newWidth, height: newHeight }
        }, '*');
    }

    function handleMouseUp() {
        isResizing = false;
        window.removeEventListener('mousemove', handleMouseMove);
        window.removeEventListener('mouseup', handleMouseUp);
    }
});


/* --- colors.js --- */
// Colors Section Logic
console.log('ð¨ Colors script loaded');

function initColors() {
    console.log('ð¨ Initializing Colors section...');

    // UI Elements
    const collectionSelect = document.getElementById('var-collection-select');
    const customCollectionInput = document.getElementById('var-collection-custom');
    const groupSelect = document.getElementById('var-group-select');
    const customGroupInput = document.getElementById('var-group-custom');
    const newColorName = document.getElementById('new-color-name');
    const newColorHex = document.getElementById('new-color-hex');
    const newColorSwatch = document.getElementById('new-color-swatch');
    const addColorBtn = document.getElementById('add-color-btn');
    const addError = document.getElementById('add-error');
    const colorQueueDiv = document.getElementById('color-queue');
    const queueCountSpan = document.getElementById('queue-count-badge');
    const previewScaleBtn = document.getElementById('preview-scale-btn');
    const scalePreviewContainer = document.getElementById('scale-preview-container');
    const scaleList = document.getElementById('scale-list');
    const createVarsBtn = document.getElementById('create-vars-btn');

    // Progress Bar Elements
    const progressDiv = document.getElementById('creation-progress');
    const progressBarFill = document.getElementById('progress-bar-fill');
    const progressMessage = document.getElementById('progress-message');
    const progressPercent = document.getElementById('progress-percent');

    // Existing Palettes Elements
    const existingPalettesContainer = document.getElementById('existing-palettes-container');
    const existingPalettesList = document.getElementById('existing-palettes-list');
    const existingPalettesCount = document.getElementById('existing-palettes-count');

    if (!addColorBtn) {
        console.error('â Critical Error: add-color-btn not found. DOM might not be ready.');
        return;
    }

    // Initial Load
    console.log('ð¨ Requesting collections...');
    parent.postMessage({ pluginMessage: { type: 'load-collections' } }, '*');

    // State
    let colorQueue = [];

    // Message Listener
    window.addEventListener('plugin-message', (event) => {
        const { type, payload } = event.detail;
        console.log(`ð¨ Colors received message: ${type}`, payload);

        if (type === 'progress-start') {
            if (progressDiv) {
                progressDiv.style.display = 'block';
                progressBarFill.style.width = '0%';
                progressMessage.textContent = payload || 'Starting...';
                progressPercent.textContent = '0%';
                createVarsBtn.disabled = true;
                createVarsBtn.style.opacity = '0.5';
            }

        } else if (type === 'progress-update') {
            if (progressDiv && payload) {
                const percent = Math.round((payload.current / payload.total) * 100);
                progressBarFill.style.width = `${percent}%`;
                progressMessage.textContent = payload.message;
                progressPercent.textContent = `${percent}%`;
            }

        } else if (type === 'progress-end') {
            if (progressDiv) {
                progressBarFill.style.width = '100%';
                progressPercent.textContent = '100%';
                progressMessage.textContent = 'Done!';

                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    createVarsBtn.disabled = false;
                    createVarsBtn.style.opacity = '1';

                    // Close the preview container smoothly if tasks are done
                    if (colorQueue.length === 0) {
                        scalePreviewContainer.style.display = 'none';
                    }
                }, 1500);
            }

        } else if (type === 'variables-created-success') {
            colorQueue = [];
            updateQueueUI();

        } else if (type === 'load-collections') {
            if (!collectionSelect) return;
            // Populate Collection Select
            // Reset but keep first 2 options
            while (collectionSelect.options.length > 2) {
                collectionSelect.remove(2);
            }

            payload.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                collectionSelect.appendChild(option);
            });
            console.log(`â Loaded ${payload.length} collections into dropdown`);

        } else if (type === 'load-groups-tab1') {
            if (!groupSelect) return;
            // Populate Group Select
            groupSelect.innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';
            payload.forEach(g => {
                const option = document.createElement('option');
                option.value = g;
                option.textContent = g;
                groupSelect.appendChild(option);
            });
            groupSelect.disabled = false;

            // Request existing palettes for this collection
            const selectedCollection = collectionSelect.value;
            if (selectedCollection && selectedCollection !== 'NEW_COLLECTION') {
                parent.postMessage({
                    pluginMessage: {
                        type: 'get-existing-palettes',
                        collectionId: selectedCollection,
                        groupName: '' // Root initially
                    }
                }, '*');
            }

        } else if (type === 'existing-palettes-loaded') {
            // Render existing palettes
            renderExistingPalettes(payload);

        } else if (type === 'preview-scale-batch-result') {
            // Render Previews
            scaleList.innerHTML = '';

            payload.forEach(item => {
                const row = document.createElement('div');
                row.style.marginBottom = '24px';

                const title = document.createElement('div');
                title.style.fontWeight = '600';
                title.style.marginBottom = '8px';
                title.style.fontSize = '13px';
                title.textContent = item.name;
                row.appendChild(title);

                const swatches = document.createElement('div');
                swatches.style.display = 'flex';
                swatches.style.borderRadius = '8px';
                swatches.style.overflow = 'hidden';
                swatches.style.height = '40px';

                // Sort keys: 50, 100, ... 950
                const steps = Object.keys(item.steps).sort((a, b) => parseInt(a) - parseInt(b));

                steps.forEach(step => {
                    const data = item.steps[step];
                    const hex = data.hex;
                    const isDark = (step >= 500); // Simple heuristic for text color

                    const chip = document.createElement('div');
                    chip.style.flex = '1';
                    chip.style.backgroundColor = hex;
                    chip.style.display = 'flex';
                    chip.style.alignItems = 'center';
                    chip.style.justifyContent = 'center';
                    chip.style.color = isDark ? 'white' : 'black';
                    chip.style.fontSize = '10px';
                    chip.innerText = step;

                    swatches.appendChild(chip);
                });

                row.appendChild(swatches);
                scaleList.appendChild(row);
            });

            scalePreviewContainer.style.display = 'block';
            createVarsBtn.disabled = false;
        }
    });

    // Event Handlers

    // Collection Select Change
    if (collectionSelect) {
        collectionSelect.onchange = () => {
            const val = collectionSelect.value;
            if (val === 'NEW_COLLECTION') {
                customCollectionInput.style.display = 'block';
                // Enable group selection so user can create a group in the new collection
                groupSelect.disabled = false;
                // Reset to default options: Root and New Group
                groupSelect.innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';
            } else {
                customCollectionInput.style.display = 'none';
                // Load groups for this collection
                parent.postMessage({ pluginMessage: { type: 'get-groups-for-tab1', collectionId: val } }, '*');
            }
        };
    }

    // Group Select Change
    if (groupSelect) {
        groupSelect.onchange = () => {
            if (groupSelect.value === 'NEW_GROUP') {
                customGroupInput.style.display = 'block';
                // Hide existing palettes when creating new group
                if (existingPalettesContainer) {
                    existingPalettesContainer.style.display = 'none';
                }
            } else {
                customGroupInput.style.display = 'none';
                // Request existing palettes for selected group
                const selectedCollection = collectionSelect.value;
                if (selectedCollection && selectedCollection !== 'NEW_COLLECTION') {
                    parent.postMessage({
                        pluginMessage: {
                            type: 'get-existing-palettes',
                            collectionId: selectedCollection,
                            groupName: groupSelect.value || ''
                        }
                    }, '*');
                }
            }
        };
    }

    // Function to render existing palettes (uses same style as preview)
    function renderExistingPalettes(palettes) {
        if (!existingPalettesContainer || !existingPalettesList) return;

        if (!palettes || Object.keys(palettes).length === 0) {
            existingPalettesContainer.style.display = 'none';
            return;
        }

        existingPalettesList.innerHTML = '';
        const paletteNames = Object.keys(palettes);

        if (existingPalettesCount) {
            existingPalettesCount.textContent = `${paletteNames.length} palette${paletteNames.length !== 1 ? 's' : ''}`;
        }

        paletteNames.forEach(paletteName => {
            const colors = palettes[paletteName];
            if (!colors || colors.length === 0) return;

            const row = document.createElement('div');
            row.style.marginBottom = '16px';

            // Extract just the palette name (last part of path)
            const displayName = paletteName.split('/').pop();

            const title = document.createElement('div');
            title.style.fontWeight = '600';
            title.style.marginBottom = '8px';
            title.style.fontSize = '13px';
            title.textContent = displayName;
            row.appendChild(title);

            const swatches = document.createElement('div');
            swatches.style.display = 'flex';
            swatches.style.borderRadius = '8px';
            swatches.style.overflow = 'hidden';
            swatches.style.height = '40px';

            // Sort colors by step number
            const sortedColors = [...colors].sort((a, b) => {
                const aNum = parseInt(a.step.split('-').pop() || '0');
                const bNum = parseInt(b.step.split('-').pop() || '0');
                return aNum - bNum;
            });

            sortedColors.forEach(color => {
                const stepNum = parseInt(color.step.split('-').pop() || '0');
                const isDark = (stepNum >= 500);

                const chip = document.createElement('div');
                chip.style.flex = '1';
                chip.style.backgroundColor = color.hex;
                chip.style.display = 'flex';
                chip.style.alignItems = 'center';
                chip.style.justifyContent = 'center';
                chip.style.color = isDark ? 'white' : 'black';
                chip.style.fontSize = '10px';
                chip.title = `${color.step}: ${color.hex}`;
                chip.innerText = stepNum;

                swatches.appendChild(chip);
            });

            row.appendChild(swatches);
            existingPalettesList.appendChild(row);
        });

        existingPalettesContainer.style.display = 'block';
    }

    // Hex/Color Input Preview (Supports Hex, RGB, HSL, OKLCH, etc.)
    if (newColorHex) {
        newColorHex.oninput = () => {
            const val = newColorHex.value.trim();
            // Try to set the background color. If it's valid CSS, the browser will apply it.
            if (val) {
                newColorSwatch.style.backgroundColor = val;
                // Check if it worked (simple validation hack)
                // Note: This isn't perfect but allows flexibility
            } else {
                newColorSwatch.style.backgroundColor = '#f3f4f6';
            }
        };
    }

    // Add to Queue
    addColorBtn.onclick = () => {
        console.log('â Add Color Button Clicked');
        const name = newColorName.value.trim();
        const colorVal = newColorHex.value.trim();

        // Validation: Just check if not empty. Let CSS/Backend handle exact validity.
        if (!name || !colorVal) {
            addError.style.display = 'block';
            addError.textContent = 'Name and Value are required';
            console.warn('â ï¸ Empty input');
            return;
        }
        addError.style.display = 'none';

        colorQueue.push({ name, hex: colorVal, id: Date.now() }); // We use 'hex' key but it can store any string
        updateQueueUI();

        // Clear inputs
        newColorName.value = '';
        newColorHex.value = '';
        newColorSwatch.style.backgroundColor = '#f3f4f6';
        newColorName.focus(); // Focus back to name for fast entry
    };

    function updateQueueUI() {
        if (queueCountSpan) {
            queueCountSpan.textContent = colorQueue.length + ' colors'; // Add 'colors' suffix to match design
        }

        colorQueueDiv.innerHTML = '';

        if (colorQueue.length === 0) {
            colorQueueDiv.innerHTML = '<p id="empty-queue-msg" style="font-size: 11px; color: #999; font-style: italic;">No colors added yet.</p>';
            previewScaleBtn.disabled = true;
            return;
        }

        previewScaleBtn.disabled = false;

        colorQueue.forEach((item, index) => {
            const el = document.createElement('div');
            el.className = 'color-queue-item'; // Use correct class from CSS

            el.innerHTML = `
                <div class="swatch" style="background-color: ${item.hex};"></div>
                <div class="info">
                    <div class="name">${item.name}</div>
                    <div class="hex">${item.hex}</div>
                </div>
                <button class="remove-btn" data-index="${index}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            `;
            colorQueueDiv.appendChild(el);
        });

        // Add remove listeners
        document.querySelectorAll('.remove-btn').forEach(btn => {
            btn.onclick = (e) => {
                const idx = parseInt(e.currentTarget.dataset.index); // Use currentTarget to ensure we get the button
                colorQueue.splice(idx, 1);
                updateQueueUI();
            };
        });
    }

    // Preview
    previewScaleBtn.onclick = () => {
        console.log('ðï¸ Preview Scale Clicked', colorQueue);
        parent.postMessage({ pluginMessage: { type: 'preview-scale-batch', colors: colorQueue } }, '*');
    };

    // Create Variables
    createVarsBtn.onclick = () => {
        console.log('ð Create Variables Clicked');
        if (colorQueue.length === 0) return;

        let collectionId = collectionSelect.value;
        let collectionName = null;
        if (collectionId === 'NEW_COLLECTION') {
            collectionName = customCollectionInput.value.trim();
            if (!collectionName) {
                alert('Please enter a collection name');
                return;
            }
            collectionId = null; // Backend handles creation
        }

        let groupName = groupSelect.value;
        if (groupName === 'NEW_GROUP') {
            groupName = customGroupInput.value.trim();
        } else if (groupName === '') {
            groupName = null; // Root
        }

        const config = {
            collectionId,
            collectionName,
            groupName
        };

        parent.postMessage({
            pluginMessage: {
                type: 'create-variables-batch',
                colors: colorQueue,
                config
            }
        }, '*');
    };
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initColors);
} else {
    initColors();
}


/* --- measures.js --- */
// Measures Section Logic
console.log('ð Measures script loaded');

function initMeasures() {
    console.log('ð Initializing Measures section...');

    // UI Elements
    const measureValues = document.getElementById('measure-values');
    const previewBtn = document.getElementById('preview-measures-btn');
    const measurePreviewContainer = document.getElementById('measure-preview-container');
    const measureList = document.getElementById('measure-list');
    const collectionSelect = document.getElementById('measure-collection-select');
    const groupSelect = document.getElementById('measure-group-select');
    const customGroupInput = document.getElementById('measure-group-custom');
    const createBtn = document.getElementById('create-measures-btn');

    if (!collectionSelect) {
        console.error('â Critical: measure-collection-select not found in DOM!');
        return;
    }

    if (!createBtn) {
        console.warn('â ï¸ Measures UI create-btn not found. Structure check required.');
    }

    // Presets Logic
    const PRESETS = {
        default: '0, 4, 8, 12, 16, 20, 24, 32, 40, 48, 64, 80, 96, 128',
        tailwind: '0, 2, 4, 6, 8, 10, 12, 14, 16, 20, 24, 28, 32, 36, 40, 44, 48, 56, 64, 80, 96', // Pixel values for tw scale
        material: '0, 4, 8, 12, 16, 24, 32, 48, 64, 80, 96',
        fibonacci: '1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144',
        golden: '2, 3.24, 5.24, 8.47, 13.71, 22.18, 35.89, 58.07, 93.96, 152.03'
    };

    const presetBtns = document.querySelectorAll('.preset-btn');
    presetBtns.forEach(btn => {
        btn.onclick = () => {
            const key = btn.dataset.preset;
            if (PRESETS[key] && measureValues) {
                measureValues.value = PRESETS[key];
                // Trigger preview if user wants immediate feedback? Maybe not to avoid spam.
                // But visual feedback on the textarea is enough.
            }
        };
    });

    // Message Listener
    window.addEventListener('plugin-message', (event) => {
        const { type, payload } = event.detail;

        if (type === 'load-collections') {
            console.log('ð Measures received load-collections. Payload:', payload);

            if (!collectionSelect) {
                console.error('â measure-collection-select lost reference!');
                return;
            }

            try {
                // Populate Collection Select
                const currentVal = collectionSelect.value;
                collectionSelect.innerHTML = '<option value="" disabled selected>Select Collection...</option>';

                if (payload && Array.isArray(payload)) {
                    payload.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        collectionSelect.appendChild(option);
                    });
                    console.log(`â Measures: Populated ${payload.length} collections.`);

                    // Restore selection if valid
                    if (currentVal && payload.find(c => c.id === currentVal)) {
                        collectionSelect.value = currentVal;
                    }
                } else {
                    console.warn('â ï¸ Payload is not an array:', payload);
                }
            } catch (err) {
                console.error('â Error populating measure collections:', err);
            }

        } else if (type === 'load-groups-measures') {
            console.log('ð Measures: Loaded groups', payload);
            groupSelect.innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';
            payload.forEach(g => {
                const option = document.createElement('option');
                option.value = g;
                option.textContent = g;
                groupSelect.appendChild(option);
            });
            groupSelect.disabled = false;

        } else if (type === 'measures-created-success') {
            alert('Measures created successfully! â');

            // Reset UI state
            if (measurePreviewContainer) measurePreviewContainer.style.display = 'none';

            const configContainer = document.getElementById('measure-config-container');
            if (configContainer) configContainer.style.display = 'none';

            // Reset selection to force fresh choice next time
            if (collectionSelect) collectionSelect.value = "";
            if (groupSelect) {
                groupSelect.value = "";
                // Reset group input visibility
                if (customGroupInput) customGroupInput.style.display = 'none';
            }
        }
    });

    // UI Events
    previewBtn.onclick = () => {
        console.log('ð Preview Measures Clicked');
        const raw = measureValues.value;
        const values = raw.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));

        if (values.length === 0) {
            alert('Please enter valid numbers (comma separated)');
            return;
        }

        // Render Preview
        measureList.innerHTML = '';
        values.forEach(v => {
            const chip = document.createElement('div');
            chip.style.cssText = `
                padding: 4px 8px;
                background: #f3f4f6;
                border-radius: 4px;
                border: 1px solid #e5e7eb;
                font-size: 12px;
                font-family: monospace;
                color: #374151;
            `;
            chip.textContent = `${v}px`;
            measureList.appendChild(chip);
        });

        if (measurePreviewContainer) measurePreviewContainer.style.display = 'block';

        const configContainer = document.getElementById('measure-config-container');
        if (configContainer) {
            configContainer.style.display = 'block';
            // Scroll to bottom to show new controls
            setTimeout(() => configContainer.scrollIntoView({ behavior: 'smooth' }), 100);
        }

        // Always request collections to ensure freshness
        console.log('ð Requesting collections refresh from preview...');
        parent.postMessage({ pluginMessage: { type: 'load-collections' } }, '*');
    };

    collectionSelect.onchange = () => {
        const val = collectionSelect.value;
        console.log('ð Collection changed:', val);
        // Request groups
        parent.postMessage({ pluginMessage: { type: 'get-groups-for-measures', collectionId: val } }, '*');
    };

    if (createBtn) {
        createBtn.onclick = () => {
            if (!collectionSelect.value) {
                alert('Select a collection');
                return;
            }

            const raw = measureValues.value;
            const values = raw.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));

            let groupName = groupSelect.value;
            if (groupName === 'NEW_GROUP') {
                groupName = customGroupInput.value.trim();
            } else if (groupName === '') {
                groupName = null;
            }

            const config = {
                collectionId: collectionSelect.value,
                groupName
            };

            console.log('ð Creating measures:', values, config);

            parent.postMessage({
                pluginMessage: {
                    type: 'create-measure-variables',
                    values,
                    config
                }
            }, '*');
        };
    }

    groupSelect.onchange = () => {
        if (groupSelect.value === 'NEW_GROUP') {
            customGroupInput.style.display = 'block';
        } else {
            customGroupInput.style.display = 'none';
        }
    };

    // Initial load request
    // This handles the case where navigation.js might have missed it or we reloaded the script context
    console.log('ð Sending initial load-collections request from init.');
    parent.postMessage({ pluginMessage: { type: 'load-collections' } }, '*');
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMeasures);
} else {
    initMeasures();
}


/* --- typography.js --- */
// Typography Section Logic
console.log('âï¸ Typography script loaded');

function initTypography() {
    console.log('âï¸ Initializing Typography section...');

    // UI Elements
    const fontHeading = document.getElementById('font-heading');
    const fontBody = document.getElementById('font-body');
    const fontCode = document.getElementById('font-code');
    const typoWeights = document.getElementById('typo-weights');
    const typoSpacing = document.getElementById('typo-spacing');
    const typoSizes = document.getElementById('typo-sizes');
    const typoCollection = document.getElementById('typo-collection-select');
    const typoGroup = document.getElementById('typo-group-select');
    const typoGroupCustom = document.getElementById('typo-group-custom');
    const createBtn = document.getElementById('create-typo-btn');

    if (!createBtn) {
        console.warn('â ï¸ Typography UI elements not found');
        return;
    }

    // Initial Load of Fonts
    console.log('âï¸ Requesting font list...');
    parent.postMessage({ pluginMessage: { type: 'get-fonts' } }, '*');

    // Message Listener
    window.addEventListener('plugin-message', (event) => {
        const { type, payload } = event.detail;

        if (type === 'load-fonts') {
            const fonts = payload; // ['Inter', 'Roboto', ...]
            console.log('âï¸ Fonts loaded:', fonts.length);
            const updateSelect = (sel) => {
                sel.innerHTML = '<option value="" disabled selected>Select Font...</option>';
                fonts.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f;
                    opt.textContent = f;
                    sel.appendChild(opt);
                });
            };

            updateSelect(fontHeading);
            updateSelect(fontBody);
            updateSelect(fontCode);

            // Set defaults if available
            if (fonts.includes('Inter')) {
                fontHeading.value = 'Inter';
                fontBody.value = 'Inter';
            }
            if (fonts.includes('Roboto Mono')) {
                fontCode.value = 'Roboto Mono';
            }

        } else if (type === 'load-collections') {
            typoCollection.innerHTML = '<option value="" disabled selected>Select Collection...</option>';
            payload.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                typoCollection.appendChild(opt);
            });
            console.log('âï¸ Typography: Collections loaded');

        } else if (type === 'load-groups-typo') {
            console.log('âï¸ Typography: Groups loaded');
            typoGroup.innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';
            payload.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = g;
                typoGroup.appendChild(opt);
            });
            typoGroup.disabled = false;
        }
    });

    // Events
    typoCollection.onchange = () => {
        console.log('âï¸ Typography: Collection changed');
        parent.postMessage({ pluginMessage: { type: 'get-groups-for-typo', collectionId: typoCollection.value } }, '*');
    };

    typoGroup.onchange = () => {
        if (typoGroup.value === 'NEW_GROUP') {
            typoGroupCustom.style.display = 'block';
        } else {
            typoGroupCustom.style.display = 'none';
        }
    };

    createBtn.onclick = () => {
        if (!typoCollection.value) {
            alert('Select a collection');
            return;
        }

        const families = {
            heading: fontHeading.value,
            body: fontBody.value,
            code: fontCode.value
        };

        const parseList = (el) => el.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));

        const weights = parseList(typoWeights);
        const spacing = parseList(typoSpacing);
        const sizes = parseList(typoSizes);

        let groupName = typoGroup.value;
        if (groupName === 'NEW_GROUP') {
            groupName = typoGroupCustom.value.trim();
        } else if (groupName === '') {
            groupName = null;
        }

        const config = {
            collectionId: typoCollection.value,
            groupName
        };

        console.log('âï¸ Creating typography...', config);

        parent.postMessage({
            pluginMessage: {
                type: 'create-typography',
                families,
                weights,
                spacing,
                sizes,
                config
            }
        }, '*');
    };
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTypography);
} else {
    initTypography();
}


/* --- aliases.js --- */
// Aliases (Responsive Semantics) Section Logic
console.log('ð Aliases script loaded');

function initAliases() {
    console.log('ð Initializing Aliases section...');

    // Mode Toggle
    const modeTokensBtn = document.getElementById('mode-tokens');
    const modeStylesBtn = document.getElementById('mode-styles');
    const tokensModeSection = document.getElementById('aliases-mode-tokens');
    const stylesModeSection = document.getElementById('aliases-mode-styles');

    // Tokens Mode Elements
    const sourceCollection = document.getElementById('alias-source-collection');
    const measureGroup = document.getElementById('alias-measures-group');
    const typoGroup = document.getElementById('alias-typo-group');
    const targetNameInput = document.getElementById('alias-target-name');
    const createBtn = document.getElementById('create-aliases-btn');

    // Styles Mode Elements
    const stylesCollection = document.getElementById('styles-source-collection');
    const stylesPrefixInput = document.getElementById('styles-prefix');
    const scanBtn = document.getElementById('scan-styles-btn');
    const createStylesBtn = document.getElementById('create-styles-btn');
    const stylesCategories = document.getElementById('styles-categories');
    const noVarsWarning = document.getElementById('styles-no-vars-warning');
    const goToTokensBtn = document.getElementById('go-to-tokens-btn');
    const selectedCountSpan = document.getElementById('selected-styles-count');

    // Text Styles Section
    const textStylesSection = document.getElementById('text-styles-section');
    const textStylesList = document.getElementById('text-styles-list');

    // Effect Styles Section
    const effectStylesSection = document.getElementById('effect-styles-section');
    const effectStylesList = document.getElementById('effect-styles-list');

    if (!createBtn) {
        console.warn('â ï¸ Aliases UI elements not found');
        return;
    }

    // State
    let scannedStyles = { textStyles: [], effectStyles: [] };
    let currentMode = 'tokens';

    // Mode Toggle
    function setMode(mode) {
        currentMode = mode;
        if (mode === 'tokens') {
            modeTokensBtn.classList.add('active');
            modeStylesBtn.classList.remove('active');
            tokensModeSection.style.display = 'block';
            stylesModeSection.style.display = 'none';
        } else {
            modeStylesBtn.classList.add('active');
            modeTokensBtn.classList.remove('active');
            tokensModeSection.style.display = 'none';
            stylesModeSection.style.display = 'block';
        }
    }

    modeTokensBtn.onclick = () => setMode('tokens');
    modeStylesBtn.onclick = () => setMode('styles');

    if (goToTokensBtn) {
        goToTokensBtn.onclick = () => setMode('tokens');
    }

    // Message Listener
    window.addEventListener('plugin-message', (event) => {
        const { type, payload } = event.detail;

        if (type === 'load-collections') {
            // Fill both collection selects
            [sourceCollection, stylesCollection].forEach(sel => {
                if (!sel) return;
                sel.innerHTML = '<option value="" disabled selected>Select Collection...</option>';
                payload.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    sel.appendChild(opt);
                });
            });
            console.log('ð Aliases: Loaded collections');

        } else if (type === 'load-groups-alias') {
            // For Tokens mode
            const fill = (sel, label) => {
                sel.innerHTML = `<option value="" disabled selected>${label}</option>`;
                payload.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g;
                    opt.textContent = g;
                    sel.appendChild(opt);
                });
                sel.disabled = false;
            };

            fill(measureGroup, 'Select Measures Group...');
            fill(typoGroup, 'Select Typography Group...');
            console.log('ð Aliases: Loaded groups for tokens mode');

        } else if (type === 'scan-styles-result') {
            // Reset scan button
            scanBtn.disabled = false;
            scanBtn.innerHTML = '<span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></span> Scan Collection';

            scannedStyles = payload;

            if ((!payload.textStyles || payload.textStyles.length === 0) &&
                (!payload.effectStyles || payload.effectStyles.length === 0)) {
                // No styles found
                noVarsWarning.style.display = 'flex';
                stylesCategories.style.display = 'none';
                createStylesBtn.style.display = 'none';
            } else {
                noVarsWarning.style.display = 'none';
                stylesCategories.style.display = 'block';
                createStylesBtn.style.display = 'flex';

                // Render Text Styles
                if (payload.textStyles && payload.textStyles.length > 0) {
                    textStylesSection.style.display = 'block';
                    renderStylesList(textStylesList, payload.textStyles, 'text');
                    textStylesSection.querySelector('.styles-section-count').textContent = `${payload.textStyles.length} styles`;
                } else {
                    textStylesSection.style.display = 'none';
                }

                // Render Effect Styles
                if (payload.effectStyles && payload.effectStyles.length > 0) {
                    effectStylesSection.style.display = 'block';
                    renderStylesList(effectStylesList, payload.effectStyles, 'effect');
                    effectStylesSection.querySelector('.styles-section-count').textContent = `${payload.effectStyles.length} styles`;
                } else {
                    effectStylesSection.style.display = 'none';
                }

                updateSelectedCount();
            }
        }
    });

    // Render styles list with checkboxes
    function renderStylesList(container, styles, type) {
        try {
            container.innerHTML = '';
            console.log(`RenderStylesList: Rendering ${styles.length} items of type ${type}`);

            if (type === 'text') {
                // "GRID OF CARDS" STRATEGY (The "Oh God Finally" Edition)
                // Structure:
                // Section (Main Group, e.g. "Body")
                //   -> Grid Container
                //      -> Card (SubGroup, e.g. "Large")
                //         -> List of Variants

                const hierarchy = {};

                // --- Step 1: Build Hierarchy Tree ---
                styles.forEach((style, index) => {
                    // Filter out primitive groups that don't make sense as composite styles
                    if (style.name.startsWith('Weight/') || style.name.startsWith('Family/') || style.name.startsWith('Line Height/')) {
                        return;
                    }

                    const originalIndex = style.originalIndex !== undefined ? style.originalIndex : index;

                    const separatorIndex = style.name.lastIndexOf(' / ');
                    let fullGroupName = '', weightName = '';

                    if (separatorIndex !== -1) {
                        fullGroupName = style.name.substring(0, separatorIndex);
                        weightName = style.name.substring(separatorIndex + 3);
                    } else {
                        weightName = style.name.split('/').pop();
                        fullGroupName = 'Other';
                    }

                    const slashIndex = fullGroupName.indexOf('/');
                    let mainGroup = fullGroupName, subGroup = 'Base';

                    if (slashIndex !== -1) {
                        mainGroup = fullGroupName.substring(0, slashIndex);
                        subGroup = fullGroupName.substring(slashIndex + 1);
                    }

                    if (!hierarchy[mainGroup]) hierarchy[mainGroup] = {};
                    if (!hierarchy[mainGroup][subGroup]) hierarchy[mainGroup][subGroup] = [];

                    hierarchy[mainGroup][subGroup].push({
                        ...style,
                        weightName,
                        originalIndex
                    });
                });

                // --- Step 1.5: Global Weight Shortcuts ---
                // Extract unique weights across all styles
                const allWeights = new Set();
                styles.forEach(s => {
                    // Re-parse weight name consistent with logic below
                    const separatorIndex = s.name.lastIndexOf(' / ');
                    let weightName = separatorIndex !== -1 ? s.name.substring(separatorIndex + 3) : s.name.split('/').pop();
                    allWeights.add(weightName);
                });

                if (allWeights.size > 0) {
                    const shortcutsContainer = document.createElement('div');
                    shortcutsContainer.className = 'weight-shortcuts';
                    shortcutsContainer.style.cssText = 'display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; padding: 12px; background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: 8px; align-items: center;';

                    const label = document.createElement('span');
                    label.textContent = 'Shortcuts:';
                    label.style.cssText = 'font-size: 11px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; margin-right: 4px;';
                    shortcutsContainer.appendChild(label);

                    const weightOrder = {
                        'thin': 10,
                        'extralight': 20, 'extra light': 20,
                        'light': 30,
                        'regular': 40, 'normal': 40,
                        'medium': 50,
                        'semibold': 60, 'semi bold': 60,
                        'bold': 70,
                        'extrabold': 80, 'extra bold': 80,
                        'black': 90,
                        'heavy': 95
                    };

                    Array.from(allWeights).sort((a, b) => {
                        const wa = weightOrder[a.toLowerCase()] || 100; // Default to end if unknown
                        const wb = weightOrder[b.toLowerCase()] || 100;
                        if (wa !== wb) return wa - wb;
                        return a.localeCompare(b); // Fallback to alphabetical
                    }).forEach(weight => {
                        const chip = document.createElement('label');
                        chip.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-secondary); cursor: pointer; padding: 4px 8px; background: var(--bg-subtle); border-radius: 4px; border: 1px solid transparent; transition: all 0.1s; user-select: none;';

                        // Hover effect
                        chip.onmouseenter = () => { chip.style.borderColor = 'var(--border-subtle)'; };
                        chip.onmouseleave = () => { chip.style.borderColor = 'transparent'; };

                        const cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.checked = true; // Default all on
                        cb.style.margin = '0';

                        // GLOBAL TOGGLE LOGIC
                        cb.onclick = (e) => {
                            const isChecked = e.target.checked;
                            // Find all variant checkboxes that match this weight name.
                            // We can identify them by the text content of their sibling label.
                            // Or better/robust: add a data attribute to the variant row or input during render.

                            // Let's assume we will add data-weight attribute to the inputs in render below.
                            const allStyleInputs = container.querySelectorAll(`input[data-weight="${weight}"]`);
                            allStyleInputs.forEach(input => {
                                input.checked = isChecked;
                                // Optional: Update visual parent state? (Group checkboxes)
                                // Ideally we'd trigger a massive update or use event bubbling but manual is faster here.
                            });
                            updateSelectedCount();
                        };

                        const span = document.createElement('span');
                        span.textContent = weight;

                        chip.appendChild(cb);
                        chip.appendChild(span);
                        shortcutsContainer.appendChild(chip);
                    });

                    container.appendChild(shortcutsContainer);
                }

                // --- Step 2: Render Sections & Grids ---

                // CSS (Injecting for self-contained component logic)
                const s_Section = 'margin-bottom: 24px; animation: fadeIn 0.3s ease-out;';
                const s_SectionHeader = 'display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);';
                const s_SectionTitle = 'font-size: 14px; font-weight: 700; color: var(--text-primary); text-transform: capitalize; letter-spacing: 0.5px;';
                const s_Badge = 'background: var(--bg-hover); color: var(--text-secondary); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;';

                // Grid of Cards
                // Using auto-fill/minmax for responsive card sizing like the reference image
                const s_GridContainer = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px;';

                // The Card
                const s_Card = 'background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s;';

                const s_CardHeader = 'background: var(--bg-subtle); padding: 8px 12px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;';
                const s_CardTitle = 'font-size: 12px; font-weight: 600; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';

                const s_CardBody = 'padding: 8px; flex: 1; display: flex; flex-direction: column; gap: 4px;';

                // Variant Row inside Card
                const s_VariantRow = 'display: flex; align-items: center; gap: 8px; padding: 4px 6px; border-radius: 4px; cursor: pointer; transition: background 0.1s;';
                const s_VariantLabel = 'font-size: 11px; color: var(--text-secondary); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';

                Object.keys(hierarchy).sort().forEach((mainGroup, l1Index) => {
                    const subGroups = hierarchy[mainGroup];
                    const niceMainGroup = mainGroup.charAt(0).toUpperCase() + mainGroup.slice(1); // Capitalize

                    // SECTION CONTAINER
                    const section = document.createElement('div');
                    section.style.cssText = s_Section;

                    // SECTION HEADER
                    const sectionHeader = document.createElement('div');
                    sectionHeader.style.cssText = s_SectionHeader;

                    const chevron = document.createElement('div');
                    chevron.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                    chevron.style.color = 'var(--text-tertiary)';
                    chevron.style.cursor = 'pointer';
                    chevron.style.transition = 'transform 0.2s';

                    const title = document.createElement('span');
                    title.textContent = niceMainGroup;
                    title.style.cssText = s_SectionTitle;

                    const countBadge = document.createElement('span');
                    const totalStyles = Object.values(subGroups).reduce((acc, arr) => acc + arr.length, 0);
                    countBadge.textContent = `${totalStyles}`;
                    countBadge.style.cssText = s_Badge;

                    // Master Checkbox for Section
                    const cbSection = document.createElement('input');
                    cbSection.type = 'checkbox';
                    cbSection.checked = true;
                    cbSection.style.marginLeft = 'auto'; // Right align
                    cbSection.title = 'Toggle all in this group';

                    sectionHeader.appendChild(chevron);
                    sectionHeader.appendChild(title);
                    sectionHeader.appendChild(countBadge);
                    sectionHeader.appendChild(cbSection);
                    section.appendChild(sectionHeader);

                    // GRID CONTAINER
                    const grid = document.createElement('div');
                    grid.style.cssText = s_GridContainer;

                    // SECTION COLLAPSE LOGIC
                    let isExpanded = true;
                    chevron.onclick = () => {
                        isExpanded = !isExpanded;
                        grid.style.display = isExpanded ? 'grid' : 'none';
                        chevron.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(-90deg)';
                    };

                    // SECTION CHECKBOX LOGIC
                    cbSection.onclick = (e) => {
                        const isChecked = e.target.checked;
                        const allBoxes = grid.querySelectorAll('input[type="checkbox"]');
                        allBoxes.forEach(b => b.checked = isChecked);
                        updateSelectedCount();
                    };

                    // RENDER CARDS (Subgroups)
                    Object.keys(subGroups).sort().forEach(subGroup => {
                        const stylesInSub = subGroups[subGroup];

                        const card = document.createElement('div');
                        card.className = 'subgroup-card'; // For finding via DOM if needed
                        card.style.cssText = s_Card;

                        // Card Hover Effect (JS instead of CSS class for inline simplicity)
                        card.onmouseenter = () => { card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)'; card.style.borderColor = 'var(--border-color)'; };
                        card.onmouseleave = () => { card.style.boxShadow = 'none'; card.style.borderColor = 'var(--border-subtle)'; };

                        // CARD HEADER
                        const cardHeader = document.createElement('div');
                        cardHeader.style.cssText = s_CardHeader;

                        const cardTitle = document.createElement('span');
                        cardTitle.textContent = subGroup === 'Base' ? 'Styles' : subGroup;
                        cardTitle.style.cssText = s_CardTitle;

                        const cbCard = document.createElement('input');
                        cbCard.type = 'checkbox';
                        cbCard.checked = true;

                        // Card Checkbox Logic
                        cbCard.onclick = (e) => {
                            e.stopPropagation();
                            const isChecked = e.target.checked;
                            const variantBoxes = body.querySelectorAll('input[type="checkbox"]');
                            variantBoxes.forEach(b => b.checked = isChecked);
                            updateSelectedCount();
                        };

                        cardHeader.appendChild(cardTitle);
                        cardHeader.appendChild(cbCard);
                        card.appendChild(cardHeader);

                        // CARD BODY (Variants List)
                        const body = document.createElement('div');
                        body.style.cssText = s_CardBody;

                        stylesInSub.forEach(style => {
                            const row = document.createElement('div');
                            row.style.cssText = s_VariantRow;

                            row.onmouseenter = () => row.style.backgroundColor = 'var(--bg-hover)';
                            row.onmouseleave = () => row.style.backgroundColor = 'transparent';

                            // Row click toggles checkbox
                            row.onclick = (e) => {
                                if (e.target.type !== 'checkbox') {
                                    const cb = row.querySelector('input');
                                    cb.checked = !cb.checked;
                                    cb.dispatchEvent(new Event('change'));
                                }
                            };

                            const cbVariant = document.createElement('input');
                            cbVariant.type = 'checkbox';
                            cbVariant.id = `${type}-style-${style.originalIndex}`;
                            cbVariant.checked = true;
                            cbVariant.dataset.type = type;
                            cbVariant.dataset.index = style.originalIndex;
                            cbVariant.dataset.weight = style.weightName; // ADDED FOR GLOBAL SHORTCUTS
                            cbVariant.style.margin = '0';
                            cbVariant.onchange = updateSelectedCount;

                            const label = document.createElement('span');
                            label.textContent = style.weightName;
                            label.style.cssText = s_VariantLabel;

                            // Preview Aa (Tiny)
                            // const fontSize = Math.min(style.fontSize || 12, 14);
                            // const preview = document.createElement('span');
                            // preview.textContent = 'Aa';
                            // preview.style.fontSize = `${fontSize}px`;
                            // preview.style.lineHeight = '1';
                            // preview.style.color = 'var(--text-tertiary)';

                            row.appendChild(cbVariant);
                            row.appendChild(label);
                            // row.appendChild(preview);
                            body.appendChild(row);
                        });

                        card.appendChild(body);
                        grid.appendChild(card);
                    });

                    section.appendChild(grid);
                    container.appendChild(section);
                });
            } else {
                // Flat list for EFFECT styles (untouched logic)
                styles.forEach((style, index) => {
                    // ... same flat logic as before ...
                    const item = document.createElement('div');
                    item.className = 'style-item';
                    item.style.display = 'flex';
                    item.style.alignItems = 'center';
                    item.style.gap = '8px';
                    item.style.padding = '8px';
                    item.style.borderBottom = '1px solid var(--border-subtle)';

                    let previewHtml = '';
                    if (type === 'effect') {
                        previewHtml = `<div class="shadow-preview" style="box-shadow: ${style.shadowPreview || '0 2px 4px rgba(0,0,0,0.2)'}; margin-left: auto;"></div>`;
                    }

                    item.innerHTML = `
                            <input type="checkbox" id="${type}-style-${index}" checked data-type="${type}" data-index="${index}">
                            <div class="style-info" style="flex: 1; overflow: hidden;">
                                <span class="style-name" style="display:block; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">${style.name}</span>
                                <span class="style-details" style="display:block; font-size: 10px; color: var(--text-tertiary);">${style.details || ''}</span>
                            </div>
                            ${previewHtml}
                        `;

                    const checkbox = item.querySelector('input');
                    checkbox.onchange = updateSelectedCount;

                    container.appendChild(item);
                });
            }

        } catch (err) {
            console.error('Render Error:', err);
            container.innerHTML = `<div style="padding: 10px; color: #ff4d4d;">Error: ${err.message}</div>`;
        }
    }

    // Update selected count
    function updateSelectedCount() {
        const textChecked = textStylesList.querySelectorAll('input[type="checkbox"]:checked').length;
        const effectChecked = effectStylesList.querySelectorAll('input[type="checkbox"]:checked').length;
        const total = textChecked + effectChecked;
        selectedCountSpan.textContent = total;
        createStylesBtn.disabled = total === 0;
    }

    // Select/Deselect helpers
    function setupSelectButtons() {
        document.querySelector('.select-all-text')?.addEventListener('click', () => {
            textStylesList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateSelectedCount();
        });
        document.querySelector('.deselect-all-text')?.addEventListener('click', () => {
            textStylesList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateSelectedCount();
        });
        document.querySelector('.select-all-effects')?.addEventListener('click', () => {
            effectStylesList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateSelectedCount();
        });
        document.querySelector('.deselect-all-effects')?.addEventListener('click', () => {
            effectStylesList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateSelectedCount();
        });
    }
    setupSelectButtons();

    // ==================== TOKENS MODE EVENTS ====================
    sourceCollection.onchange = () => {
        console.log('ð Aliases: Collection changed', sourceCollection.value);
        parent.postMessage({ pluginMessage: { type: 'get-groups-for-alias', collectionId: sourceCollection.value } }, '*');
    };

    createBtn.onclick = () => {
        if (!sourceCollection.value || !measureGroup.value || !typoGroup.value) {
            alert('Please select Source Collection, Measures Group and Typography Group');
            return;
        }

        const targetName = targetNameInput.value.trim() || 'Tokens';

        const config = {
            sourceCollectionId: sourceCollection.value,
            measureGroup: measureGroup.value,
            typoGroup: typoGroup.value,
            targetName: targetName
        };

        console.log('ð Creating aliases with config:', config);

        parent.postMessage({
            pluginMessage: {
                type: 'create-aliases',
                config
            }
        }, '*');
    };

    // ==================== STYLES MODE EVENTS ====================
    stylesCollection.onchange = () => {
        console.log('ð Styles: Collection changed', stylesCollection.value);
        scanBtn.disabled = false;
        // Reset state
        stylesCategories.style.display = 'none';
        createStylesBtn.style.display = 'none';
        noVarsWarning.style.display = 'none';
    };

    scanBtn.onclick = () => {
        if (!stylesCollection.value) {
            alert('Please select a Collection');
            return;
        }

        scanBtn.disabled = true;
        scanBtn.innerHTML = '<span class="icon animate-spin">â³</span> Scanning...';

        parent.postMessage({
            pluginMessage: {
                type: 'scan-for-styles',
                collectionId: stylesCollection.value,
                prefix: stylesPrefixInput.value.trim() // Allow empty
            }
        }, '*');
    };

    createStylesBtn.onclick = () => {
        // Collect selected styles
        const selectedTextStyles = [];
        const selectedEffectStyles = [];

        textStylesList.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
            const index = parseInt(cb.dataset.index);
            if (scannedStyles.textStyles[index]) {
                selectedTextStyles.push(scannedStyles.textStyles[index]);
            }
        });

        effectStylesList.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
            const index = parseInt(cb.dataset.index);
            if (scannedStyles.effectStyles[index]) {
                selectedEffectStyles.push(scannedStyles.effectStyles[index]);
            }
        });

        if (selectedTextStyles.length === 0 && selectedEffectStyles.length === 0) {
            alert('Please select at least one style to create');
            return;
        }

        console.log('ð Creating styles:', {
            textStyles: selectedTextStyles.length,
            effectStyles: selectedEffectStyles.length
        });

        parent.postMessage({
            pluginMessage: {
                type: 'create-figma-styles',
                collectionId: stylesCollection.value,
                prefix: stylesPrefixInput.value.trim(),
                textStyles: selectedTextStyles,
                effectStyles: selectedEffectStyles
            }
        }, '*');
    };
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAliases);
} else {
    initAliases();
}


/* --- theme.js --- */
// Theme Generator Logic
console.log('ð Theme script loaded');

function initTheme() {
    console.log('ð Initializing Theme section...');

    // UI Elements
    const sourceCollection = document.getElementById('theme-source-collection');
    const sourceGroup = document.getElementById('theme-source-group');
    const loadBtn = document.getElementById('load-palettes-btn');

    // Selects
    const accentSelect = document.getElementById('theme-accent-palette');
    const neutralSelect = document.getElementById('theme-neutral-palette');
    const successSelect = document.getElementById('theme-success-palette');
    const warningSelect = document.getElementById('theme-warning-palette');
    const errorSelect = document.getElementById('theme-error-palette');

    // Main Actions
    const themeNameInput = document.getElementById('theme-name');
    const createThemeBtn = document.getElementById('create-theme-btn');

    // Preview Sections
    const previewSection = document.getElementById('theme-preview-section');
    const previewBoard = document.getElementById('theme-preview-board');
    const viewLightBtn = document.getElementById('view-light');
    const viewDarkBtn = document.getElementById('view-dark');

    if (!loadBtn) {
        console.warn('â ï¸ Theme UI elements not found');
        return;
    }

    // State
    let loadedPalettes = [];
    let generatedThemeData = null;
    let tokenOverrides = {}; // Store user overrides
    let currentPreviewMode = 'light'; // 'light' or 'dark'

    // Mode Elements
    const modeGenerateBtn = document.getElementById('mode-generate');
    const modeEditBtn = document.getElementById('mode-edit');
    const modeGenerateSection = document.getElementById('theme-mode-generate');
    const modeEditSection = document.getElementById('theme-mode-edit');
    const configSection = document.querySelector('.form-section:nth-of-type(3)'); // Step 2

    // Edit Elements
    const editCollectionSelect = document.getElementById('theme-edit-collection');
    const editGroupSelect = document.getElementById('theme-edit-group');
    const loadExistingBtn = document.getElementById('load-existing-theme-btn');

    // Message Listener
    window.addEventListener('plugin-message', (event) => {
        const { type, payload } = event.detail;

        if (type === 'load-collections') {
            sourceCollection.innerHTML = '<option value="" disabled selected>Select collection...</option>';
            editCollectionSelect.innerHTML = '<option value="" disabled selected>Select theme...</option>';

            payload.forEach(c => {
                // Populate both dropdowns
                const opt1 = document.createElement('option');
                opt1.value = c.id;
                opt1.textContent = c.name;
                sourceCollection.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = c.id;
                opt2.textContent = c.name;
                editCollectionSelect.appendChild(opt2);
            });
            console.log('ð Theme: Collections loaded');

        } else if (type === 'load-groups-theme') {
            sourceGroup.innerHTML = '<option value="">All groups</option>';
            payload.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = g;
                sourceGroup.appendChild(opt);
            });
            console.log('ð Theme: Groups loaded');
            sourceGroup.disabled = false;

        } else if (type === 'load-groups-theme-edit') { // For Edit Mode
            if (editGroupSelect) {
                editGroupSelect.innerHTML = '<option value="">All groups</option>';
                payload.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g;
                    opt.textContent = g;
                    editGroupSelect.appendChild(opt);
                });
                editGroupSelect.disabled = false;
            }

        } else if (type === 'load-palettes') {
            loadedPalettes = payload;

            const fill = (sel, placeholder) => {
                sel.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
                loadedPalettes.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    opt.textContent = p.name;
                    sel.appendChild(opt);
                });
                sel.disabled = false;
            };

            fill(accentSelect, 'Select accent palette...');
            fill(neutralSelect, 'Select neutral palette...');
            fill(successSelect, 'Select success palette...');
            fill(warningSelect, 'Select warning palette...');
            fill(errorSelect, 'Select error palette...');

            alert(`Loaded ${loadedPalettes.length} palettes!`);

        } else if (type === 'theme-generated' || type === 'theme-regenerated' || type === 'theme-loaded-for-edit') {
            generatedThemeData = payload;

            // Hide Step 2 if in Edit Mode? NO, we want to SHOW it now if we have config
            if (type === 'theme-loaded-for-edit') {
                generatedThemeData = payload; // Important: update global data

                // Extract paletteData first for custom dropdowns
                if (payload.paletteData) {
                    paletteData = payload.paletteData;
                    console.log('ð Palette Data loaded for edit mode:', paletteData);
                    Object.keys(paletteData).forEach(paletteName => {
                        console.log(`  ${paletteName}:`, Object.keys(paletteData[paletteName]).length, 'colors');
                    });
                }

                // 1. Populate Dropdowns - use availablePalettes OR generate from paletteData
                let palettes = [];
                if (payload.availablePalettes && payload.availablePalettes.length > 0) {
                    palettes = payload.availablePalettes;
                } else if (payload.paletteData) {
                    // Generate palettes from paletteData keys
                    // The paletteData has keys like: accent, neutral, success, warning, error
                    // But we need to also load the original palettes from the collection
                    // For now, at least show what we have and mark them as detected
                    console.log('â ï¸ No availablePalettes, using detected palettes from theme tokens');

                    // We'll show detected palette info but selectores need to load proper palettes
                    // Enable dropdowns with "Detected" values
                }

                if (palettes.length > 0) {
                    const fill = (sel, placeholder) => {
                        sel.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
                        palettes.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p.name;
                            opt.textContent = p.name;
                            sel.appendChild(opt);
                        });
                        sel.disabled = false;
                    };

                    fill(accentSelect, 'Select accent palette...');
                    fill(neutralSelect, 'Select neutral palette...');
                    fill(successSelect, 'Select success palette...');
                    fill(warningSelect, 'Select warning palette...');
                    fill(errorSelect, 'Select error palette...');
                } else if (loadedPalettes && loadedPalettes.length > 0) {
                    // Use previously loaded palettes if available
                    console.log('ð¦ Using previously loaded palettes:', loadedPalettes.length);
                    const fill = (sel, placeholder) => {
                        sel.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
                        loadedPalettes.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p.name;
                            opt.textContent = p.name;
                            sel.appendChild(opt);
                        });
                        sel.disabled = false;
                    };

                    fill(accentSelect, 'Select accent palette...');
                    fill(neutralSelect, 'Select neutral palette...');
                    fill(successSelect, 'Select success palette...');
                    fill(warningSelect, 'Select warning palette...');
                    fill(errorSelect, 'Select error palette...');
                }

                // 2. Select Detected Values
                if (payload.detectedConfig) {
                    const c = payload.detectedConfig;
                    if (c.accent && accentSelect) accentSelect.value = c.accent;
                    if (c.neutral && neutralSelect) neutralSelect.value = c.neutral;
                    if (c.status.success && successSelect) successSelect.value = c.status.success;
                    if (c.status.warning && warningSelect) warningSelect.value = c.status.warning;
                    if (c.status.error && errorSelect) errorSelect.value = c.status.error;
                }

                // 3. Show Config Section (Step 2)
                if (configSection) {
                    configSection.style.display = 'block';
                    // Update header to indicate editing?
                    const h3 = configSection.querySelector('h3');
                    if (h3) h3.textContent = 'Step 2: Re-Map Palettes (Edit Mode)';
                }

                if (previewSection) previewSection.style.display = 'block';
                if (payload.themeName && themeNameInput) themeNameInput.value = payload.themeName;
                if (createThemeBtn) createThemeBtn.textContent = 'Update Theme Collection'; // Rebrand button
                if (createThemeBtn) createThemeBtn.disabled = false;

            } else {
                if (previewSection) previewSection.style.display = 'block';
                if (createThemeBtn) createThemeBtn.disabled = false;
            }

            console.log('ð Theme Data Ready:', payload);
            renderPreview();
            renderTokenEditor();
        }
    });

    // --- Mode Toggles ---
    const setMode = (mode) => {
        if (!modeGenerateBtn || !modeEditBtn) return;

        if (mode === 'generate') {
            modeGenerateBtn.classList.add('active');
            modeEditBtn.classList.remove('active');

            if (modeGenerateSection) modeGenerateSection.style.display = 'block';
            if (modeEditSection) modeEditSection.style.display = 'none';
            if (configSection) configSection.style.display = 'block'; // Show Step 2
        } else {
            modeEditBtn.classList.add('active');
            modeGenerateBtn.classList.remove('active');

            if (modeEditSection) modeEditSection.style.display = 'block';
            if (modeGenerateSection) modeGenerateSection.style.display = 'none';
            if (configSection) configSection.style.display = 'none'; // Hide Step 2
        }
    };

    modeGenerateBtn.onclick = () => setMode('generate');
    modeEditBtn.onclick = () => setMode('edit');

    // --- Events ---

    sourceCollection.onchange = () => {
        parent.postMessage({ pluginMessage: { type: 'get-groups-for-theme', collectionId: sourceCollection.value } }, '*');
    };

    // Edit Collection Change
    if (editCollectionSelect) {
        editCollectionSelect.onchange = () => {
            parent.postMessage({ pluginMessage: { type: 'get-groups-custom', collectionId: editCollectionSelect.value, returnType: 'load-groups-theme-edit' } }, '*');
        };
    }

    loadBtn.onclick = () => {
        if (!sourceCollection.value) {
            alert('Select a collection first');
            return;
        }
        loadBtn.textContent = 'Loading...';
        parent.postMessage({
            pluginMessage: {
                type: 'load-palettes',
                collectionId: sourceCollection.value,
                groupName: sourceGroup.value
            }
        }, '*');
        setTimeout(() => loadBtn.textContent = 'Load Palettes', 1500);
    };

    if (loadExistingBtn) {
        loadExistingBtn.onclick = () => {
            if (!editCollectionSelect.value) {
                alert('Select a theme collection to edit');
                return;
            }
            // Request to load theme data
            parent.postMessage({
                pluginMessage: {
                    type: 'load-existing-theme',
                    collectionId: editCollectionSelect.value,
                    groupName: editGroupSelect ? editGroupSelect.value : null
                }
            }, '*');
        };
    }

    // Live Preview / Regeneration Logic
    const triggerRegeneration = () => {
        if (!accentSelect.value || !neutralSelect.value) return;

        // Gather current overrides from the UI if any
        const currentOverrides = {};
        document.querySelectorAll('.token-override-select').forEach(sel => {
            const token = sel.dataset.token;
            const mode = sel.dataset.mode;
            const val = sel.value;
            if (val) {
                if (!currentOverrides[token]) currentOverrides[token] = {};
                currentOverrides[token][mode] = val;
            }
        });

        const msg = {
            type: 'generate-theme',
            accentPalette: accentSelect.value,
            neutralPalette: neutralSelect.value,
            statusPalettes: {
                success: successSelect.value,
                warning: warningSelect.value,
                error: errorSelect.value
            },
            themeName: themeNameInput.value.trim(),
            tokenOverrides: currentOverrides, // Send existing overrides so they aren't lost
            isRegenerate: true // Flag to tell backend this is a live update
        };

        console.log('ð Auto-updating preview...', msg);
        parent.postMessage({ pluginMessage: msg }, '*');
    };

    [accentSelect, neutralSelect, successSelect, warningSelect, errorSelect].forEach(sel => {
        if (sel) sel.onchange = triggerRegeneration;
    });

    createThemeBtn.onclick = () => {
        if (!generatedThemeData) return;
        parent.postMessage({
            pluginMessage: {
                type: 'create-theme',
                themeData: generatedThemeData
            }
        }, '*');
    };

    // Toggle Preview Mode
    viewLightBtn.onclick = () => {
        currentPreviewMode = 'light';
        viewLightBtn.classList.add('active');
        viewDarkBtn.classList.remove('active');
        renderPreview();
    };

    viewDarkBtn.onclick = () => {
        currentPreviewMode = 'dark';
        viewDarkBtn.classList.add('active');
        viewLightBtn.classList.remove('active');
        renderPreview();
    };

    // --- Render Logic ---

    function renderPreview() {
        if (!generatedThemeData || !generatedThemeData.preview) return;

        const p = generatedThemeData.preview[currentPreviewMode];
        const isDark = currentPreviewMode === 'dark';

        // Helper for consistent small styles
        const cardStyle = `background-color: ${p.surface.card}; border: 1px solid ${p.border.default}; border-radius: 8px; padding: 20px;box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);`;
        const labelStyle = `display: block; font-size: 11px; font-weight: 600; margin-bottom: 6px; color: ${p.text.secondary}; letter-spacing: 0.025em; text-transform: uppercase;`;

        previewBoard.innerHTML = `
            <div data-tokens="Background/primary Text/primary" style="background-color: ${p.bg.primary}; color: ${p.text.primary}; padding: 32px; transition: background 0.3s; font-family: 'Inter', sans-serif; min-height: 480px;">
                
                <!-- Navbar -->
                <nav data-tokens="Border/subtle Text/brand Text/primary Text/secondary" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 40px; padding-bottom: 16px; border-bottom: 1px solid ${p.border.subtle || p.border.default};">
                    <div data-tokens="Text/brand" style="font-weight: 700; font-size: 18px; color: ${p.text.brand || p.text.primary}; letter-spacing: -0.02em;">Acme Inc.</div>
                    <div style="display: flex; gap: 24px; font-size: 14px;">
                        <span data-tokens="Text/primary" style="color: ${p.text.primary}; font-weight: 500;">Dashboard</span>
                        <span data-tokens="Text/secondary" style="color: ${p.text.secondary};">Team</span>
                        <span data-tokens="Text/secondary" style="color: ${p.text.secondary};">Projects</span>
                    </div>
                </nav>

                <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; max-width: 900px; margin: 0 auto;">
                    
                    <!-- Main Content Column -->
                    <div style="display: flex; flex-direction: column; gap: 24px;">
                        
                        <!-- Header -->
                        <div>
                            <h1 data-tokens="Text/primary" style="font-size: 24px; font-weight: 700; color: ${p.text.primary}; margin: 0 0 8px 0;">Settings</h1>
                            <p data-tokens="Text/secondary" style="color: ${p.text.secondary}; margin: 0; font-size: 14px;">Manage your team members and permissions.</p>
                        </div>

                        <!-- Main Form Card -->
                        <div data-tokens="Surface/card Border/default" style="${cardStyle}">
                            <div style="margin-bottom: 20px;">
                                <h2 data-tokens="Text/primary" style="font-size: 16px; font-weight: 600; margin: 0 0 4px 0; color: ${p.text.primary};">Profile Information</h2>
                                <p data-tokens="Text/secondary" style="font-size: 13px; color: ${p.text.secondary}; margin: 0;">Update your account's profile information and email address.</p>
                            </div>

                            <!-- Input Group -->
                            <div style="margin-bottom: 16px;">
                                <label data-tokens="Text/secondary" style="${labelStyle}">Username</label>
                                <div data-tokens="Border/default Background/tertiary" style="display: flex; border: 1px solid ${p.border.default}; border-radius: 6px; overflow: hidden;">
                                    <span data-tokens="Background/tertiary Text/secondary" style="background: ${p.bg.tertiary || p.bg.secondary}; color: ${p.text.secondary}; padding: 8px 12px; font-size: 13px; border-right: 1px solid ${p.border.default};">acme.com/</span>
                                    <input data-tokens="Background/primary Text/primary" type="text" value="johndoe" style="flex: 1; border: none; padding: 8px 12px; font-size: 13px; background: ${p.bg.primary}; color: ${p.text.primary}; outline: none;">
                                </div>
                            </div>
                            
                            <!-- Input Focus State Mockup -->
                            <div style="margin-bottom: 24px;">
                                <label data-tokens="Text/secondary" style="${labelStyle}">Email Address</label>
                                <input data-tokens="Border/focus Action/primary Background/primary Text/primary" type="text" value="john@example.com" style="width: 100%; border: 1px solid ${p.border.focus}; box-shadow: 0 0 0 3px ${p.action.primary}20; border-radius: 6px; padding: 8px 12px; font-size: 13px; background: ${p.bg.primary}; color: ${p.text.primary}; outline: none;">
                                <span data-tokens="Text/secondary" style="display: block; margin-top: 4px; font-size: 11px; color: ${p.text.tertiary || p.text.secondary};">We'll never share your email with anyone else.</span>
                            </div>

                            <!-- Actions -->
                            <div data-tokens="Border/subtle" style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid ${p.border.subtle || p.border.default};">
                                <button data-tokens="Action/primary" style="background-color: ${p.action.primary}; color: #ffffff; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 500; font-size: 13px; cursor: pointer;">Save Changes</button>
                                <button data-tokens="Text/primary Border/default" style="background-color: transparent; color: ${p.text.primary}; border: 1px solid ${p.border.strong || p.border.default}; padding: 8px 16px; border-radius: 6px; font-weight: 500; font-size: 13px; cursor: pointer;">Cancel</button>
                            </div>
                        </div>

                    </div>

                    <!-- Sidebar Column -->
                    <div style="display: flex; flex-direction: column; gap: 24px;">
                        
                        <!-- Status Cards -->
                        <div data-tokens="Surface/card Border/default" style="${cardStyle}">
                            <h3 data-tokens="Text/secondary" style="font-size: 13px; font-weight: 600; text-transform: uppercase; color: ${p.text.secondary}; margin: 0 0 16px 0; letter-spacing: 0.05em;">System Status</h3>
                            
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <!-- Success -->
                                <div data-tokens="Status/successBg Status/success" style="display: flex; gap: 12px; align-items: start; padding: 12px; border-radius: 6px; background: ${p.status.successBg}; border: 1px solid ${p.status.success}30;">
                                    <div data-tokens="Status/success" style="width: 8px; height: 8px; border-radius: 50%; background: ${p.status.success}; margin-top: 6px;"></div>
                                    <div>
                                        <div data-tokens="Status/success" style="font-size: 13px; font-weight: 600; color: ${p.status.success};">All Systems Operational</div>
                                        <div data-tokens="Status/success" style="font-size: 12px; color: ${p.status.success}; opacity: 0.9;">No incidents reported today.</div>
                                    </div>
                                </div>

                                <!-- Warning -->
                                <div data-tokens="Status/warningBg Status/warning" style="display: flex; gap: 12px; align-items: start; padding: 12px; border-radius: 6px; background: ${p.status.warningBg}; border: 1px solid ${p.status.warning}30;">
                                    <div data-tokens="Status/warning" style="width: 8px; height: 8px; border-radius: 50%; background: ${p.status.warning}; margin-top: 6px;"></div>
                                    <div>
                                        <div data-tokens="Status/warning" style="font-size: 13px; font-weight: 600; color: ${p.status.warning};">Storage Warning</div>
                                        <div data-tokens="Status/warning" style="font-size: 12px; color: ${p.status.warning}; opacity: 0.9;">85% of standard storage used.</div>
                                    </div>
                                </div>

                                <!-- Error -->
                                <div data-tokens="Status/errorBg Status/error" style="display: flex; gap: 12px; align-items: start; padding: 12px; border-radius: 6px; background: ${p.status.errorBg}; border: 1px solid ${p.status.error}30;">
                                    <div data-tokens="Status/error" style="width: 8px; height: 8px; border-radius: 50%; background: ${p.status.error}; margin-top: 6px;"></div>
                                    <div>
                                        <div data-tokens="Status/error" style="font-size: 13px; font-weight: 600; color: ${p.status.error};">Connection Failed</div>
                                        <div data-tokens="Status/error" style="font-size: 12px; color: ${p.status.error}; opacity: 0.9;">Unable to sync with database.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal/Overlay Preview (Mini) -->
                        <div data-tokens="Surface/overlay Border/default" style="position: relative; height: 160px; border-radius: 8px; overflow: hidden; border: 1px solid ${p.border.default};">
                             <div data-tokens="Surface/overlay" style="position: absolute; inset: 0; background: ${p.surface.overlay || '#00000080'}; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
                                <div data-tokens="Surface/modal Text/primary" style="background: ${p.surface.modal}; padding: 16px; border-radius: 8px; width: 80%; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                                    <div data-tokens="Text/primary" style="font-size: 13px; font-weight: 600; color: ${p.text.primary}; margin-bottom: 4px;">Confirm Deletion</div>
                                    <p data-tokens="Text/secondary" style="font-size: 11px; color: ${p.text.secondary}; margin-bottom: 12px;">Are you sure?</p>
                                    <button data-tokens="Action/destructive" style="width: 100%; background: ${p.action.destructive}; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; font-weight: 500;">Delete Everything</button>
                                </div>
                             </div>
                        </div>

                    </div>
                </div>
            </div>
        `;

        // --- NEW PREVIEW INTERACTION LOGIC ---

        // 1. Tooltip Element
        let tooltip = document.getElementById('preview-tooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'preview-tooltip';
            tooltip.style.cssText = `
                position: fixed; pointer-events: none; z-index: 9999;
                background: rgba(0,0,0,0.85); color: white; padding: 6px 10px;
                border-radius: 4px; font-size: 11px; font-weight: 500;
                display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1);
            `;

            document.body.appendChild(tooltip);
        }

        // 2. Attach Events to Elements with Tokens
        setTimeout(() => {
            const elements = previewBoard.querySelectorAll('[data-tokens]');
            elements.forEach(el => {
                // Style cursor to indicate clickable
                el.style.cursor = 'crosshair';

                el.addEventListener('mouseenter', (e) => {
                    e.stopPropagation(); // Prefer inner elements
                    // Highlight self
                    el.style.outline = '2px dashed #18A0FB';

                    // Show Tooltip
                    const tokenList = el.dataset.tokens.replace(/ /g, ', ');
                    tooltip.textContent = tokenList;
                    tooltip.style.display = 'block';
                });

                el.addEventListener('mousemove', (e) => {
                    tooltip.style.left = (e.clientX + 12) + 'px';
                    tooltip.style.top = (e.clientY + 12) + 'px';
                });

                el.addEventListener('mouseleave', () => {
                    el.style.outline = '';
                    tooltip.style.display = 'none';
                });

                el.addEventListener('click', (e) => {
                    // Check if there's a more specific child element with data-tokens
                    // between the click target and this element
                    let target = e.target;
                    let hasMoreSpecificChild = false;

                    // Walk up from target to this element
                    while (target && target !== el) {
                        if (target.hasAttribute && target.hasAttribute('data-tokens')) {
                            // Found a child element with data-tokens
                            hasMoreSpecificChild = true;
                            break;
                        }
                        target = target.parentElement;
                    }

                    if (hasMoreSpecificChild) {
                        // Let the more specific child handle it
                        return;
                    }

                    // This is the most specific element, handle the click
                    e.stopPropagation();

                    // Robust parsing: split by space, trim, remove empty strings
                    const tokens = el.dataset.tokens.split(' ').map(t => t.trim()).filter(Boolean);

                    console.log('ð±ï¸ Clicked element with tokens:', tokens);

                    if (tokens.length > 0) {
                        let scrolled = false;
                        let foundAny = false;

                        tokens.forEach(tokenName => {
                            const safeName = tokenName.replace(/\//g, '-');
                            const targetId = `token-row-${safeName}`;
                            const targetRow = document.getElementById(targetId);

                            console.log(`  Looking for ID: "${targetId}"`, targetRow ? 'â Found' : 'â Not found');

                            if (targetRow) {
                                foundAny = true;
                                // Scroll to the FIRST compatible row found
                                if (!scrolled) {
                                    // First, ensure the parent <details> is open
                                    const parentDetails = targetRow.closest('details');
                                    if (parentDetails && !parentDetails.open) {
                                        console.log('ð Opening parent accordion');
                                        parentDetails.open = true;
                                    }

                                    // Add "Back to Preview" button to the summary
                                    if (parentDetails) {
                                        const summary = parentDetails.querySelector('summary');
                                        // Remove any existing back button first
                                        document.querySelectorAll('.back-to-preview-btn').forEach(b => b.remove());

                                        if (summary && !summary.querySelector('.back-to-preview-btn')) {
                                            const backBtn = document.createElement('button');
                                            backBtn.className = 'back-to-preview-btn secondary btn-sm';
                                            backBtn.style.cssText = 'margin-left: auto; padding: 4px 8px; font-size: 11px;';
                                            backBtn.innerHTML = `<span class="icon" style="margin-right: 4px;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg></span>Preview`;
                                            backBtn.onclick = (evt) => {
                                                evt.stopPropagation();
                                                previewBoard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                            };
                                            summary.appendChild(backBtn);
                                        }
                                    }

                                    // Use scrollIntoView which works better with accordions
                                    console.log('ð Scrolling to row');
                                    setTimeout(() => {
                                        targetRow.scrollIntoView({
                                            behavior: 'smooth',
                                            block: 'center',
                                            inline: 'nearest'
                                        });
                                    }, parentDetails && !parentDetails.open ? 100 : 0);

                                    scrolled = true;
                                }
                                // Flash ALL compatible rows
                                console.log('â¡ Adding flash effect to row');
                                targetRow.classList.add('editor-flash');
                                setTimeout(() => targetRow.classList.remove('editor-flash'), 1500);
                            } else {
                                console.warn('Target row not found:', safeName);
                            }
                        });

                        if (!foundAny) {
                            console.warn('No valid token rows found for:', tokens);
                        }
                    }
                });
            });
        }, 100); // Small delay to ensure DOM render
    }

    function renderTokenEditor() {
        if (!generatedThemeData || !generatedThemeData.tokens) return;

        console.log('ð Rendering Token Editor...');
        const { tokens, paletteData } = generatedThemeData;

        // Clear containers
        const containers = {
            bg: document.getElementById('editor-bg'),
            text: document.getElementById('editor-text'),
            action: document.getElementById('editor-action'),
            border: document.getElementById('editor-border'),
            status: document.getElementById('editor-status')
        };

        Object.values(containers).forEach(el => { if (el) el.innerHTML = ''; });

        // DEBUG: Log palette data to see what we're working with
        console.log('ð Palette Data received:', paletteData);
        if (paletteData && typeof paletteData === 'object') {
            Object.keys(paletteData).forEach(paletteName => {
                const colors = paletteData[paletteName];
                if (colors && typeof colors === 'object') {
                    console.log(`  ${paletteName}:`, Object.keys(colors).length, 'colors', colors);
                }
            });
        } else {
            console.warn('â ï¸ Palette Data is not available');
        }

        // Helper: Determine which palette a token should use
        const getPaletteForToken = (tokenName) => {
            // Status tokens
            if (tokenName.startsWith('Status/success')) return 'success';
            if (tokenName.startsWith('Status/warning')) return 'warning';
            if (tokenName.startsWith('Status/error')) return 'error';
            if (tokenName.startsWith('Status/info')) return 'accent';

            // Destructive actions (use error palette)
            if (tokenName.startsWith('Action/destructive')) return 'error';

            // Other actions and buttons (use accent)
            if (tokenName.startsWith('Action/') || tokenName.startsWith('Button/')) return 'accent';

            // Backgrounds
            if (tokenName.startsWith('Background/brand') || tokenName.startsWith('Background/accent')) return 'accent';

            // Text
            if (tokenName.startsWith('Text/brand') || tokenName.startsWith('Text/link')) return 'accent';

            // Badges
            if (tokenName.startsWith('Badge/brand')) return 'accent';

            // Navigation
            if (tokenName.startsWith('Nav/')) return 'accent';

            // Icons
            if (tokenName.startsWith('Icon/brand')) return 'accent';

            // Borders - check error first, then brand/focus
            if (tokenName.startsWith('Border/error')) return 'error';
            if (tokenName.startsWith('Border/brand') || tokenName.startsWith('Border/focus')) return 'accent';

            // Inputs
            if (tokenName.startsWith('Input/borderFocus')) return 'accent';

            // Default to neutral for everything else
            return 'neutral';
        };

        // Generate custom dropdown with color swatches
        const generateCustomSelect = (paletteColors, currentValue, overrideValue, tokenName, mode) => {
            if (!paletteColors || Object.keys(paletteColors).length === 0) {
                // Fallback to generic if palette data missing
                const steps = [0, 50, 100, 200, 300, 400, 500, 600, 700, 800, 900, 950];
                paletteColors = {};
                steps.forEach(s => paletteColors[s] = '#cccccc');
            }

            const targetVal = overrideValue ? String(overrideValue) : String(currentValue);

            // Smart fallback: if targetVal doesn't exist in palette, find nearest available value
            let actualTargetVal = targetVal;
            if (!paletteColors[targetVal]) {
                const availableScales = Object.keys(paletteColors).map(Number).sort((a, b) => a - b);
                const requestedScale = Number(targetVal);

                // Find closest scale
                let closest = availableScales[0];
                let minDiff = Math.abs(requestedScale - closest);

                for (const scale of availableScales) {
                    const diff = Math.abs(requestedScale - scale);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closest = scale;
                    }
                }

                actualTargetVal = String(closest);
                console.warn(`â ï¸ ${tokenName} ${mode} requested ${targetVal} but palette only has ${availableScales.join(', ')}. Using closest: ${closest}`);
            }

            const selectedHex = paletteColors[actualTargetVal] || '#cccccc';

            // Create unique ID for this dropdown
            const dropdownId = `dropdown-${tokenName.replace(/\//g, '-')}-${mode}`;

            // Generate options HTML
            const optionsHtml = Object.entries(paletteColors)
                .sort((a, b) => Number(a[0]) - Number(b[0]))
                .map(([scale, hex]) => {
                    const isSelected = actualTargetVal === scale;
                    return `
                        <div class="custom-option ${isSelected ? 'selected' : ''}" data-value="${scale}" data-hex="${hex}">
                            <span class="color-swatch" style="background: ${hex};"></span>
                            <span class="scale-value">${scale}</span>
                        </div>
                    `;
                }).join('');

            return `
                <div class="custom-select" data-token="${tokenName}" data-mode="${mode}" id="${dropdownId}">
                    <div class="custom-select-trigger">
                        <span class="color-swatch" style="background: ${selectedHex};"></span>
                        <span class="scale-value">${actualTargetVal}</span>
                        <span class="dropdown-arrow">â¼</span>
                    </div>
                    <div class="custom-options">
                        ${optionsHtml}
                    </div>
                </div>
            `;
        };

        // Helper: Create Token Row
        const createRow = (name, token) => {
            const row = document.createElement('div');
            // Create a safe ID string: replace / with -
            const safeName = name.replace(/\//g, '-');
            row.id = `token-row-${safeName}`;
            row.className = 'token-row';
            // Removed inline styles - using CSS class now

            const getScale = (n) => {
                if (!n) return '500';
                const parts = n.split(/[\/\- ]/);
                return parts[parts.length - 1];
            };

            const lightStep = getScale(token.light.name);
            const darkStep = getScale(token.dark.name);

            // Get Overrides if any
            const overrideLight = tokenOverrides[name] && tokenOverrides[name].light;
            const overrideDark = tokenOverrides[name] && tokenOverrides[name].dark;

            // Determine which palette to use for this token
            const paletteName = getPaletteForToken(name);
            const paletteColors = paletteData[paletteName] || {};

            row.innerHTML = `
                <div class="token-row-header">
                    <span class="token-name">${name.split('/')[1]}</span>
                    <span class="token-palette-badge">${paletteName}</span>
                </div>
                <div class="token-mode-row">
                    <label class="mode-label">L</label>
                    <div class="color-preview" style="background: ${token.light.hex};" title="${token.light.hex}"></div>
                    ${generateCustomSelect(paletteColors, lightStep, overrideLight, name, 'light')}
                </div>
                <div class="token-mode-row">
                    <label class="mode-label">D</label>
                    <div class="color-preview" style="background: ${token.dark.hex};" title="${token.dark.hex}"></div>
                    ${generateCustomSelect(paletteColors, darkStep, overrideDark, name, 'dark')}
                </div>
            `;

            // Highlighter Events
            const highlightMatch = () => {
                document.querySelectorAll(`[data-tokens]`).forEach(el => {
                    const tokens = el.dataset.tokens.split(' ');
                    if (tokens.includes(name)) {
                        el.classList.add('preview-highlight');
                    } else {
                        el.classList.remove('preview-highlight');
                    }
                });
            };

            const removeHighlight = () => {
                document.querySelectorAll('.preview-highlight').forEach(el => el.classList.remove('preview-highlight'));
            };

            row.addEventListener('mouseenter', highlightMatch);
            row.addEventListener('mouseleave', removeHighlight);

            return row;
        };

        // Group Tokens into Categories
        Object.entries(tokens).forEach(([name, token]) => {
            let container = containers.bg; // Fallback

            if (name.startsWith('Background/') || name.startsWith('Surface/') || name.startsWith('Overlay/')) {
                container = containers.bg;
            } else if (name.startsWith('Text/') || name.startsWith('Icon/')) {
                container = containers.text;
            } else if (name.startsWith('Action/') || name.startsWith('Button/') || name.startsWith('Input/')) {
                container = containers.action;
            } else if (name.startsWith('Border/')) {
                container = containers.border;
            } else if (name.startsWith('Status/') || name.startsWith('Badge/') || name.startsWith('A11y/')) {
                container = containers.status;
            }

            if (container) {
                container.appendChild(createRow(name, token));
            }
        });

        // Add Listeners for Custom Selects
        document.querySelectorAll('.custom-select').forEach(customSelect => {
            const trigger = customSelect.querySelector('.custom-select-trigger');
            const options = customSelect.querySelectorAll('.custom-option');
            const tokenName = customSelect.dataset.token;
            const mode = customSelect.dataset.mode;

            // Toggle dropdown
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                // Close other dropdowns
                document.querySelectorAll('.custom-select.open').forEach(other => {
                    if (other !== customSelect) other.classList.remove('open');
                });
                customSelect.classList.toggle('open');
            });

            // Handle option selection
            options.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const value = option.dataset.value;
                    const hex = option.dataset.hex;

                    // Update UI
                    options.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');

                    // Update trigger
                    const triggerSwatch = trigger.querySelector('.color-swatch');
                    const triggerValue = trigger.querySelector('.scale-value');
                    triggerSwatch.style.background = hex;
                    triggerValue.textContent = value;

                    // Close dropdown
                    customSelect.classList.remove('open');

                    // Update Overrides
                    if (!tokenOverrides) tokenOverrides = {};
                    if (!tokenOverrides[tokenName]) tokenOverrides[tokenName] = {};
                    tokenOverrides[tokenName][mode] = value;

                    // Trigger Regeneration
                    const msg = {
                        type: 'regenerate-theme',
                        accentPalette: accentSelect.value,
                        neutralPalette: neutralSelect.value,
                        statusPalettes: {
                            success: successSelect.value,
                            warning: warningSelect.value,
                            error: errorSelect.value
                        },
                        themeName: themeNameInput.value.trim(),
                        tokenOverrides: tokenOverrides
                    };

                    // Store scroll position to restore after re-render
                    window.lastEditorScroll = document.getElementById('editor-panel') ? document.getElementById('editor-panel').scrollTop : 0;

                    parent.postMessage({ pluginMessage: msg }, '*');
                });
            });
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.custom-select.open').forEach(select => {
                select.classList.remove('open');
            });
        });

        // Restore Scroll Position if available
        if (typeof window.lastEditorScroll !== 'undefined') {
            const editorPanel = document.getElementById('editor-panel');
            if (editorPanel) {
                editorPanel.scrollTop = window.lastEditorScroll;
                // Optional: clear it to avoid sticking on next manual render
                // window.lastEditorScroll = undefined; 
            }
        }
    }
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTheme);
} else {
    initTheme();
}


/* --- collections.js --- */
// Collections (Documentation) Section Logic
console.log('ð Collections script loaded');

function initCollections() {
    console.log('ð Initializing Collections section...');

    // UI Elements
    const collectionSelect = document.getElementById('collection-select');
    const groupSelect = document.getElementById('group-select');
    const convertBtn = document.getElementById('convert-btn');
    const generateBtn = document.getElementById('generate-btn');
    const resultDiv = document.getElementById('result');

    if (!convertBtn) {
        console.warn('â ï¸ Collections UI elements not found');
        return;
    }

    // Message Listener
    window.addEventListener('plugin-message', (event) => {
        const { type, payload } = event.detail;

        if (type === 'load-collections') {
            collectionSelect.innerHTML = '<option value="" disabled selected>Select collection...</option>';
            payload.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                collectionSelect.appendChild(opt);
            });
            console.log('ð Collections loaded');

        } else if (type === 'load-groups') {
            groupSelect.innerHTML = '<option value="">All Groups</option>';
            payload.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = g;
                groupSelect.appendChild(opt);
            });
            groupSelect.disabled = false;
            console.log('ð Groups loaded');

        } else if (type === 'conversion-result') {
            // Render result in UI
            resultDiv.innerHTML = '';

            if (payload.length === 0) {
                resultDiv.innerHTML = '<p style="color:#666; text-align:center;">No variables found.</p>';
                return;
            }

            payload.forEach(item => {
                const row = document.createElement('div');
                row.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;';

                const info = document.createElement('div');
                info.innerHTML = `
                    <div style="font-weight: 500; font-size: 13px;">${item.name}</div>
                    <div style="font-size: 11px; color: #888;">${item.type}</div>
                `;

                const val = document.createElement('div');
                if (item.type === 'COLOR') {
                    val.style.cssText = 'display:flex; align-items:center; gap:8px;';
                    val.innerHTML = '<span style="font-size: 14px;">ð¨</span>';
                } else {
                    val.textContent = 'Variable';
                }

                row.appendChild(info);
                row.appendChild(val);
                resultDiv.appendChild(row);
            });
        }
    });

    // Events
    collectionSelect.onchange = () => {
        const id = collectionSelect.value;
        console.log('ð Collection changed:', id);
        parent.postMessage({ pluginMessage: { type: 'get-groups', collectionId: id } }, '*');
    };

    convertBtn.onclick = () => {
        const id = collectionSelect.value;
        if (!id) return;

        console.log('ð Converting/Listing JSON...');
        parent.postMessage({
            pluginMessage: {
                type: 'convert-json',
                collectionId: id,
                groupName: groupSelect.value
            }
        }, '*');
        resultDiv.innerHTML = '<p style="color:#666; text-align:center;">Loading...</p>';
    };

    generateBtn.onclick = () => {
        const id = collectionSelect.value;
        if (!id) return;

        console.log('ð Generating canvas documentation...');
        parent.postMessage({
            pluginMessage: {
                type: 'generate-canvas',
                collectionId: id,
                groupName: groupSelect.value
            }
        }, '*');
    };
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCollections);
} else {
    initCollections();
}


/* --- devtools.js --- */
// Dev Tools Section Logic
console.log('ð ï¸ Dev Tools script loaded');

function initDevTools() {
    console.log('ð ï¸ Initializing Dev Tools section...');

    // UI Elements
    const collectionSelect = document.getElementById('devtools-collection');
    const groupSelect = document.getElementById('devtools-group');
    const generateBtn = document.getElementById('generate-export-btn');
    const previewContainer = document.getElementById('export-preview-container');
    const outputElement = document.getElementById('export-output');
    const copyBtn = document.getElementById('copy-export-btn');
    const downloadBtn = document.getElementById('download-export-btn');
    const varsCountBadge = document.getElementById('export-vars-count');
    const formatBadge = document.getElementById('export-format-badge');

    // Options
    const formatRadios = document.querySelectorAll('input[name="export-format"]');
    const namingRadios = document.querySelectorAll('input[name="naming-convention"]');
    const optIncludeModes = document.getElementById('opt-include-modes');
    const optResolveRefs = document.getElementById('opt-resolve-refs');
    const optIncludeMetadata = document.getElementById('opt-include-metadata');

    if (!generateBtn) {
        console.warn('â ï¸ Dev Tools UI elements not found');
        return;
    }

    // State
    let exportedData = '';
    let currentFormat = 'json';

    // Format option highlighting
    formatRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            document.querySelectorAll('.format-option').forEach(opt => opt.classList.remove('active'));
            radio.closest('.format-option').classList.add('active');
            currentFormat = radio.value;
        });
    });

    // Message Listener
    window.addEventListener('plugin-message', (event) => {
        const { type, payload } = event.detail;

        if (type === 'load-collections') {
            // Populate Collection Select
            collectionSelect.innerHTML = '<option value="" disabled selected>Select collection...</option><option value="ALL">All Collections</option>';
            payload.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                collectionSelect.appendChild(option);
            });
            console.log('ð ï¸ Dev Tools: Collections loaded');

        } else if (type === 'load-groups-devtools') {
            groupSelect.innerHTML = '<option value="">All Groups</option>';
            payload.forEach(g => {
                const option = document.createElement('option');
                option.value = g;
                option.textContent = g;
                groupSelect.appendChild(option);
            });
            groupSelect.disabled = false;

        } else if (type === 'export-variables-result') {
            renderExport(payload);
        }
    });

    // Events
    collectionSelect.onchange = () => {
        const val = collectionSelect.value;
        if (val && val !== 'ALL') {
            parent.postMessage({ pluginMessage: { type: 'get-groups-for-devtools', collectionId: val } }, '*');
        } else {
            groupSelect.innerHTML = '<option value="">All Groups</option>';
            groupSelect.disabled = true;
        }
    };

    generateBtn.onclick = () => {
        const collectionId = collectionSelect.value;
        if (!collectionId) {
            alert('Please select a collection first');
            return;
        }

        const format = document.querySelector('input[name="export-format"]:checked').value;
        const naming = document.querySelector('input[name="naming-convention"]:checked').value;

        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="icon animate-spin">â³</span> Generating...';

        parent.postMessage({
            pluginMessage: {
                type: 'export-variables',
                collectionId: collectionId === 'ALL' ? null : collectionId,
                groupName: groupSelect.value || null,
                options: {
                    format,
                    naming,
                    includeModes: optIncludeModes.checked,
                    resolveRefs: optResolveRefs.checked,
                    includeMetadata: optIncludeMetadata.checked
                }
            }
        }, '*');
    };

    function renderExport(data) {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></span> Generate Export';

        if (!data || !data.output) {
            outputElement.innerHTML = '<code>// No variables found</code>';
            previewContainer.style.display = 'block';
            return;
        }

        exportedData = data.output;
        outputElement.innerHTML = `<code>${escapeHtml(data.output)}</code>`;
        varsCountBadge.textContent = `${data.count} variables`;
        formatBadge.textContent = data.format.toUpperCase();
        previewContainer.style.display = 'block';

        // Scroll to preview
        previewContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Copy to clipboard
    copyBtn.onclick = () => {
        if (!exportedData) return;
        navigator.clipboard.writeText(exportedData).then(() => {
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<span class="icon">â</span> Copied!';
            copyBtn.classList.add('success');
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('success');
            }, 2000);
        });
    };

    // Download file
    downloadBtn.onclick = () => {
        if (!exportedData) return;

        const format = document.querySelector('input[name="export-format"]:checked').value;
        const extensions = {
            json: 'json',
            css: 'css',
            scss: 'scss',
            tailwind: 'js',
            typescript: 'ts'
        };
        const ext = extensions[format] || 'txt';
        const filename = `design-tokens.${ext}`;

        const blob = new Blob([exportedData], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    };
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDevTools);
} else {
    initDevTools();
}


/* --- navigation.js --- */
// Navigation and Section Management
const sectionTitles = {
    'scale': { title: 'Color Palettes', desc: 'Generate color scales for your design system.' },
    'measures': { title: 'Measure Generator', desc: 'Create spacing and sizing variables.' },
    'typography': { title: 'Typography System', desc: 'Define font families, sizes, and weights.' },
    'aliases': { title: 'Responsive Semantics', desc: 'Generate semantic tokens that adapt to viewport size.' },
    'theme': { title: 'Theme Generator', desc: 'Create intelligent Light/Dark themes from your color primitives.' },
    'components': { title: 'Atomic Component System', desc: 'Create visual components using your existing tokens and variables.' },
    'collections': { title: 'Documentation', desc: 'View and manage your variable collections.' },
    'devtools': { title: "Dev's Tools", desc: 'Export your design tokens for developers in multiple formats.' }
};

function initNavigation() {
    console.log('ð§­ Initializing Navigation...');
    const navItems = document.querySelectorAll('.nav-item');

    if (navItems.length === 0) {
        console.warn('â ï¸ No nav items found. DOM might not be ready.');
        return;
    }

    navItems.forEach(navItem => {
        navItem.addEventListener('click', () => {
            const section = navItem.dataset.section;
            console.log(`ð Navigating to: ${section}`);

            // Remove active class from all nav items and sections
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));

            // Add active class to clicked nav item and corresponding section
            navItem.classList.add('active');
            const sectionElement = document.getElementById('section-' + section);
            if (sectionElement) {
                sectionElement.classList.add('active');
            } else {
                console.error(`â Section element #section-${section} not found!`);
            }

            // Update page title and description
            const titleInfo = sectionTitles[section];
            if (titleInfo) {
                const titleEl = document.getElementById('page-title');
                const descEl = document.getElementById('page-description');
                if (titleEl) titleEl.textContent = titleInfo.title;
                if (descEl) descEl.textContent = titleInfo.desc;
            }

            // Load collections when entering sections that require them
            if (['theme', 'measures', 'scale', 'typography', 'aliases', 'collections', 'devtools'].includes(section)) {
                console.log(`Using common loader for ${section}`);
                parent.postMessage({ pluginMessage: { type: 'load-collections' } }, '*');
            }
        });
    });
    console.log('â Navigation initialized');
}

// Robust Initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNavigation);
} else {
    initNavigation();
}




        // Initialize navigation immediately
        initNavigation();
    </script>
</body>
</html>