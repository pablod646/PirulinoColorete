<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PirulinoColorete</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 24px;
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            color: #1a1a1a;
            line-height: 1.6;
        }

        h2 {
            margin-top: 0;
            font-size: 18px;
            margin-bottom: 16px;
            font-weight: 600;
            color: #0d0d0d;
            letter-spacing: -0.02em;
        }

        select {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 16px;
            border-radius: 8px;
            border: 1.5px solid #d1d5db;
            font-size: 14px;
            background: white;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        select:hover {
            border-color: #9ca3af;
        }

        select:focus {
            outline: none;
            border-color: #18A0FB;
            box-shadow: 0 0 0 3px rgba(24, 160, 251, 0.1);
        }

        button {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, #18A0FB 0%, #0D8DE3 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(24, 160, 251, 0.2);
            font-family: inherit;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(24, 160, 251, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        #result {
            margin-top: 24px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            min-height: 100px;
        }

        .color-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .color-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .color-preview {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            margin-right: 10px;
            border: 1px solid #ddd;
        }

        .color-info {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .color-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .color-value {
            color: #666;
            font-family: monospace;
            margin-bottom: 4px;
        }

        .a11y-info {
            display: flex;
            gap: 8px;
            font-size: 10px;
        }

        .a11y-badge {
            padding: 2px 6px;
            border-radius: 4px;
            background: #eee;
            color: #555;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .a11y-badge.pass {
            background: #e6f4ea;
            color: #1e8e3e;
        }

        .a11y-badge.fail {
            background: #fce8e6;
            color: #d93025;
        }

        .section-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #0d0d0d;
            letter-spacing: -0.01em;
        }

        .description {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .separator {
            height: 1px;
            background: linear-gradient(90deg, transparent, #e5e7eb 50%, transparent);
            margin: 28px 0;
        }

        .input-group {
            margin-bottom: 18px;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .input-group input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1.5px solid #d1d5db;
            font-size: 14px;
            box-sizing: border-box;
            transition: all 0.2s ease;
            background: white;
            font-family: inherit;
        }

        .input-group input:focus {
            outline: none;
            border-color: #18A0FB;
            box-shadow: 0 0 0 3px rgba(24, 160, 251, 0.1);
        }

        button.primary {
            background: linear-gradient(135deg, #18A0FB 0%, #0D8DE3 100%);
            box-shadow: 0 2px 8px rgba(24, 160, 251, 0.2);
        }

        button.primary:hover {
            box-shadow: 0 4px 12px rgba(24, 160, 251, 0.3);
        }

        button.secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);
        }

        button.secondary:hover {
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        button:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Override generic button? No, use classes */
        /* Tone Editor Modal */
        #token-editor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .editor-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .editor-row {
            margin-bottom: 16px;
        }

        .editor-label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #4b5563;
            display: flex;
            justify-content: space-between;
        }

        .swatch-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
        }

        .picker-chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            background: #f9fafb;
            transition: all 0.2s ease;
        }

        .picker-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #d1d5db;
            background: white;
        }

        .picker-chip.selected {
            border-color: #18A0FB;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(24, 160, 251, 0.3);
        }

        .picker-chip-color {
            width: 100%;
            height: 40px;
            border-radius: 6px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .picker-chip-label {
            font-size: 11px;
            font-weight: 600;
            color: #374151;
            text-align: center;
        }

        .picker-chip-hex {
            font-size: 9px;
            font-family: monospace;
            color: #6b7280;
            text-align: center;
        }

        .picker-chip.selected .picker-chip-label {
            color: #18A0FB;
        }

        /* Interactive Preview Elements */
        [data-token] {
            cursor: pointer;
            position: relative;
        }

        [data-token]:hover::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px dashed #18A0FB;
            border-radius: inherit;
            pointer-events: none;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        }
    </style>
</head>

<body>
    <div class="tabs">
        <div class="tab active" data-tab="scale">1. Colors</div>
        <div class="tab" data-tab="measures">2. Measures</div>
        <div class="tab" data-tab="typography">3. Typography</div>
        <div class="tab" data-tab="aliases">4. Aliases</div>
        <div class="tab" data-tab="theme">5. Theme</div>
        <div class="tab" data-tab="collections">6. Documentation</div>
    </div>

    <!-- Tab 5: Documentation (formerly Collections) -->
    <div id="tab-collections" class="tab-content">
        <h2>Select Collection</h2>
        <select id="collection-select">
            <option value="" disabled selected>Loading collections...</option>
        </select>

        <h2>Select Group (Optional)</h2>
        <select id="group-select" disabled>
            <option value="">All Groups</option>
        </select>

        <div style="display: flex; gap: 8px;">
            <button id="convert-btn" style="flex: 1;">List in UI</button>
            <button id="generate-btn" style="flex: 1; background-color: #2C2C2C;">Generate on Canvas</button>
        </div>

        <div id="result">
            <p style="color: #888; text-align: center; margin-top: 30px;">Select a collection to see colors.</p>
        </div>
    </div>

    <!-- Tab 1: Colors Generator -->
    <div id="tab-scale" class="tab-content active">
        <h2>Color Palettes</h2>
        <p class="description">Generate color scales for your design system.</p>

        <!-- Step 1: Collection -->
        <div class="section-title">1. Collection</div>
        <div class="input-group">
            <label>Target Collection</label>
            <select id="var-collection-select">
                <option value="" disabled selected>Select Collection...</option>
                <option value="NEW_COLLECTION">+ Create New Collection...</option>
            </select>
        </div>
        <input type="text" id="var-collection-custom" placeholder="Enter new collection name"
            style="display: none; width: 100%; padding: 10px 12px; border-radius: 8px; border: 1.5px solid #3b82f6; font-size: 14px; margin-top: 8px; margin-bottom: 16px; background: #eff6ff; transition: all 0.2s ease;">

        <!-- Step 2: Group -->
        <div class="section-title">2. Group (Optional)</div>
        <div class="input-group">
            <label>Target Group</label>
            <select id="var-group-select">
                <option value="">(Root / No Group)</option>
                <option value="NEW_GROUP">+ New Group...</option>
            </select>
        </div>
        <input type="text" id="var-group-custom" placeholder="Enter new group name"
            style="display: none; width: 100%; padding: 10px 12px; border-radius: 8px; border: 1.5px solid #3b82f6; font-size: 14px; margin-top: 8px; margin-bottom: 24px; background: #eff6ff; transition: all 0.2s ease;">

        <div class="separator"></div>

        <!-- Step 3: Add Colors -->
        <div class="section-title">3. Add Colors</div>
        <div
            style="margin-bottom: 20px; background: white; padding: 16px; border-radius: 8px; border: 1.5px solid #e5e7eb;">
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 12px; color: #374151;">Add
                New Color</label>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                <div>
                    <input type="text" id="new-color-name" placeholder="Name (e.g. Primary)"
                        style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1.5px solid #d1d5db; font-size: 14px;">
                </div>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="new-color-hex" placeholder="#Hex"
                        style="flex: 1; padding: 10px 12px; border-radius: 8px; border: 1.5px solid #d1d5db; font-family: monospace; font-size: 14px;">
                    <div id="new-color-swatch"
                        style="width: 40px; height: 40px; border-radius: 8px; background: #f3f4f6; border: 1.5px solid #d1d5db;">
                    </div>
                </div>
            </div>

            <button id="add-color-btn" class="secondary" style="width: 100%;">+ Add to Queue</button>
            <p id="add-error" style="color: #dc2626; font-size: 12px; margin-top: 8px; display: none;">Invalid Input</p>
        </div>

        <!-- 2. Color Queue List -->
        <div id="color-queue-container" style="margin-bottom: 24px;">
            <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 8px; color: #444;">Colors to
                Generate (<span id="queue-count">0</span>)</label>
            <div id="color-queue"
                style="display: flex; flex-direction: column; gap: 8px; min-height: 40px; margin-bottom: 12px;">
                <!-- Queue Items -->
                <p id="empty-queue-msg" style="font-size: 11px; color: #999; font-style: italic;">No colors added yet.
                </p>
            </div>
            <button id="preview-scale-btn" disabled style="background-color: #2C2C2C; width: 100%;">Preview
                Palettes</button>
        </div>

        <!-- Preview Section (Hidden Initially) -->
        <div id="scale-preview-container" style="display: none; border-top: 1px solid #eee; padding-top: 20px;">

            <!-- List of generated colors -->
            <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 12px; color: #444;">Palettes
                Preview</label>
            <div id="scale-list" style="display: flex; flex-direction: column; gap: 24px; margin-bottom: 24px;">
                <!-- Setup for Multiple Palettes -->
            </div>

            <button id="create-vars-btn" class="primary" style="width: 100%;">Create All Variables</button>
        </div>
    </div>

    <!-- Tab 3: Measures -->
    <div id="tab-measures" class="tab-content">
        <h2>Measure Generator</h2>
        <div style="margin-bottom: 20px;">
            <div style="margin-bottom: 12px;">
                <label
                    style="display: block; font-size: 11px; font-weight: 500; margin-bottom: 4px; color: #444;">Values
                    (comma separated)</label>
                <textarea id="measure-values"
                    style="width: 100%; height: 80px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-family: monospace; font-size: 12px; resize: vertical;">0.5, 1, 2, 4, 8, 12, 16, 20, 24, 32, 40, 48, 64, 80, 96</textarea>
                <p style="font-size: 10px; color: #888; margin-top: 4px;">Standard scale. Edit to customize.</p>
            </div>
            <button id="preview-measures-btn" style="background-color: #2C2C2C; margin-bottom: 20px;">Preview
                Measures</button>
        </div>

        <!-- Preview Section -->
        <div id="measure-preview-container" style="display: none; border-top: 1px solid #eee; padding-top: 20px;">
            <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 12px; color: #444;">2.
                Preview</label>
            <div id="measure-list"
                style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; max-height: 150px; overflow-y: auto; padding-right: 4px;">
                <!-- Chips injected here -->
            </div>

            <!-- Configuration Form -->
            <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 12px; color: #444;">3.
                Configuration</label>

            <div style="margin-bottom: 12px;">
                <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Target
                    Collection</label>
                <select id="measure-collection-select"
                    style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                    <option value="" disabled selected>Select Collection...</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Target Group
                    (Parent)</label>
                <select id="measure-group-select"
                    style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                    <option value="">(Root / No Group)</option>
                    <option value="NEW_GROUP">+ New Group...</option>
                </select>
                <input type="text" id="measure-group-custom" placeholder="e.g. Spacing"
                    style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px; margin-top: 8px; display: none;">
            </div>

            <button id="create-measures-btn" style="background-color: #18A0FB;">Create Variables</button>
        </div>
    </div>

    <!-- Tab 4: Typography -->
    <div id="tab-typography" class="tab-content">
        <h2>Typography System</h2>

        <!-- Section 1: Fonts -->
        <div style="margin-bottom: 24px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 12px; color: #333;">1. Font
                Families</label>

            <div style="margin-bottom: 12px;">
                <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Heading Font</label>
                <select id="font-heading" class="font-select"
                    style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                    <option value="" disabled selected>Loading fonts...</option>
                </select>
            </div>
            <div style="margin-bottom: 12px;">
                <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Body Font</label>
                <select id="font-body" class="font-select"
                    style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                    <option value="" disabled selected>Loading fonts...</option>
                </select>
            </div>
            <div style="margin-bottom: 12px;">
                <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Code/Mono Font</label>
                <select id="font-code" class="font-select"
                    style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                    <option value="" disabled selected>Loading fonts...</option>
                </select>
            </div>
        </div>

        <!-- Section 2: Scale Lists -->
        <div style="margin-bottom: 24px;">
            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 12px; color: #333;">2.
                Scales</label>

            <div style="margin-bottom: 16px;">
                <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Font Weights
                    (Numeric)</label>
                <textarea id="typo-weights"
                    style="width: 100%; height: 50px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-family: monospace; font-size: 12px; resize: vertical;">100, 200, 300, 400, 500, 600, 700, 800, 900</textarea>
            </div>

            <div style="margin-bottom: 16px;">
                <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Letter Spacing
                    (%)</label>
                <textarea id="typo-spacing"
                    style="width: 100%; height: 50px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-family: monospace; font-size: 12px; resize: vertical;">-2, -1, 0, 1, 2, 4, 8, 10</textarea>
            </div>

            <div style="margin-bottom: 16px;">
                <label style="font-size: 11px; color: #666; margin-bottom: 4px; display: block;">Font Sizes (px)</label>
                <textarea id="typo-sizes"
                    style="width: 100%; height: 50px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-family: monospace; font-size: 12px; resize: vertical;">8, 10, 12, 14, 16, 18, 20, 24, 30, 36, 48, 60, 72</textarea>
                <p style="font-size: 10px; color: #888; margin-top: 4px;">Will define generic sizes (3xs, 2xs, xs, sm,
                    base, lg...).</p>
            </div>
        </div>

        <!-- Configuration -->
        <div style="border-top: 1px solid #eee; padding-top: 20px;">
            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 12px; color: #333;">3.
                Target</label>

            <div style="margin-bottom: 12px;">
                <select id="typo-collection-select"
                    style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                    <option value="" disabled selected>Select Collection...</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <select id="typo-group-select"
                    style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px;">
                    <option value="">(Root / No Group)</option>
                    <option value="NEW_GROUP">+ New Group...</option>
                </select>
                <input type="text" id="typo-group-custom" placeholder="e.g. Typography" value="Typography"
                    style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px; margin-top: 8px; display: none;">
            </div>

            <button id="create-typo-btn" style="background-color: #18A0FB;">Create Typography Variables</button>
        </div>
    </div>

    <!-- Tab 4 Content: Aliases (New) -->
    <div id="tab-aliases" class="tab-content">
        <div class="section-title">Responsive Semantics üì±üíª</div>
        <p class="section-desc">Generate semantic tokens (H1, Body, Spacers) that adapt to viewport size using Variable
            Modes.</p>

        <!-- Source Config -->
        <div
            style="margin-bottom: 24px; background: #f9f9f9; padding: 12px; border-radius: 6px; border: 1px solid #eee;">
            <label style="display: block; font-size: 11px; font-weight: 600; margin-bottom: 12px; color: #555;">1.
                Source Primitives</label>

            <!-- Collection Selection -->
            <div style="margin-bottom: 12px;">
                <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">Collection with
                    Primitives</label>
                <select id="alias-source-collection"
                    style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;">
                    <option value="" disabled selected>Select Collection...</option>
                </select>
            </div>

            <!-- Measures Group -->
            <div style="margin-bottom: 12px;">
                <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">Measures Group (e.g.
                    Primitives)</label>
                <select id="alias-measures-group"
                    style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;"
                    disabled>
                    <option value="">(Loading...)</option>
                </select>
            </div>

            <!-- Typography Group -->
            <div style="margin-bottom: 8px;">
                <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">Typography
                    Group</label>
                <select id="alias-typo-group"
                    style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;"
                    disabled>
                    <option value="">(Loading...)</option>
                </select>
            </div>
        </div>

        <!-- Target Config -->
        <div class="input-group">
            <label>Target Collection Name</label>
            <input type="text" id="alias-target-name" value="Tokens" placeholder="e.g. Tokens">
        </div>

        <button id="create-aliases-btn" class="primary">Generate Responsive Tokens</button>

        <div class="separator"></div>

        <div class="section-title">Step 2: Text Styles (Atomic Matrix)</div>
        <p class="description">Creates Figma Text Styles (e.g. "H1 / Bold", "H1 / Light") derived from your responsive
            tokens.</p>
        <button id="create-styles-btn" class="secondary" disabled>Generate Text Styles</button>
    </div>

    <!-- Tab 5: Theme Generator -->
    <div id="tab-theme" class="tab-content">
        <h2>üé® Theme Generator</h2>
        <p class="description">Create intelligent Light/Dark themes from your color primitives.</p>

        <!-- Step 1: Configuration -->
        <div id="theme-config-section">
            <div class="section-title">Step 1: Source Collection</div>
            <p class="description">Select where your color palettes are stored</p>

            <div class="input-group">
                <label>Collection</label>
                <select id="theme-source-collection">
                    <option value="" disabled selected>Select collection...</option>
                </select>
            </div>

            <div class="input-group">
                <label>Group (Optional)</label>
                <select id="theme-source-group">
                    <option value="">All groups</option>
                </select>
            </div>

            <button id="load-palettes-btn" class="secondary" style="width: 100%; margin-bottom: 16px;">
                Load Palettes
            </button>

            <div class="separator"></div>

            <div class="section-title">Step 2: Select Palettes</div>

            <div class="input-group">
                <label>Accent Color</label>
                <p style="font-size: 12px; color: #666; margin: 4px 0 8px 0;">Used for actions, buttons, and highlights
                </p>
                <select id="theme-accent-palette" disabled>
                    <option value="" disabled selected>Select accent palette...</option>
                </select>
            </div>

            <div class="input-group">
                <label>Neutral Palette</label>
                <p style="font-size: 12px; color: #666; margin: 4px 0 8px 0;">Used for backgrounds, text, and borders
                </p>
                <select id="theme-neutral-palette" disabled>
                    <option value="" disabled selected>Select neutral palette...</option>
                </select>
            </div>

            <div class="separator"></div>
            <div class="section-title">Step 3: Status Palettes</div>

            <div class="input-group">
                <label>Success Palette</label>
                <select id="theme-success-palette" disabled>
                    <option value="" disabled selected>Select success palette (e.g. Green)...</option>
                </select>
            </div>

            <div class="input-group">
                <label>Warning Palette</label>
                <select id="theme-warning-palette" disabled>
                    <option value="" disabled selected>Select warning palette (e.g. Yellow)...</option>
                </select>
            </div>

            <div class="input-group">
                <label>Error Palette</label>
                <select id="theme-error-palette" disabled>
                    <option value="" disabled selected>Select error palette (e.g. Red)...</option>
                </select>
            </div>

            <div class="separator"></div>

            <div class="input-group">
                <label>Theme Name</label>
                <input type="text" id="theme-name" placeholder="My Theme" value="Theme">
            </div>

            <button id="generate-theme-btn" class="primary" style="width: 100%;" disabled>
                Generate Theme
            </button>

            <!-- Helpful message (shown after theme is generated) -->
            <div id="regenerate-hint"
                style="display: none; margin-top: 12px; padding: 12px; background: #eff6ff; border: 1.5px solid #bae6fd; border-radius: 6px; font-size: 13px; color: #0c4a6e;">
                <div style="display: flex; align-items: start; gap: 8px;">
                    <span style="font-size: 16px;">üí°</span>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">Want to try different palettes?</div>
                        <div style="line-height: 1.5;">Change your palette selections above and click <strong>"Generate
                                Theme"</strong> again to see a new preview.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="separator"></div>

        <!-- Step 2: Preview & Refine (Hidden initially) -->
        <div id="theme-preview-section" style="display: none;">
            <div class="section-title">Step 2: Preview & Refine</div>

            <!-- Mode Toggle -->
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px;">Preview
                    Mode</label>
                <select id="theme-preview-mode" style="width: 200px;">
                    <option value="light">Light Mode</option>
                    <option value="dark">Dark Mode</option>
                </select>
            </div>

            <!-- Component Preview - EXPANDED to show ALL components -->
            <div style="margin-bottom: 24px;">
                <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 12px;">Component
                    Preview</label>
                <div id="theme-preview-mockup"
                    style="padding: 24px; border-radius: 12px; border: 2px dashed #d1d5db; min-height: 600px;">

                    <!-- Grid Layout for better organization -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

                        <!-- LEFT COLUMN -->
                        <div style="display: flex; flex-direction: column; gap: 16px;">

                            <!-- Card with Text -->
                            <div id="preview-card"
                                style="background: white; padding: 20px; border-radius: 8px; border: 1.5px solid #e5e7eb; cursor: pointer;">
                                <h3 id="preview-card-title"
                                    style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600; cursor: pointer;">
                                    Card Title
                                </h3>
                                <p id="preview-card-text"
                                    style="margin: 0 0 12px 0; font-size: 14px; line-height: 1.5; cursor: pointer;">
                                    This is some body text that demonstrates the text color on background.
                                </p>
                                <p id="preview-card-text-tertiary" style="margin: 0; font-size: 12px; cursor: pointer;">
                                    Tertiary text for captions and metadata
                                </p>
                            </div>

                            <!-- Buttons Section -->
                            <div
                                style="background: white; padding: 16px; border-radius: 8px; border: 1.5px solid #e5e7eb;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 12px; color: #6b7280;">
                                    BUTTONS</div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div style="display: flex; gap: 8px;">
                                        <button id="preview-btn-primary"
                                            style="flex: 1; padding: 10px 16px; border-radius: 6px; border: none; font-size: 14px; font-weight: 500; cursor: pointer;">
                                            Primary
                                        </button>
                                        <button id="preview-btn-secondary"
                                            style="flex: 1; padding: 10px 16px; border-radius: 6px; border: 1.5px solid; font-size: 14px; font-weight: 500; cursor: pointer; background: transparent;">
                                            Secondary
                                        </button>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button id="preview-btn-ghost"
                                            style="flex: 1; padding: 10px 16px; border-radius: 6px; border: none; font-size: 14px; font-weight: 500; cursor: pointer; background: transparent;">
                                            Ghost
                                        </button>
                                        <button id="preview-btn-destructive"
                                            style="flex: 1; padding: 10px 16px; border-radius: 6px; border: none; font-size: 14px; font-weight: 500; cursor: pointer;">
                                            Destructive
                                        </button>
                                    </div>
                                    <button id="preview-btn-disabled"
                                        style="padding: 10px 16px; border-radius: 6px; border: none; font-size: 14px; font-weight: 500; cursor: not-allowed; opacity: 0.5;">
                                        Disabled
                                    </button>
                                </div>
                            </div>

                            <!-- Input Fields -->
                            <div
                                style="background: white; padding: 16px; border-radius: 8px; border: 1.5px solid #e5e7eb;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 12px; color: #6b7280;">
                                    INPUT FIELDS</div>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <input id="preview-input-normal" type="text" placeholder="Normal input"
                                        style="padding: 10px 12px; border-radius: 6px; border: 1.5px solid; font-size: 14px; outline: none; cursor: pointer;">
                                    <input id="preview-input-focus" type="text" placeholder="Focus state (click me)"
                                        style="padding: 10px 12px; border-radius: 6px; border: 1.5px solid; font-size: 14px; outline: none; cursor: pointer;">
                                    <input id="preview-input-error" type="text" placeholder="Error state"
                                        style="padding: 10px 12px; border-radius: 6px; border: 1.5px solid; font-size: 14px; outline: none; cursor: pointer;">
                                    <input id="preview-input-disabled" type="text" placeholder="Disabled" disabled
                                        style="padding: 10px 12px; border-radius: 6px; border: 1.5px solid; font-size: 14px; cursor: not-allowed;">
                                </div>
                            </div>

                            <!-- Badges & Tags -->
                            <div
                                style="background: white; padding: 16px; border-radius: 8px; border: 1.5px solid #e5e7eb;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 12px; color: #6b7280;">
                                    BADGES & TAGS</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    <span id="preview-badge-neutral"
                                        style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; cursor: pointer;">
                                        Neutral
                                    </span>
                                    <span id="preview-badge-brand"
                                        style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; cursor: pointer;">
                                        Brand
                                    </span>
                                    <span id="preview-badge-success"
                                        style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; cursor: pointer;">
                                        Success
                                    </span>
                                    <span id="preview-badge-warning"
                                        style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; cursor: pointer;">
                                        Warning
                                    </span>
                                    <span id="preview-badge-error"
                                        style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; cursor: pointer;">
                                        Error
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT COLUMN -->
                        <div style="display: flex; flex-direction: column; gap: 16px;">

                            <!-- Surface Levels (Elevation) -->
                            <div
                                style="background: white; padding: 16px; border-radius: 8px; border: 1.5px solid #e5e7eb;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 12px; color: #6b7280;">
                                    SURFACE ELEVATION</div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div id="preview-surface-0"
                                        style="padding: 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                        Level 0 (Base)
                                    </div>
                                    <div id="preview-surface-1"
                                        style="padding: 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                        Level 1 (Cards)
                                    </div>
                                    <div id="preview-surface-2"
                                        style="padding: 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                        Level 2 (Hover)
                                    </div>
                                    <div id="preview-surface-3"
                                        style="padding: 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                        Level 3 (Dropdowns)
                                    </div>
                                </div>
                            </div>

                            <!-- Navigation -->
                            <div id="preview-nav-container" style="border-radius: 8px; padding: 12px; cursor: pointer;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 12px; color: #6b7280;">
                                    NAVIGATION</div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <div id="preview-nav-item-1"
                                        style="padding: 10px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s;">
                                        Dashboard
                                    </div>
                                    <div id="preview-nav-item-2"
                                        style="padding: 10px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s;">
                                        Projects (Active)
                                    </div>
                                    <div id="preview-nav-item-3"
                                        style="padding: 10px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s;">
                                        Settings
                                    </div>
                                </div>
                            </div>

                            <!-- Status Messages -->
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #6b7280;">
                                    STATUS MESSAGES</div>
                                <div id="preview-success"
                                    style="padding: 12px; border-radius: 6px; font-size: 13px; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <span>‚úÖ</span> <span id="preview-success-text"
                                        style="cursor: pointer; padding: 2px 4px; border-radius: 4px;">Success
                                        message</span>
                                </div>
                                <div id="preview-warning"
                                    style="padding: 12px; border-radius: 6px; font-size: 13px; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <span>‚ö†Ô∏è</span> <span id="preview-warning-text"
                                        style="cursor: pointer; padding: 2px 4px; border-radius: 4px;">Warning
                                        message</span>
                                </div>
                                <div id="preview-error"
                                    style="padding: 12px; border-radius: 6px; font-size: 13px; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <span>‚ùå</span> <span id="preview-error-text"
                                        style="cursor: pointer; padding: 2px 4px; border-radius: 4px;">Error
                                        message</span>
                                </div>
                                <div id="preview-info"
                                    style="padding: 12px; border-radius: 6px; font-size: 13px; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <span>‚ÑπÔ∏è</span> <span id="preview-info-text"
                                        style="cursor: pointer; padding: 2px 4px; border-radius: 4px;">Info
                                        message</span>
                                </div>
                            </div>

                            <!-- Icons -->
                            <div
                                style="background: white; padding: 16px; border-radius: 8px; border: 1.5px solid #e5e7eb;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 12px; color: #6b7280;">
                                    ICONS</div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <span id="preview-icon-default" style="font-size: 20px; cursor: pointer;">üè†</span>
                                    <span id="preview-icon-subtle" style="font-size: 20px; cursor: pointer;">‚öôÔ∏è</span>
                                    <span id="preview-icon-brand" style="font-size: 20px; cursor: pointer;">‚≠ê</span>
                                    <span id="preview-icon-disabled"
                                        style="font-size: 20px; cursor: pointer; opacity: 0.4;">üîí</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Token Assignments -->
            <div style="margin-bottom: 24px;">
                <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 12px;">Token
                    <div id="theme-token-list"
                        style="background: #f9fafb; padding: 16px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; line-height: 1.8;">
                        <!-- Will be populated by JavaScript -->
                    </div>
            </div>

            <!-- Validation Summary -->
            <div id="theme-validation-summary"
                style="margin-bottom: 24px; padding: 16px; border-radius: 8px; background: #f0fdf4; border: 1.5px solid #86efac;">
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 12px;">
                <button id="regenerate-theme-btn" class="secondary" style="flex: 1;">
                    üîÑ Regenerate
                </button>
                <button id="create-theme-btn" class="primary" style="flex: 2;">
                    Create Theme Variables
                </button>
            </div>
        </div>
    </div>

    <!-- Progress Overlay -->
    <div id="progress-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 100; flex-direction: column; justify-content: center; align-items: center;">
        <div class="spinner"
            style="width: 24px; height: 24px; border: 3px solid #E5E7EB; border-top-color: #2563EB; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 12px;">
        </div>
        <div id="progress-message" style="font-weight: 500; color: #1F2937;">Processing...</div>
    </div>

    <style>
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            color: #666;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            color: #18A0FB;
            border-bottom-color: #18A0FB;
        }

        .tab:hover {
            color: #333;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- üî• ULTRA GOD-TIER Component Editor Modal -->
    <div id="token-editor-modal">
        <div class="editor-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <!-- Header -->
            <div
                style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 16px;">
                <div>
                    <h3 id="editor-title" style="margin: 0 0 4px 0; font-size: 18px; font-weight: 700; color: #111;">
                        Edit Component
                    </h3>
                    <div id="editor-component-name" style="font-size: 14px; color: #6b7280; font-weight: 600;">
                        <!-- Component name will be inserted here -->
                    </div>
                </div>
                <button id="editor-close-x"
                    style="width: 32px; height: 32px; padding: 0; background: #f3f4f6; border-radius: 6px; font-size: 18px; line-height: 1;">
                    ‚úï
                </button>
            </div>

            <!-- Filters -->
            <div
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; background: #f9fafb; padding: 16px; border-radius: 8px;">
                <div>
                    <label
                        style="display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                        Filter by State
                    </label>
                    <select id="editor-state-filter"
                        style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1.5px solid #d1d5db; font-size: 13px;">
                        <option value="all">All States</option>
                        <option value="normal">Normal</option>
                        <option value="hover">Hover</option>
                        <option value="active">Active</option>
                        <option value="disabled">Disabled</option>
                        <option value="focus">Focus</option>
                    </select>
                </div>
                <div>
                    <label
                        style="display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                        Edit Mode
                    </label>
                    <select id="editor-mode-filter"
                        style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1.5px solid #d1d5db; font-size: 13px;">
                        <option value="both">Both (Light & Dark)</option>
                        <option value="light">Light Mode Only</option>
                        <option value="dark">Dark Mode Only</option>
                    </select>
                </div>
            </div>

            <!-- Tokens List -->
            <div id="editor-tokens-container" style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Tokens will be dynamically inserted here -->
            </div>

            <!-- Actions -->
            <div
                style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; margin-top: 24px; border-top: 2px solid #e5e7eb;">
                <button id="editor-reset-all" class="secondary" style="width: auto; padding: 10px 20px;">
                    üîÑ Reset All
                </button>
                <button id="editor-apply" class="primary" style="width: auto; padding: 10px 24px;">
                    ‚úì Apply Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let currentThemeData = null;
        let paletteCache = {}; // Start empty, filled by theme-generated
        let tokenOverrides = {}; // { 'Status/error': { light: '50', dark: '900' } }

        // Tabs Logic
        document.querySelectorAll('.tab').forEach(t => {
            t.addEventListener('click', () => {
                // Remove active class
                document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));

                // Add active
                t.classList.add('active');
                document.getElementById('tab-' + t.dataset.tab).classList.add('active');

                // Load collections when Theme tab is opened
                if (t.dataset.tab === 'theme') {
                    parent.postMessage({ pluginMessage: { type: 'load-collections' } }, '*');
                }
            });
        });

        // Backend Messages
        window.onmessage = (event) => {
            const { type, payload } = event.data.pluginMessage;
            if (type === 'load-collections') {
                const select = document.getElementById('collection-select');
                select.innerHTML = '<option value="" disabled selected>Select a collection</option>';
                payload.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.name;
                    select.appendChild(option);
                });
                select.disabled = false;
                // Populate Tab 4 Source
                const aliasSelect = document.getElementById('alias-source-collection');
                aliasSelect.innerHTML = '<option value="" disabled selected>Select Source Collection...</option>';
                payload.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.name;
                    aliasSelect.appendChild(option);
                });

                // Populate Theme Source Collection
                const themeSourceCollection = document.getElementById('theme-source-collection');
                if (themeSourceCollection) {
                    themeSourceCollection.innerHTML = '<option value="" disabled selected>Select collection...</option>';
                    payload.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        themeSourceCollection.appendChild(option);
                    });
                }

                // Populate Tab 1 (Colors) Target Collection
                const varCollectionSelect = document.getElementById('var-collection-select');
                if (varCollectionSelect) {
                    // Keep the "Create New" option which is hardcoded in HTML? 
                    // Actually usually we want to append.
                    // Let's reset but keep the "Create New" option at the end or beginning.
                    // HTML has: <option value="NEW_COLLECTION">+ Create New Collection...</option>

                    varCollectionSelect.innerHTML = '<option value="" disabled selected>Select Collection...</option>';
                    payload.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        varCollectionSelect.appendChild(option);
                    });
                    // Add New Collection option
                    const newOpt = document.createElement('option');
                    newOpt.value = "NEW_COLLECTION";
                    newOpt.textContent = "+ Create New Collection...";
                    varCollectionSelect.appendChild(newOpt);
                }

                // Populate Tab 3 (Measures) Target Collection
                const measureCollectionSelect = document.getElementById('measure-collection-select');
                if (measureCollectionSelect) {
                    measureCollectionSelect.innerHTML = '<option value="" disabled selected>Select Collection...</option>';
                    payload.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        measureCollectionSelect.appendChild(option);
                    });
                }

            } else if (type === 'load-groups') {
                const groupSelect = document.getElementById('group-select');
                groupSelect.innerHTML = '<option value="">All Groups</option>';
                payload.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    groupSelect.appendChild(option);
                });
                groupSelect.disabled = false;
            } else if (type === 'conversion-result') {
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = '';
                if (payload.length === 0) {
                    resultDiv.innerHTML = '<p style="text-align: center;">No colors found in this collection/group.</p>';
                    return;
                }
                payload.forEach(color => {
                    const item = document.createElement('div');
                    item.className = 'color-item';

                    const formatRatings = (ratings) => {
                        if (ratings.includes("Fail")) return "Fail";
                        // Show the highest rating
                        if (ratings.includes("AAA")) return "AAA";
                        if (ratings.includes("AA")) return "AA";
                        return ratings[0];
                    };

                    const whiteRating = formatRatings(color.accessibility.white.ratings);
                    const blackRating = formatRatings(color.accessibility.black.ratings);

                    const whiteClass = whiteRating === 'Fail' ? 'fail' : 'pass';
                    const blackClass = blackRating === 'Fail' ? 'fail' : 'pass';

                    item.innerHTML = `
                        <div class="color-preview" style="background-color: ${color.hex}"></div>
                        <div class="color-info">
                            <span class="color-name">${color.name}</span>
                            <span class="color-value">${color.oklch}</span>
                            <div class="a11y-info">
                                <span class="a11y-badge ${whiteClass}" title="Contrast vs White: ${color.accessibility.white.ratio}">
                                    On White: ${whiteRating}
                                </span>
                                <span class="a11y-badge ${blackClass}" title="Contrast vs Black: ${color.accessibility.black.ratio}">
                                    On Black: ${blackRating}
                                </span>
                            </div>
                        </div>
                    `;
                    resultDiv.appendChild(item);
                });
            } else if (type === 'load-groups-tab2') {
                // Populate Tab 2 Group Select (Reusing logic but specifically for tab 2)
                // Wait, we can reuse load-groups if we know who asked? 
                // Simpler: Just make a new message type to update the specific dropdown.
                const groupSelect = document.getElementById('var-group-select');
                // Keep first 2 options
                groupSelect.innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';
                payload.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    groupSelect.appendChild(option);
                });
            } else if (type === 'load-groups-measures') {
                const groupSelect = document.getElementById('measure-group-select');
                groupSelect.innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';
                payload.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    groupSelect.appendChild(option);
                });
            } else if (type === 'measures-created-success') {
                // Reset Measure Form
                document.getElementById('measure-preview-container').style.display = 'none';
                document.getElementById('measure-list').innerHTML = '';
                // Keep collection/group selected for workflow speed
            } else if (type === 'preview-scale-batch-result') {
                const results = payload; // [{ name: "Red", steps: { 50: { hex: "#...", r,g,b }, ... } }]
                const scaleList = document.getElementById('scale-list');
                const previewContainer = document.getElementById('scale-preview-container');

                scaleList.innerHTML = '';

                results.forEach(res => {
                    const row = document.createElement('div');
                    row.className = 'scale-row';
                    row.dataset.name = res.name; // For sync deletion
                    row.style.cssText = "margin-bottom: 24px; animation: fadeIn 0.3s ease;";

                    // Header
                    const header = document.createElement('div');
                    header.style.cssText = "display: flex; align-items: center; gap: 8px; margin-bottom: 12px;";

                    const dot = document.createElement('div');
                    dot.style.cssText = `width: 12px; height: 12px; border-radius: 50%; background-color: ${res.steps['500'].hex};`;

                    const title = document.createElement('span');
                    title.style.cssText = "font-size: 14px; font-weight: 600; color: #111827;";
                    title.innerText = res.name;

                    header.appendChild(dot);
                    header.appendChild(title);
                    row.appendChild(header);

                    // Swatches Container
                    const swatches = document.createElement('div');
                    swatches.style.cssText = "display: flex; height: 48px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05);";

                    // Order: 50, 100, ... 950
                    const steps = ['50', '100', '200', '300', '400', '500', '600', '700', '800', '900', '950'];
                    const stepWidth = 100 / steps.length;

                    steps.forEach(step => {
                        if (!res.steps[step]) return;

                        const colorData = res.steps[step];
                        const hex = colorData.hex;
                        const isDark = step >= 500;

                        const chip = document.createElement('div');
                        chip.title = `${res.name}-${step}: ${hex}`;
                        chip.style.cssText = `
                            flex: 1;
                            background-color: ${hex};
                            display: flex;
                            align-items: flex-end;
                            justify-content: center;
                            padding-bottom: 6px;
                            cursor: default;
                            transition: transform 0.1s;
                        `;

                        // Font color based on background
                        const textColor = isDark ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.6)';

                        chip.innerHTML = `<span style="font-size: 9px; font-family: monospace; color: ${textColor}; padding: 0 2px; pointer-events: none;">${step}</span>`;

                        chip.onmouseenter = () => {
                            // chip.style.transform = 'scaleY(1.1)'; // simple hover effect
                            // Optional: Show Tooltip
                        };
                        chip.onmouseleave = () => {
                            // chip.style.transform = 'none';
                        };

                        swatches.appendChild(chip);
                    });

                    row.appendChild(swatches);
                    scaleList.appendChild(row);
                });

                previewContainer.style.display = 'block';
                // Scroll to preview
                previewContainer.scrollIntoView({ behavior: 'smooth' }); const tab1Select = document.getElementById('collection-select');
                const tab2Select = document.getElementById('var-collection-select');
                if (tab2Select.children.length <= 1 && tab1Select.children.length > 1) {
                    tab2Select.innerHTML = tab1Select.innerHTML;
                }
            } else if (type === 'variables-created-success') {
                // Reset Multi-Color Form
                colorQueue = []; // Clear state
                renderQueue();   // Update UI

                document.getElementById('scale-preview-container').style.display = 'none';
                document.getElementById('scale-list').innerHTML = '';

                // Clear inputs
                document.getElementById('new-color-name').value = '';
                document.getElementById('new-color-hex').value = '';
                document.getElementById('new-color-swatch').style.backgroundColor = '#eee';

            } else if (type === 'theme-generated' || type === 'theme-regenerated') {
                // Theme generation complete
                currentThemeData = payload;

                // Cache palette data for Tone Editor Picker
                if (payload.paletteData) {
                    paletteCache = payload.paletteData;
                }

                // Show preview section
                themePreviewSection.style.display = 'block';

                // Render preview (preserve current mode)
                const mode = themePreviewMode.value || 'light';
                renderThemePreview(currentThemeData, mode);

                // Render token list
                renderTokenList(currentThemeData.tokens);

                // Render validation
                renderValidation(currentThemeData.validation);

                // Re-enable Generate Theme button so user can regenerate with different palettes
                generateThemeBtn.disabled = false;
                generateThemeBtn.textContent = '‚ú® Generate Theme';

                // Show helpful hint about regenerating
                const regenerateHint = document.getElementById('regenerate-hint');
                if (regenerateHint) {
                    regenerateHint.style.display = 'block';
                }

                // Scroll to preview
                themePreviewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } else if (type === 'theme-created-success') {
                // Backend handles notification
                // figma.notify(payload); // Removed illegal call
                console.log(payload);

                // Reset form
                themePreviewSection.style.display = 'none';
                currentThemeData = null;

                // Reload collections
                parent.postMessage({ pluginMessage: { type: 'load-collections' } }, '*');

            } else if (type === 'load-palettes') {
                // Populate theme palette dropdowns
                const palettes = payload || [];

                if (palettes.length === 0) {
                    const noOption = '<option value="" disabled selected>No palettes found</option>';
                    themeAccentSelect.innerHTML = noOption;
                    themeNeutralSelect.innerHTML = noOption;
                    document.getElementById('theme-success-palette').innerHTML = noOption;
                    document.getElementById('theme-warning-palette').innerHTML = noOption;
                    document.getElementById('theme-error-palette').innerHTML = noOption;
                } else {
                    const defaultOption = (text) => `<option value="" disabled selected>${text}</option>`;

                    themeAccentSelect.innerHTML = defaultOption('Select accent palette...');
                    themeNeutralSelect.innerHTML = defaultOption('Select neutral palette...');

                    const successSelect = document.getElementById('theme-success-palette');
                    const warningSelect = document.getElementById('theme-warning-palette');
                    const errorSelect = document.getElementById('theme-error-palette');

                    successSelect.innerHTML = defaultOption('Select success palette (e.g. Green)...');
                    warningSelect.innerHTML = defaultOption('Select warning palette (e.g. Yellow)...');
                    errorSelect.innerHTML = defaultOption('Select error palette (e.g. Red)...');

                    palettes.forEach(p => {
                        let displayName = p.name;
                        const groupSelect = document.getElementById('theme-source-group');
                        const currentGroup = groupSelect ? groupSelect.value : '';

                        // Clean display name
                        if (currentGroup && displayName.startsWith(currentGroup + '/')) {
                            displayName = displayName.substring(currentGroup.length + 1);
                        }

                        // Helper to create option
                        const createOpt = () => {
                            const opt = document.createElement('option');
                            opt.value = p.name;
                            opt.textContent = displayName;
                            return opt;
                        };

                        themeAccentSelect.appendChild(createOpt());
                        themeNeutralSelect.appendChild(createOpt());
                        successSelect.appendChild(createOpt());
                        warningSelect.appendChild(createOpt());
                        errorSelect.appendChild(createOpt());
                    });

                    // Auto-select status palettes if obvious matches found
                    const autoSelect = (select, ...keywords) => {
                        const options = Array.from(select.options);
                        for (const keyword of keywords) {
                            const match = options.find(o => o.text.toLowerCase().includes(keyword.toLowerCase()));
                            if (match) {
                                select.value = match.value;
                                return;
                            }
                        }
                    };

                    autoSelect(successSelect, 'green', 'success');
                    autoSelect(warningSelect, 'yellow', 'warning', 'orange');
                    autoSelect(errorSelect, 'red', 'error');
                }

                // Enable dropdowns
                themeAccentSelect.disabled = false;
                themeNeutralSelect.disabled = false;
                document.getElementById('theme-success-palette').disabled = false;
                document.getElementById('theme-warning-palette').disabled = false;
                document.getElementById('theme-error-palette').disabled = false;

            } else if (type === 'load-groups-tab1') {
                const groupSelect = document.getElementById('var-group-select');
                // Keep default options: (Root) and + New Group
                groupSelect.innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';

                payload.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    // Insert before "New Group" (last child)
                    groupSelect.insertBefore(option, groupSelect.lastElementChild);
                });

            } else if (type === 'load-groups-tab2') {
                // Populate Tab 2 Group Select (Reusing logic but specifically for tab 2)
                // Wait, we can reuse load-groups if we know who asked? 
                // Simpler: Just make a new message type to update the specific dropdown.
                const groupSelect = document.getElementById('var-group-select');
                // Keep first 2 options
                groupSelect.innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';
                payload.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    groupSelect.appendChild(option);
                });

            } else if (type === 'load-groups-theme') {
                // Populate Theme Source Group Select
                const themeGroupSelect = document.getElementById('theme-source-group');
                themeGroupSelect.innerHTML = '<option value="">All groups</option>';
                payload.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g;
                    opt.textContent = g;
                    themeGroupSelect.appendChild(opt);
                });

            } else if (type === 'selection-contrast-update') {
                // Reuse this existing message for Scale Tab selection Check too?
                // Yes, if we are in Scale Tab, we want to update the swatch.
                const swatch = document.getElementById('scale-swatch');
                const hexLabel = document.getElementById('scale-hex');
                const statusLabel = document.getElementById('scale-status');
                const genBtn = document.getElementById('generate-scale-btn');

                if (payload.status === 'result' || payload.status === 'result-simple') { // We might add a simple mode
                    swatch.style.backgroundColor = payload.fg;
                    hexLabel.textContent = payload.fg;
                    statusLabel.textContent = "Base Color (500)";
                    genBtn.disabled = false;
                } else {
                    swatch.style.backgroundColor = '#eee';
                    hexLabel.textContent = '-';
                    statusLabel.textContent = payload.status === 'no-fill' ? 'Selection has no fill' : 'Select an object';
                    genBtn.disabled = true;
                }
            } else if (type === 'load-fonts') {
                const selects = document.querySelectorAll('.font-select');
                selects.forEach(sel => {
                    sel.innerHTML = '<option value="" disabled>Select Font...</option>'; // Removed selected from placeholder
                    payload.forEach(f => {
                        const op = document.createElement('option');
                        op.value = f;
                        op.textContent = f;
                        sel.appendChild(op);
                    });
                    sel.disabled = false;
                });

                // Set Defaults
                const setVal = (id, val) => {
                    const el = document.getElementById(id);
                    if (payload.includes(val)) el.value = val;
                };
                setVal('font-heading', 'Inter');
                setVal('font-body', 'Inter');
                setVal('font-code', 'DM Mono');
            } else if (type === 'load-groups-typo') {
                const groupSelect = document.getElementById('typo-group-select');
                groupSelect.innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';
                payload.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    groupSelect.appendChild(option);
                });
            } else if (type === 'load-groups-typo-source') {
                const groupSelect = document.getElementById('typo-source-group-select');
                // Don't overwrite default "None" option, just append
                groupSelect.innerHTML = '<option value="" selected>(None - Use Raw Values)</option>';
                payload.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    groupSelect.appendChild(option);
                });
            } else if (type === 'load-groups-alias') {
                const mkOptions = (arr) => '<option value="" disabled selected>Select Group...</option>' + arr.map(g => `<option value="${g}">${g}</option>`).join('');
                const opts = mkOptions(payload);

                const mSelect = document.getElementById('alias-measures-group');
                mSelect.innerHTML = opts;
                mSelect.disabled = false;

                const tSelect = document.getElementById('alias-typo-group');
                tSelect.innerHTML = opts;
                tSelect.disabled = false;

            } else if (type === 'progress-start') {
                document.getElementById('progress-overlay').style.display = 'flex';
                document.getElementById('progress-message').innerText = payload;
            } else if (type === 'progress-update') {
                document.getElementById('progress-message').innerText = payload;
            } else if (type === 'progress-end') {
                document.getElementById('progress-overlay').style.display = 'none';
            } else if (type === 'aliases-created') {
                document.getElementById('create-styles-btn').disabled = false;
                document.getElementById('create-styles-btn').classList.remove('secondary');
                document.getElementById('create-styles-btn').classList.add('primary');
            }
        };

        // Existing Collections Logic
        document.getElementById('collection-select').onchange = (e) => {
            const collectionId = e.target.value;
            const groupSelect = document.getElementById('group-select');
            groupSelect.innerHTML = '<option value="">Loading groups...</option>';
            groupSelect.disabled = true;
            parent.postMessage({ pluginMessage: { type: 'get-groups', collectionId } }, '*');
        };

        document.getElementById('convert-btn').onclick = () => {
            const collectionId = document.getElementById('collection-select').value;
            const group = document.getElementById('group-select').value;
            if (collectionId) {
                parent.postMessage({ pluginMessage: { type: 'convert-collection', collectionId, group } }, '*');
            }
        };

        document.getElementById('generate-btn').onclick = () => {
            const collectionId = document.getElementById('collection-select').value;
            const group = document.getElementById('group-select').value;
            if (collectionId) {
                parent.postMessage({ pluginMessage: { type: 'generate-on-canvas', collectionId, group } }, '*');
            }
        };

        // Tab 2 Collection Change -> Load Groups
        document.getElementById('var-collection-select').onchange = (e) => {
            const collectionId = e.target.value;
            parent.postMessage({ pluginMessage: { type: 'get-groups-for-tab2', collectionId } }, '*');
        };

        // Tab 1 Collection Change -> Show Custom Input if NEW, else load groups
        const varCollectionSelect = document.getElementById('var-collection-select');
        varCollectionSelect.onchange = (e) => {
            const val = e.target.value;
            const customInput = document.getElementById('var-collection-custom');

            if (val === 'NEW_COLLECTION') {
                customInput.style.display = 'block';
                customInput.focus();
                // Disable/Reset groups
                document.getElementById('var-group-select').innerHTML = '<option value="">(Root / No Group)</option><option value="NEW_GROUP">+ New Group...</option>';
            } else {
                customInput.style.display = 'none';

                // Load Groups for Tab 1
                if (val) {
                    parent.postMessage({
                        pluginMessage: {
                            type: 'get-groups-for-tab1',
                            collectionId: val
                        }
                    }, '*');
                }
            }
        };

        // Tab 2 Group Change -> Show Custom Input if NEW
        document.getElementById('var-group-select').onchange = (e) => {
            const val = e.target.value;
            const customInput = document.getElementById('var-group-custom');
            if (val === 'NEW_GROUP') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
            }
        };

        // New Multi-Color Logic
        let colorQueue = [];
        const scaleList = document.getElementById('scale-list'); // Container for results

        // Inputs
        const nameInput = document.getElementById('new-color-name');
        const hexInput = document.getElementById('new-color-hex');
        const swatch = document.getElementById('new-color-swatch');
        const addBtn = document.getElementById('add-color-btn');
        const addError = document.getElementById('add-error');

        const previewBtn = document.getElementById('preview-scale-btn');
        const queueCount = document.getElementById('queue-count');
        const queueList = document.getElementById('color-queue');
        const emptyMsg = document.getElementById('empty-queue-msg');

        // Hex Input Live Preview
        hexInput.addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (CSS.supports('color', val) || /^#([0-9A-F]{3}){1,2}$/i.test(val)) {
                swatch.style.backgroundColor = val;
            } else {
                swatch.style.backgroundColor = '#eee';
            }
        });

        // Add to Queue
        addBtn.onclick = () => {
            const name = nameInput.value.trim();
            let hex = hexInput.value.trim();

            // Basic Validation
            if (!name) {
                addError.textContent = "Name is required.";
                addError.style.display = 'block';
                return;
            }
            // Normalize Hex
            if (!hex.startsWith('#') && /^[0-9A-F]{3,6}$/i.test(hex)) hex = '#' + hex;

            if (!CSS.supports('color', hex) && !/^#([0-9A-F]{3}){1,2}$/i.test(hex)) {
                addError.textContent = "Invalid Hex Color.";
                addError.style.display = 'block';
                return;
            }

            // Check Duplicate Name
            if (colorQueue.find(c => c.name === name)) {
                addError.textContent = "Name already exists in list.";
                addError.style.display = 'block';
                return;
            }

            addError.style.display = 'none';

            // Add to State
            colorQueue.push({ name, hex });
            renderQueue();

            // Perform Visual Reset
            nameInput.value = '';
            hexInput.value = '';
            swatch.style.backgroundColor = '#eee';
            nameInput.focus();
        };

        // Render Queue UI
        const renderQueue = () => {
            queueList.innerHTML = '';

            if (colorQueue.length === 0) {
                queueList.appendChild(emptyMsg);
                previewBtn.disabled = true;
                queueCount.innerText = '0';
                return;
            }

            colorQueue.forEach((c, idx) => {
                const row = document.createElement('div');
                row.className = 'queue-item';
                // Inline styles moved to CSS class ideally, but inline for now with upgrades
                row.style.cssText = "display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; transition: all 0.2s; margin-bottom: 8px;";

                // Hover effect
                row.onmouseenter = () => row.style.borderColor = '#d1d5db';
                row.onmouseleave = () => row.style.borderColor = '#e5e7eb';

                const left = document.createElement('div');
                left.style.cssText = "display: flex; align-items: center; gap: 12px;";

                // Color Preview Dot (Clean Circle)
                const dot = document.createElement('div');
                dot.style.cssText = `width: 24px; height: 24px; border-radius: 50%; background-color: ${c.hex}; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.05);`;

                // Text Info
                const info = document.createElement('div');
                info.style.display = 'flex';
                info.style.flexDirection = 'column';

                const nameEl = document.createElement('span');
                nameEl.style.cssText = "font-size: 13px; font-weight: 600; color: #1f2937; line-height: 1.2;";
                nameEl.innerText = c.name;

                const hexEl = document.createElement('span');
                hexEl.style.cssText = "font-size: 11px; font-weight: 400; color: #6b7280; font-family: monospace;";
                hexEl.innerText = c.hex;

                info.appendChild(nameEl);
                info.appendChild(hexEl);

                left.appendChild(dot);
                left.appendChild(info);

                // Trash Button
                const delBtn = document.createElement('button');
                delBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                    </svg>
                `;
                // Fix: Override global button width: 100%
                delBtn.style.cssText = "width: 32px; height: 32px; background: none; border: none; color: #9ca3af; cursor: pointer; padding: 0; border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-left: 8px;";

                delBtn.onmouseenter = () => {
                    delBtn.style.color = '#ef4444';
                    delBtn.style.backgroundColor = '#fee2e2';
                };
                delBtn.onmouseleave = () => {
                    delBtn.style.color = '#9ca3af';
                    delBtn.style.backgroundColor = 'transparent';
                };

                delBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent row click
                    // sync: Remove from preview if exists
                    const nameToRemove = colorQueue[idx].name;
                    removePreviewCard(nameToRemove);

                    colorQueue.splice(idx, 1);
                    renderQueue();
                };

                row.appendChild(left);
                row.appendChild(delBtn);
                queueList.appendChild(row);
            });

            queueCount.innerText = colorQueue.length;
            previewBtn.disabled = false;
        };

        // Helper: Remove preview card by name
        const removePreviewCard = (name) => {
            const scaleList = document.getElementById('scale-list');
            // Find element with data-name attribute
            const existingCard = Array.from(scaleList.children).find(el => el.dataset.name === name);
            if (existingCard) {
                existingCard.remove();
            }
            // Hide container if empty
            if (scaleList.children.length === 0) {
                document.getElementById('scale-preview-container').style.display = 'none';
            }
        };

        // Generate Preview (Batch)
        previewBtn.onclick = () => {
            if (colorQueue.length === 0) return;
            // Show loading state on button?
            previewBtn.innerText = "Generating Preview...";
            previewBtn.disabled = true;

            parent.postMessage({ pluginMessage: { type: 'preview-scale-batch', colors: colorQueue } }, '*');

            // Re-enable button after slight delay or waiting for response (handled in message listener)
            setTimeout(() => {
                previewBtn.innerText = "Preview Palettes";
                previewBtn.disabled = false;
            }, 1000);
        };

        // Create Variables (Batch)
        document.getElementById('create-vars-btn').onclick = () => {
            let collectionId = document.getElementById('var-collection-select').value;
            let collectionName = null;

            // Collection Logic
            if (collectionId === 'NEW_COLLECTION') {
                collectionName = document.getElementById('var-collection-custom').value.trim();
                if (!collectionName) {
                    alert("Please enter a collection name.");
                    return;
                }
                collectionId = null; // Will be created by backend
            }

            // Group Logic
            const selectVal = document.getElementById('var-group-select').value;
            let groupName = selectVal;
            if (selectVal === 'NEW_GROUP') {
                groupName = document.getElementById('var-group-custom').value.trim();
            }

            if (!collectionId && !collectionName) {
                alert("Please select or create a collection.");
                return;
            }

            if (colorQueue.length === 0) {
                alert("No colors in queue.");
                return;
            }

            parent.postMessage({
                pluginMessage: {
                    type: 'create-variables-batch',
                    colors: colorQueue,
                    config: { collectionId, collectionName, groupName }
                }
            }, '*');
        };

        // === THEME TAB LOGIC ===
        // Removed duplicate declarations of currentThemeData and paletteCache
        // They are now at the top of the script



        const themeAccentSelect = document.getElementById('theme-accent-palette');
        const themeNeutralSelect = document.getElementById('theme-neutral-palette');
        const themeNameInput = document.getElementById('theme-name');
        const generateThemeBtn = document.getElementById('generate-theme-btn');
        const themePreviewSection = document.getElementById('theme-preview-section');
        const themePreviewMode = document.getElementById('theme-preview-mode');
        const regenerateThemeBtn = document.getElementById('regenerate-theme-btn');
        const createThemeBtn = document.getElementById('create-theme-btn');

        // Source collection and group
        const themeSourceCollection = document.getElementById('theme-source-collection');
        const themeSourceGroup = document.getElementById('theme-source-group');
        const loadPalettesBtn = document.getElementById('load-palettes-btn');

        // When source collection selected, load groups (ONLY groups)
        themeSourceCollection.addEventListener('change', () => {
            const collectionId = themeSourceCollection.value;
            if (collectionId) {
                // Load groups for this collection
                parent.postMessage({
                    pluginMessage: {
                        type: 'get-groups-for-theme',
                        collectionId
                    }
                }, '*');
            }
        });

        // Manual Load Palettes Trigger
        loadPalettesBtn.onclick = () => {
            const collectionId = themeSourceCollection.value;
            const groupName = themeSourceGroup.value;

            if (!collectionId) {
                alert('Please select a Source Collection first');
                return;
            }

            // Disable button briefly or show loading state if desired
            loadPalettesBtn.textContent = "Loading...";
            setTimeout(() => { loadPalettesBtn.textContent = "Load Palettes"; }, 1000);

            parent.postMessage({
                pluginMessage: {
                    type: 'load-palettes',
                    collectionId,
                    groupName
                }
            }, '*');
        };

        // Enable generate button when both palettes selected
        function checkThemePalettes() {
            const accentSelected = themeAccentSelect.value !== '';
            const neutralSelected = themeNeutralSelect.value !== '';
            generateThemeBtn.disabled = !(accentSelected && neutralSelected);
        }

        themeAccentSelect.addEventListener('change', checkThemePalettes);
        themeNeutralSelect.addEventListener('change', checkThemePalettes);

        // Generate Theme
        generateThemeBtn.onclick = () => {
            const accentPalette = themeAccentSelect.value;
            const neutralPalette = themeNeutralSelect.value;
            const successPalette = document.getElementById('theme-success-palette').value;
            const warningPalette = document.getElementById('theme-warning-palette').value;
            const errorPalette = document.getElementById('theme-error-palette').value;

            const themeName = themeNameInput.value.trim() || 'Theme';

            if (!accentPalette || !neutralPalette) {
                alert('Please select at least an accent and neutral palette');
                return;
            }

            // Hide regenerate hint while generating
            const regenerateHint = document.getElementById('regenerate-hint');
            if (regenerateHint) {
                regenerateHint.style.display = 'none';
            }

            // Disable button
            generateThemeBtn.disabled = true;
            generateThemeBtn.textContent = 'Generating...';

            parent.postMessage({
                pluginMessage: {
                    type: 'generate-theme',
                    accentPalette,
                    neutralPalette,
                    statusPalettes: {
                        success: successPalette,
                        warning: warningPalette,
                        error: errorPalette
                    },
                    themeName,
                    tokenOverrides // Send overrides
                }
            }, '*');
        };

        // Regenerate Theme
        regenerateThemeBtn.onclick = () => {
            const accentPalette = themeAccentSelect.value;
            const neutralPalette = themeNeutralSelect.value;
            const themeName = themeNameInput.value.trim() || 'Theme';

            // Fix: Include status palettes so they aren't lost on regeneration
            const successPalette = document.getElementById('theme-success-palette').value;
            const warningPalette = document.getElementById('theme-warning-palette').value;
            const errorPalette = document.getElementById('theme-error-palette').value;

            parent.postMessage({
                pluginMessage: {
                    type: 'regenerate-theme',
                    accentPalette,
                    neutralPalette,
                    statusPalettes: {
                        success: successPalette,
                        warning: warningPalette,
                        error: errorPalette
                    },
                    themeName,
                    tokenOverrides // Send overrides
                }
            }, '*');
        };

        // Create Theme
        createThemeBtn.onclick = () => {
            if (!currentThemeData) {
                alert('Please generate a theme first.');
                return;
            }

            parent.postMessage({
                pluginMessage: {
                    type: 'create-theme',
                    themeData: currentThemeData
                }
            }, '*');
        };

        // Preview mode toggle
        themePreviewMode.addEventListener('change', () => {
            if (currentThemeData) {
                renderThemePreview(currentThemeData, themePreviewMode.value);
            }
        });

        // Render theme preview - FIXED for proper dark mode
        function renderThemePreview(themeData, mode) {
            const tokens = themeData.tokens;
            const modeTokens = {};

            // Extract tokens for current mode
            for (const [key, value] of Object.entries(tokens)) {
                modeTokens[key] = mode === 'light' ? value.light : value.dark;
            }

            // Helper to get element
            const get = (id) => document.getElementById(id);

            // Apply to ALL preview components
            const mockup = get('theme-preview-mockup');
            const card = get('preview-card');
            const cardTitle = get('preview-card-title');
            const cardText = get('preview-card-text');
            const cardTextTertiary = get('preview-card-text-tertiary');

            // Buttons
            const btnPrimary = get('preview-btn-primary');
            const btnSecondary = get('preview-btn-secondary');
            const btnGhost = get('preview-btn-ghost');
            const btnDestructive = get('preview-btn-destructive');
            const btnDisabled = get('preview-btn-disabled');

            // Inputs
            const inputNormal = get('preview-input-normal');
            const inputFocus = get('preview-input-focus');
            const inputError = get('preview-input-error');
            const inputDisabled = get('preview-input-disabled');

            // Badges
            const badgeNeutral = get('preview-badge-neutral');
            const badgeBrand = get('preview-badge-brand');
            const badgeSuccess = get('preview-badge-success');
            const badgeWarning = get('preview-badge-warning');
            const badgeError = get('preview-badge-error');

            // Surface levels
            const surface0 = get('preview-surface-0');
            const surface1 = get('preview-surface-1');
            const surface2 = get('preview-surface-2');
            const surface3 = get('preview-surface-3');

            // Navigation
            const navContainer = get('preview-nav-container');
            const navItem1 = get('preview-nav-item-1');
            const navItem2 = get('preview-nav-item-2');
            const navItem3 = get('preview-nav-item-3');

            // Status
            const successMsg = get('preview-success');
            const successText = get('preview-success-text');
            const warningMsg = get('preview-warning');
            const warningText = get('preview-warning-text');
            const errorMsg = get('preview-error');
            const errorText = get('preview-error-text');
            const infoMsg = get('preview-info');
            const infoText = get('preview-info-text');

            // Icons
            const iconDefault = get('preview-icon-default');
            const iconSubtle = get('preview-icon-subtle');
            const iconBrand = get('preview-icon-brand');
            const iconDisabled = get('preview-icon-disabled');

            // === APPLY STYLES ===

            // Background
            mockup.style.background = modeTokens['Background/primary']?.hex || (mode === 'dark' ? '#1a1a1a' : '#fff');

            // Card
            const surfaceToken = modeTokens['Surface/level0'] || modeTokens['Surface/level1'];
            if (card) {
                card.style.background = surfaceToken?.hex || (mode === 'dark' ? '#2a2a2a' : '#fff');
                card.style.borderColor = modeTokens['Border/default']?.hex || (mode === 'dark' ? '#444' : '#e5e7eb');
            }

            // Text
            if (cardTitle) cardTitle.style.color = modeTokens['Text/primary']?.hex || (mode === 'dark' ? '#fff' : '#000');
            if (cardText) cardText.style.color = modeTokens['Text/secondary']?.hex || (mode === 'dark' ? '#ccc' : '#666');
            if (cardTextTertiary) cardTextTertiary.style.color = modeTokens['Text/tertiary']?.hex || (mode === 'dark' ? '#999' : '#888');

            // Buttons
            if (btnPrimary) {
                btnPrimary.style.background = modeTokens['Action/primary']?.hex || '#3b82f6';
                btnPrimary.style.color = modeTokens['Button/primaryText']?.hex || '#fff';
            }
            if (btnSecondary) {
                // Use subtle background instead of transparent
                const secondaryColor = modeTokens['Action/secondary']?.hex || modeTokens['Action/primary']?.hex || '#3b82f6';

                // Try to get a subtle background token, otherwise create one from the secondary color
                let secondaryBg = modeTokens['Action/secondarySubtle']?.hex || modeTokens['Action/primarySubtle']?.hex;

                // If no subtle token exists, use a very light version of the secondary color
                if (!secondaryBg) {
                    // For light mode, use a very light tint; for dark mode, use a dark tint
                    secondaryBg = mode === 'dark'
                        ? 'rgba(59, 130, 246, 0.1)'  // Dark mode: subtle blue tint
                        : 'rgba(59, 130, 246, 0.08)'; // Light mode: very subtle blue tint
                }

                btnSecondary.style.background = secondaryBg;
                btnSecondary.style.borderColor = secondaryColor;
                btnSecondary.style.color = modeTokens['Button/secondaryText']?.hex || secondaryColor;
            }
            if (btnGhost) {
                btnGhost.style.background = modeTokens['Action/ghost']?.hex || 'transparent';
                btnGhost.style.color = modeTokens['Button/ghostText']?.hex || modeTokens['Text/primary']?.hex || (mode === 'dark' ? '#fff' : '#000');
            }
            if (btnDestructive) {
                btnDestructive.style.background = modeTokens['Action/destructive']?.hex || '#dc2626';
                btnDestructive.style.color = '#fff';
            }
            if (btnDisabled) {
                btnDisabled.style.background = modeTokens['Action/primaryDisabled']?.hex || (mode === 'dark' ? '#333' : '#e5e7eb');
                btnDisabled.style.color = modeTokens['Text/disabled']?.hex || (mode === 'dark' ? '#666' : '#9ca3af');
            }

            // Inputs
            if (inputNormal) {
                inputNormal.style.background = modeTokens['Input/background']?.hex || (mode === 'dark' ? '#2a2a2a' : '#fff');
                inputNormal.style.borderColor = modeTokens['Input/border']?.hex || (mode === 'dark' ? '#444' : '#d1d5db');
                inputNormal.style.color = modeTokens['Input/text']?.hex || modeTokens['Text/primary']?.hex || (mode === 'dark' ? '#fff' : '#000');
            }
            if (inputFocus) {
                inputFocus.style.background = modeTokens['Input/backgroundFocus']?.hex || modeTokens['Input/background']?.hex || (mode === 'dark' ? '#2a2a2a' : '#fff');
                inputFocus.style.borderColor = modeTokens['Input/borderFocus']?.hex || modeTokens['Action/primary']?.hex || '#3b82f6';
                inputFocus.style.color = modeTokens['Input/text']?.hex || (mode === 'dark' ? '#fff' : '#000');
            }
            if (inputError) {
                inputError.style.background = modeTokens['Input/background']?.hex || (mode === 'dark' ? '#2a2a2a' : '#fff');
                inputError.style.borderColor = modeTokens['Input/borderError']?.hex || modeTokens['Status/error']?.hex || '#dc2626';
                inputError.style.color = modeTokens['Input/text']?.hex || (mode === 'dark' ? '#fff' : '#000');
            }
            if (inputDisabled) {
                inputDisabled.style.background = modeTokens['Input/backgroundDisabled']?.hex || (mode === 'dark' ? '#1a1a1a' : '#f3f4f6');
                inputDisabled.style.borderColor = modeTokens['Input/border']?.hex || (mode === 'dark' ? '#333' : '#e5e7eb');
                inputDisabled.style.color = modeTokens['Text/disabled']?.hex || (mode === 'dark' ? '#666' : '#9ca3af');
            }

            // Badges
            if (badgeNeutral) {
                badgeNeutral.style.background = modeTokens['Badge/background']?.hex || (mode === 'dark' ? '#333' : '#f3f4f6');
                badgeNeutral.style.color = modeTokens['Badge/text']?.hex || modeTokens['Text/primary']?.hex || (mode === 'dark' ? '#fff' : '#000');
            }
            if (badgeBrand) {
                badgeBrand.style.background = modeTokens['Badge/brandBackground']?.hex || modeTokens['Action/primarySubtle']?.hex || '#dbeafe';
                badgeBrand.style.color = modeTokens['Badge/brandText']?.hex || modeTokens['Action/primary']?.hex || '#3b82f6';
            }
            if (badgeSuccess) {
                badgeSuccess.style.background = modeTokens['Status/successSubtle']?.hex || (mode === 'dark' ? '#1a3a1a' : '#f0fdf4');
                badgeSuccess.style.color = modeTokens['Status/successText']?.hex || modeTokens['Status/success']?.hex || '#16a34a';
            }
            if (badgeWarning) {
                badgeWarning.style.background = modeTokens['Status/warningSubtle']?.hex || (mode === 'dark' ? '#3a3a1a' : '#fef3c7');
                badgeWarning.style.color = modeTokens['Status/warningText']?.hex || modeTokens['Status/warning']?.hex || '#ca8a04';
            }
            if (badgeError) {
                badgeError.style.background = modeTokens['Status/errorSubtle']?.hex || (mode === 'dark' ? '#3a1a1a' : '#fee2e2');
                badgeError.style.color = modeTokens['Status/errorText']?.hex || modeTokens['Status/error']?.hex || '#dc2626';
            }

            // Surface Levels
            if (surface0) {
                surface0.style.background = modeTokens['Surface/level0']?.hex || (mode === 'dark' ? '#1a1a1a' : '#f9fafb');
                surface0.style.color = modeTokens['Text/primary']?.hex || (mode === 'dark' ? '#fff' : '#000');
            }
            if (surface1) {
                surface1.style.background = modeTokens['Surface/level1']?.hex || (mode === 'dark' ? '#2a2a2a' : '#fff');
                surface1.style.color = modeTokens['Text/primary']?.hex || (mode === 'dark' ? '#fff' : '#000');
            }
            if (surface2) {
                surface2.style.background = modeTokens['Surface/level2']?.hex || (mode === 'dark' ? '#333' : '#f3f4f6');
                surface2.style.color = modeTokens['Text/primary']?.hex || (mode === 'dark' ? '#fff' : '#000');
            }
            if (surface3) {
                surface3.style.background = modeTokens['Surface/level3']?.hex || (mode === 'dark' ? '#3a3a3a' : '#e5e7eb');
                surface3.style.color = modeTokens['Text/primary']?.hex || (mode === 'dark' ? '#fff' : '#000');
            }

            // Navigation
            if (navContainer) {
                navContainer.style.background = modeTokens['Nav/background']?.hex || (mode === 'dark' ? '#2a2a2a' : '#f9fafb');
            }
            if (navItem1) {
                navItem1.style.color = modeTokens['Nav/itemDefault']?.hex || modeTokens['Text/secondary']?.hex || (mode === 'dark' ? '#ccc' : '#666');
            }
            if (navItem2) {
                // Active state
                navItem2.style.background = modeTokens['Nav/itemActiveBackground']?.hex || modeTokens['Action/primarySubtle']?.hex || (mode === 'dark' ? '#1e3a5f' : '#dbeafe');
                navItem2.style.color = modeTokens['Nav/itemActive']?.hex || modeTokens['Action/primary']?.hex || '#3b82f6';
            }
            if (navItem3) {
                navItem3.style.color = modeTokens['Nav/itemDefault']?.hex || modeTokens['Text/secondary']?.hex || (mode === 'dark' ? '#ccc' : '#666');
            }

            // Status Messages
            if (successMsg) successMsg.style.background = modeTokens['Status/successSubtle']?.hex || (mode === 'dark' ? '#1a3a1a' : '#f0fdf4');
            if (successText) successText.style.color = modeTokens['Status/successText']?.hex || modeTokens['Status/success']?.hex || '#16a34a';

            if (warningMsg) warningMsg.style.background = modeTokens['Status/warningSubtle']?.hex || (mode === 'dark' ? '#3a3a1a' : '#fef3c7');
            if (warningText) warningText.style.color = modeTokens['Status/warningText']?.hex || modeTokens['Status/warning']?.hex || '#ca8a04';

            if (errorMsg) errorMsg.style.background = modeTokens['Status/errorSubtle']?.hex || (mode === 'dark' ? '#3a1a1a' : '#fee2e2');
            if (errorText) errorText.style.color = modeTokens['Status/errorText']?.hex || modeTokens['Status/error']?.hex || '#dc2626';

            if (infoMsg) infoMsg.style.background = modeTokens['Status/infoSubtle']?.hex || (mode === 'dark' ? '#1a2a3a' : '#eff6ff');
            if (infoText) infoText.style.color = modeTokens['Status/infoText']?.hex || modeTokens['Status/info']?.hex || '#3b82f6';

            // Icons (using filter to change color)
            const iconColor = modeTokens['Icon/default']?.hex || (mode === 'dark' ? '#fff' : '#000');
            const iconSubtleColor = modeTokens['Icon/subtle']?.hex || (mode === 'dark' ? '#999' : '#666');
            const iconBrandColor = modeTokens['Icon/brand']?.hex || '#3b82f6';

            // Note: Can't change emoji color, but we set the container color
            if (iconDefault) iconDefault.style.color = iconColor;
            if (iconSubtle) iconSubtle.style.color = iconSubtleColor;
            if (iconBrand) iconBrand.style.color = iconBrandColor;
            if (iconDisabled) iconDisabled.style.color = modeTokens['Icon/disabled']?.hex || (mode === 'dark' ? '#444' : '#d1d5db');

            // === ADD CLICK HANDLERS ===
            const addClick = (el, componentType, tokenName) => {
                if (!el) return;
                el.dataset.component = componentType;
                el.dataset.token = tokenName;
                el.onclick = (e) => {
                    e.stopPropagation();
                    openComponentEditor(componentType, mode);
                };
            };

            // Background & Surface
            addClick(mockup, 'background', 'Background/primary');
            addClick(card, 'surface', 'Surface/level0');

            // Text
            addClick(cardTitle, 'text', 'Text/primary');
            addClick(cardText, 'text', 'Text/secondary');
            addClick(cardTextTertiary, 'text', 'Text/tertiary');

            // Buttons
            addClick(btnPrimary, 'button-primary', 'Action/primary');
            addClick(btnSecondary, 'button-secondary', 'Action/secondary');
            addClick(btnGhost, 'button-ghost', 'Action/ghost');
            addClick(btnDestructive, 'button-destructive', 'Action/destructive');
            addClick(btnDisabled, 'button-disabled', 'Action/primaryDisabled');

            // Inputs
            addClick(inputNormal, 'input', 'Input/background');
            addClick(inputFocus, 'input', 'Input/borderFocus');
            addClick(inputError, 'input', 'Input/borderError');
            addClick(inputDisabled, 'input', 'Input/backgroundDisabled');

            // Badges
            addClick(badgeNeutral, 'badge', 'Badge/background');
            addClick(badgeBrand, 'badge', 'Badge/brandBackground');
            addClick(badgeSuccess, 'badge-status', 'Status/successSubtle');
            addClick(badgeWarning, 'badge-status', 'Status/warningSubtle');
            addClick(badgeError, 'badge-status', 'Status/errorSubtle');

            // Surface Levels
            addClick(surface0, 'surface', 'Surface/level0');
            addClick(surface1, 'surface', 'Surface/level1');
            addClick(surface2, 'surface', 'Surface/level2');
            addClick(surface3, 'surface', 'Surface/level3');

            // Navigation
            addClick(navContainer, 'navigation', 'Nav/background');
            addClick(navItem1, 'navigation', 'Nav/itemDefault');
            addClick(navItem2, 'navigation', 'Nav/itemActive');
            addClick(navItem3, 'navigation', 'Nav/itemDefault');

            // Status
            addClick(successMsg, 'status-success', 'Status/successSubtle');
            addClick(successText, 'status-success', 'Status/success');
            addClick(warningMsg, 'status-warning', 'Status/warningSubtle');
            addClick(warningText, 'status-warning', 'Status/warning');
            addClick(errorMsg, 'status-error', 'Status/errorSubtle');
            addClick(errorText, 'status-error', 'Status/error');
            addClick(infoMsg, 'status-info', 'Status/infoSubtle');
            addClick(infoText, 'status-info', 'Status/info');

            // Icons
            addClick(iconDefault, 'icon', 'Icon/default');
            addClick(iconSubtle, 'icon', 'Icon/subtle');
            addClick(iconBrand, 'icon', 'Icon/brand');
            addClick(iconDisabled, 'icon', 'Icon/disabled');
        }

        // Render token list with GOD-TIER categorization
        function renderTokenList(tokens) {
            const tokenList = document.getElementById('theme-token-list');

            // Organize tokens by category
            const categories = {
                'Foundation': ['Background', 'Text', 'Surface', 'Border'],
                'Interactive': ['Action'],
                'Components': ['Input', 'Card', 'Button', 'Badge', 'Nav'],
                'Status & Feedback': ['Status'],
                'Overlays': ['Overlay'],
                'Icons': ['Icon'],
                'Accessibility': ['A11y']
            };

            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';

            for (const [categoryName, prefixes] of Object.entries(categories)) {
                // Filter tokens for this category
                const categoryTokens = Object.entries(tokens).filter(([key]) =>
                    prefixes.some(prefix => key.startsWith(prefix + '/'))
                );

                if (categoryTokens.length === 0) continue;

                // Category header
                html += `
                    <div style="border: 1.5px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); padding: 12px 16px; border-bottom: 1.5px solid #e5e7eb;">
                            <div style="font-size: 13px; font-weight: 700; color: #374151; letter-spacing: 0.5px;">
                                ${categoryName} <span style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">${categoryTokens.length}</span>
                            </div>
                        </div>
                        <div style="padding: 12px;">
                `;

                // Tokens in this category
                categoryTokens.forEach(([key, value]) => {
                    const tokenName = key.split('/').pop();
                    html += `
                        <div style="margin-bottom: 12px; padding: 8px; background: white; border-radius: 6px; border: 1px solid #f3f4f6;">
                            <div style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 6px;">${key}</div>
                            <div style="display: grid; grid-template-columns: 40px 1fr; gap: 8px; align-items: center; margin-bottom: 4px;">
                                <div style="font-size: 10px; color: #9ca3af;">Light:</div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="display: inline-block; width: 20px; height: 20px; background: ${value.light.hex}; border: 1.5px solid #d1d5db; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></span>
                                    <span style="font-size: 10px; font-family: monospace; color: #4b5563;">${value.light.hex}</span>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 40px 1fr; gap: 8px; align-items: center;">
                                <div style="font-size: 10px; color: #9ca3af;">Dark:</div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="display: inline-block; width: 20px; height: 20px; background: ${value.dark.hex}; border: 1.5px solid #d1d5db; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></span>
                                    <span style="font-size: 10px; font-family: monospace; color: #4b5563;">${value.dark.hex}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            tokenList.innerHTML = html;
        }

        // Render validation summary
        function renderValidation(validation) {
            const summary = document.getElementById('theme-validation-summary');
            const passCount = validation.passed || 0;
            const warnCount = validation.warnings?.length || 0;

            let html = `<div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">`;
            html += `üî• ${passCount} GOD-TIER tokens generated`;
            if (warnCount > 0) {
                html += ` ‚Ä¢ ‚ö†Ô∏è ${warnCount} warnings`;
            }
            html += `</div>`;

            // Show breakdown
            html += `<div style="font-size: 11px; color: #6b7280; margin-top: 8px;">`;
            html += `Complete coverage: Foundation ‚Ä¢ Interactive ‚Ä¢ Components ‚Ä¢ Status ‚Ä¢ Overlays ‚Ä¢ Icons ‚Ä¢ A11y`;
            html += `</div>`;

            if (warnCount > 0) {
                html += `<div style="font-size: 12px; color: #666; margin-top: 12px;">`;
                validation.warnings.forEach(w => {
                    html += `<div>‚ö†Ô∏è ${w}</div>`;
                });
                html += `</div>`;
            }

            summary.innerHTML = html;

            if (warnCount > 0) {
                summary.style.background = '#fef3c7';
                summary.style.borderColor = '#fbbf24';
            } else {
                summary.style.background = '#f0fdf4';
                summary.style.borderColor = '#86efac';
            }
        }

        // --- MEASURES TAB LOGIC ---

        // Helper: Parse Values
        const parseMeasureInput = () => {
            const raw = document.getElementById('measure-values').value;
            // Split by comma, trim, filter empty, convert to number
            return raw.split(',')
                .map(s => s.trim())
                .filter(s => s !== '')
                .map(s => parseFloat(s))
                .filter(n => !isNaN(n));
        };

        // Preview Measures
        document.getElementById('preview-measures-btn').onclick = () => {
            const values = parseMeasureInput();

            if (values.length > 0) {
                const list = document.getElementById('measure-list');
                list.innerHTML = '';

                values.forEach(val => {
                    const chip = document.createElement('div');
                    chip.style.padding = '4px 8px';
                    chip.style.background = '#f0f0f0';
                    chip.style.borderRadius = '4px';
                    chip.style.fontSize = '12px';
                    chip.style.fontFamily = 'monospace';
                    chip.innerText = `${val}px`;
                    list.appendChild(chip);
                }); // Fixed: Closed forEach callback

                document.getElementById('measure-preview-container').style.display = 'block';

                // Populate Collection Select (Copy from Tab 1 if needed)
                const tab1Select = document.getElementById('collection-select');
                const measureSelect = document.getElementById('measure-collection-select');
                if (measureSelect.children.length <= 1 && tab1Select.children.length > 1) {
                    measureSelect.innerHTML = tab1Select.innerHTML;
                }
            } else {
                alert("Please enter valid numbers.");
            }
        };

        // Measure Collection Change -> Load Groups
        document.getElementById('measure-collection-select').onchange = (e) => {
            const collectionId = e.target.value;
            parent.postMessage({ pluginMessage: { type: 'get-groups-for-measures', collectionId } }, '*');
        };

        // Measure Group Change
        document.getElementById('measure-group-select').onchange = (e) => {
            const val = e.target.value;
            const customInput = document.getElementById('measure-group-custom');
            if (val === 'NEW_GROUP') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
            }
        };

        // Create Measure Variables
        document.getElementById('create-measures-btn').onclick = () => {
            const values = parseMeasureInput();
            const collectionId = document.getElementById('measure-collection-select').value;

            // Group Logic
            const selectVal = document.getElementById('measure-group-select').value;
            let groupName = selectVal;
            if (selectVal === 'NEW_GROUP') {
                groupName = document.getElementById('measure-group-custom').value.trim();
            }

            if (!collectionId || values.length === 0) {
                console.error("Missing fields");
                return;
            }

            parent.postMessage({
                pluginMessage: {
                    type: 'create-measure-variables',
                    values, // Sending array instead of base/steps
                    config: { collectionId, groupName }
                }
            }, '*');
        };
        // --- TYPOGRAPHY TAB LOGIC ---

        let fontsLoaded = false;

        // Tab Switch Listener Enhancement: Load fonts if Typography tab is active
        document.querySelectorAll('.tab').forEach(t => {
            t.addEventListener('click', () => {
                if (t.dataset.tab === 'typography' && !fontsLoaded) {
                    fontsLoaded = true;
                    // Request fonts
                    parent.postMessage({ pluginMessage: { type: 'get-fonts' } }, '*');

                    // Also populate collection select if empty
                    const tab1Select = document.getElementById('collection-select');
                    const typoSelect = document.getElementById('typo-collection-select');
                    if (typoSelect.children.length <= 1 && tab1Select.children.length > 1) {
                        typoSelect.innerHTML = tab1Select.innerHTML;
                    }
                }
            });
        });

        // Backend Messages (Typography Additions)
        // Note: modify window.onmessage to handle 'load-fonts'
        // Since I cannot rewrite the entire onmessage block easily in this tool call without replacing everything,
        // I will rely on the next step to update window.onmessage or inject it here if I replace the whole block?
        // Let's add the handlers below and I'll do a separate edit for onmessage to keep it clean.

        // Typo Collection Change
        document.getElementById('typo-collection-select').onchange = (e) => {
            const collectionId = e.target.value;
            // Load groups for target dropdown
            parent.postMessage({ pluginMessage: { type: 'get-groups-for-typo', collectionId } }, '*');
        };

        // Typo Group Change
        document.getElementById('typo-group-select').onchange = (e) => {
            const val = e.target.value;
            const customInput = document.getElementById('typo-group-custom');
            if (val === 'NEW_GROUP') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
            }
        };

        // Create Typography Variables
        document.getElementById('create-typo-btn').onclick = () => {
            const heading = document.getElementById('font-heading').value;
            const body = document.getElementById('font-body').value;
            const code = document.getElementById('font-code').value;

            const weightsRaw = document.getElementById('typo-weights').value;
            const spacingRaw = document.getElementById('typo-spacing').value;
            const sizesRaw = document.getElementById('typo-sizes').value;

            const collectionId = document.getElementById('typo-collection-select').value;

            // Group Logic
            const selectVal = document.getElementById('typo-group-select').value;
            let groupName = selectVal;
            if (selectVal === 'NEW_GROUP') {
                groupName = document.getElementById('typo-group-custom').value.trim();
            }

            if (!collectionId) {
                alert("Please select a target collection.");
                return;
            }

            // Parse lists
            const weights = weightsRaw.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
            const spacing = spacingRaw.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
            const sizes = sizesRaw.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));

            parent.postMessage({
                pluginMessage: {
                    type: 'create-typography',
                    families: { heading, body, code },
                    weights,
                    spacing,
                    sizes, // New: Font Sizes
                    config: { collectionId, groupName }
                }
            }, '*');
        };

        // --- Tab 4: Aliases Logic ---

        document.getElementById('alias-source-collection').onchange = (e) => {
            const collectionId = e.target.value;
            document.getElementById('alias-measures-group').disabled = true;
            document.getElementById('alias-typo-group').disabled = true;
            document.getElementById('alias-measures-group').innerHTML = '<option>(Loading...)</option>';
            document.getElementById('alias-typo-group').innerHTML = '<option>(Loading...)</option>';

            parent.postMessage({ pluginMessage: { type: 'get-groups-for-alias', collectionId } }, '*');
        };

        document.getElementById('create-aliases-btn').onclick = () => {
            const sourceCollectionId = document.getElementById('alias-source-collection').value;
            const measureGroup = document.getElementById('alias-measures-group').value;
            const typoGroup = document.getElementById('alias-typo-group').value;
            const targetName = document.getElementById('alias-target-name').value;

            if (!sourceCollectionId || !measureGroup || !typoGroup) {
                alert("Please select the source collection and both groups.");
                return;
            }

            parent.postMessage({
                pluginMessage: {
                    type: 'create-aliases',
                    config: { sourceCollectionId, measureGroup, typoGroup, targetName }
                }
            }, '*');
        };

        // Text Styles Generator
        document.getElementById('create-styles-btn').onclick = () => {
            const sourceCollectionId = document.getElementById('alias-source-collection').value;
            const targetName = document.getElementById('alias-target-name').value;
            // Re-fetch groups just in case
            const measureGroup = document.getElementById('alias-measures-group').value;
            const typoGroup = document.getElementById('alias-typo-group').value;

            if (!sourceCollectionId || !typoGroup) {
                alert("Please select Source Collection and Typography Group first.");
                return;
            }

            parent.postMessage({
                pluginMessage: {
                    type: 'create-text-styles',
                    config: { sourceCollectionId, measureGroup, typoGroup, targetName }
                }
            }, '*');
        };

        // === üî• GOD-TIER TONE EDITOR LOGIC ===
        let activeTokenEditing = null;

        // Token Metadata Database
        const tokenMetadata = {
            'Background/primary': { category: 'Foundation', description: 'Main application background. Used for the base canvas of your app.' },
            'Background/secondary': { category: 'Foundation', description: 'Secondary background for alternate sections or nested content.' },
            'Background/tertiary': { category: 'Foundation', description: 'Tertiary background for deeply nested elements.' },
            'Background/inverse': { category: 'Foundation', description: 'Inverted background (dark in light mode, light in dark mode).' },
            'Background/brand': { category: 'Foundation', description: 'Subtle brand-colored background for special sections.' },
            'Background/accent': { category: 'Foundation', description: 'Accent background with more pronounced brand color.' },

            'Text/primary': { category: 'Foundation', description: 'Primary text with maximum contrast. Use for headings and important content.' },
            'Text/secondary': { category: 'Foundation', description: 'Secondary text with medium contrast. Use for body text and descriptions.' },
            'Text/tertiary': { category: 'Foundation', description: 'Tertiary text with lower contrast. Use for captions and metadata.' },
            'Text/disabled': { category: 'Foundation', description: 'Disabled text state for inactive elements.' },
            'Text/inverse': { category: 'Foundation', description: 'Text on dark/light backgrounds (inverted).' },
            'Text/brand': { category: 'Foundation', description: 'Brand-colored text for emphasis.' },
            'Text/link': { category: 'Foundation', description: 'Default link color.' },
            'Text/linkHover': { category: 'Foundation', description: 'Link hover state.' },

            'Action/primary': { category: 'Interactive', description: 'Primary action buttons and CTAs. Your main brand color for actions.' },
            'Action/primaryHover': { category: 'Interactive', description: 'Primary button hover state.' },
            'Action/primaryActive': { category: 'Interactive', description: 'Primary button active/pressed state.' },
            'Action/primaryDisabled': { category: 'Interactive', description: 'Primary button disabled state.' },

            'Input/background': { category: 'Components', description: 'Input field background color.' },
            'Input/border': { category: 'Components', description: 'Input field border color.' },
            'Input/borderFocus': { category: 'Components', description: 'Input field border when focused (accessibility).' },
            'Input/borderError': { category: 'Components', description: 'Input field border in error state.' },

            'Status/success': { category: 'Status & Feedback', description: 'Success state color for confirmations and positive feedback.' },
            'Status/successSubtle': { category: 'Status & Feedback', description: 'Subtle success background for alerts and banners.' },
            'Status/warning': { category: 'Status & Feedback', description: 'Warning state color for cautions and alerts.' },
            'Status/warningSubtle': { category: 'Status & Feedback', description: 'Subtle warning background for alerts and banners.' },
            'Status/error': { category: 'Status & Feedback', description: 'Error state color for failures and validation errors.' },
            'Status/errorSubtle': { category: 'Status & Feedback', description: 'Subtle error background for alerts and banners.' },
            'Status/info': { category: 'Status & Feedback', description: 'Info state color for informational messages.' },
            'Status/infoSubtle': { category: 'Status & Feedback', description: 'Subtle info background for alerts and banners.' },

            'A11y/focusRing': { category: 'Accessibility', description: 'Focus ring color for keyboard navigation (WCAG compliance).' },
            'A11y/focusRingError': { category: 'Accessibility', description: 'Focus ring color for error states.' }
        };

        function openToneEditor(tokenName) {
            console.log('üî• GOD-TIER Editor opened for:', tokenName);

            activeTokenEditing = tokenName;

            // Set Title and Path
            document.getElementById('editor-title').innerText = 'Edit Token';
            document.getElementById('editor-token-path').innerText = tokenName;

            // Set Metadata
            const metadata = tokenMetadata[tokenName] || {
                category: 'Custom',
                description: 'Custom token. Modify light and dark mode values below.'
            };
            document.getElementById('editor-category').innerText = metadata.category;
            document.getElementById('editor-description').innerText = metadata.description;

            // Determine Palette Source - IMPROVED to prevent mixing
            let paletteType = 'neutral'; // Default

            // Status tokens - most specific first
            if (tokenName.startsWith('Status/success')) {
                paletteType = 'success';
            } else if (tokenName.startsWith('Status/warning')) {
                paletteType = 'warning';
            } else if (tokenName.startsWith('Status/error')) {
                paletteType = 'error';
            } else if (tokenName.startsWith('Status/info')) {
                paletteType = 'accent'; // Info uses accent
            }
            // Action/Button tokens
            else if (tokenName.startsWith('Action/') || tokenName.startsWith('Button/')) {
                paletteType = 'accent';
            }
            // Background tokens
            else if (tokenName.startsWith('Background/brand') || tokenName.startsWith('Background/accent')) {
                paletteType = 'accent';
            }
            // Text tokens
            else if (tokenName.startsWith('Text/brand') || tokenName.startsWith('Text/link')) {
                paletteType = 'accent';
            }
            // Badge tokens
            else if (tokenName.startsWith('Badge/brand')) {
                paletteType = 'accent';
            }
            // Nav tokens
            else if (tokenName.startsWith('Nav/')) {
                paletteType = 'accent';
            }
            // Icon tokens
            else if (tokenName.startsWith('Icon/brand')) {
                paletteType = 'accent';
            }
            // Border tokens
            else if (tokenName.startsWith('Border/brand') || tokenName.startsWith('Border/focus')) {
                paletteType = 'accent';
            }
            // Everything else uses neutral
            else {
                paletteType = 'neutral';
            }

            let palette = paletteCache[paletteType];

            // Fallback: If status palette is empty, use Accent
            if ((!palette || Object.keys(palette).length === 0) && ['success', 'warning', 'error'].includes(paletteType)) {
                if (paletteCache['accent'] && Object.keys(paletteCache['accent']).length > 0) {
                    palette = paletteCache['accent'];
                    console.log(`Fallback: Using accent palette for ${paletteType}`);
                }
            }

            if (!palette || Object.keys(palette).length === 0) {
                alert(`Cannot edit this token. Palette '${paletteType}' is not loaded.`);
                return;
            }

            // Get current values - FIXED to use correct palette
            const getCurrentValue = (mode) => {
                let scale = '500'; // Default

                // Check override first
                if (tokenOverrides[tokenName] && tokenOverrides[tokenName][mode]) {
                    scale = tokenOverrides[tokenName][mode];
                }
                // Get from theme data
                else if (currentThemeData && currentThemeData.tokens[tokenName]) {
                    const token = currentThemeData.tokens[tokenName][mode];
                    const match = token.name.match(/[0-9]+/);
                    scale = match ? match[0] : '500';
                }

                // IMPORTANT: Always get hex from the CURRENT palette, not from stored data
                // This ensures the displayed color matches the palette we're showing
                const hex = palette[scale] || palette['500'] || '#808080';

                return { scale, hex };
            };

            const lightCurrent = getCurrentValue('light');
            const darkCurrent = getCurrentValue('dark');

            // Update current value displays
            document.getElementById('light-current-swatch').style.background = lightCurrent.hex;
            document.getElementById('light-current-scale').innerText = lightCurrent.scale;
            document.getElementById('light-current-hex').innerText = lightCurrent.hex;

            document.getElementById('dark-current-swatch').style.background = darkCurrent.hex;
            document.getElementById('dark-current-scale').innerText = darkCurrent.scale;
            document.getElementById('dark-current-hex').innerText = darkCurrent.hex;

            // Render Swatches with GOD-TIER design
            const renderSwatches = (containerId, mode) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';

                const currentValue = mode === 'light' ? lightCurrent : darkCurrent;

                ['50', '100', '200', '300', '400', '500', '600', '700', '800', '900', '950'].forEach(step => {
                    const hex = palette[step];
                    if (!hex) return;

                    const chip = document.createElement('div');
                    chip.className = 'picker-chip';
                    if (step === currentValue.scale) chip.classList.add('selected');

                    // Color preview
                    const colorDiv = document.createElement('div');
                    colorDiv.className = 'picker-chip-color';
                    colorDiv.style.background = hex;
                    chip.appendChild(colorDiv);

                    // Label (scale value)
                    const label = document.createElement('div');
                    label.className = 'picker-chip-label';
                    label.innerText = step;
                    chip.appendChild(label);

                    // Hex value
                    const hexLabel = document.createElement('div');
                    hexLabel.className = 'picker-chip-hex';
                    hexLabel.innerText = hex.toUpperCase();
                    chip.appendChild(hexLabel);

                    chip.onclick = () => {
                        // Set Override
                        if (!tokenOverrides[tokenName]) tokenOverrides[tokenName] = {};
                        tokenOverrides[tokenName][mode] = step;

                        // Update current display
                        const swatchEl = document.getElementById(`${mode}-current-swatch`);
                        const scaleEl = document.getElementById(`${mode}-current-scale`);
                        const hexEl = document.getElementById(`${mode}-current-hex`);

                        swatchEl.style.background = hex;
                        scaleEl.innerText = step;
                        hexEl.innerText = hex.toUpperCase();

                        // Update selection
                        document.querySelectorAll(`#${containerId} .picker-chip`).forEach(c => c.classList.remove('selected'));
                        chip.classList.add('selected');
                    };

                    container.appendChild(chip);
                });
            };

            renderSwatches('light-swatches', 'light');
            renderSwatches('dark-swatches', 'dark');

            document.getElementById('token-editor-modal').style.display = 'flex';
        }

        // === üî• ULTRA GOD-TIER COMPONENT EDITOR ===
        function openComponentEditor(componentType, currentMode) {
            console.log('üî• ULTRA GOD-TIER Component Editor opened for:', componentType);

            // Component token mappings - EXPANDED for ALL components
            const componentTokens = {
                'button-primary': {
                    name: 'Primary Button',
                    tokens: {
                        normal: ['Action/primary', 'Button/primaryText'],
                        hover: ['Action/primaryHover'],
                        active: ['Action/primaryActive'],
                        disabled: ['Action/primaryDisabled']
                    }
                },
                'button-secondary': {
                    name: 'Secondary Button',
                    tokens: {
                        normal: ['Action/secondary', 'Button/secondaryText'],
                        hover: ['Action/secondaryHover'],
                        active: ['Action/secondaryActive']
                    }
                },
                'button-ghost': {
                    name: 'Ghost Button',
                    tokens: {
                        normal: ['Action/ghost', 'Button/ghostText'],
                        hover: ['Action/ghostHover'],
                        active: ['Action/ghostActive']
                    }
                },
                'button-destructive': {
                    name: 'Destructive Button',
                    tokens: {
                        normal: ['Action/destructive'],
                        hover: ['Action/destructiveHover'],
                        active: ['Action/destructiveActive']
                    }
                },
                'button-disabled': {
                    name: 'Disabled Button',
                    tokens: {
                        disabled: ['Action/primaryDisabled', 'Text/disabled']
                    }
                },
                'input': {
                    name: 'Input Fields',
                    tokens: {
                        normal: ['Input/background', 'Input/border', 'Input/text', 'Input/placeholder'],
                        hover: ['Input/backgroundHover', 'Input/borderHover'],
                        focus: ['Input/backgroundFocus', 'Input/borderFocus'],
                        disabled: ['Input/backgroundDisabled'],
                        normal: ['Input/borderError']
                    }
                },
                'badge': {
                    name: 'Badges & Tags',
                    tokens: {
                        normal: ['Badge/background', 'Badge/text', 'Badge/brandBackground', 'Badge/brandText']
                    }
                },
                'badge-status': {
                    name: 'Status Badges',
                    tokens: {
                        normal: ['Status/successSubtle', 'Status/successText', 'Status/warningSubtle', 'Status/warningText', 'Status/errorSubtle', 'Status/errorText']
                    }
                },
                'navigation': {
                    name: 'Navigation',
                    tokens: {
                        normal: ['Nav/background', 'Nav/itemDefault'],
                        hover: ['Nav/itemHover'],
                        active: ['Nav/itemActive', 'Nav/itemActiveBackground']
                    }
                },
                'icon': {
                    name: 'Icons',
                    tokens: {
                        normal: ['Icon/default', 'Icon/subtle', 'Icon/brand'],
                        disabled: ['Icon/disabled'],
                        normal: ['Icon/inverse']
                    }
                },
                'background': {
                    name: 'Background',
                    tokens: {
                        normal: ['Background/primary', 'Background/secondary', 'Background/tertiary', 'Background/inverse', 'Background/brand', 'Background/accent']
                    }
                },
                'surface': {
                    name: 'Surface / Card',
                    tokens: {
                        normal: ['Surface/level0', 'Surface/level1', 'Surface/level2', 'Surface/level3', 'Surface/level4', 'Card/background', 'Border/default'],
                        hover: ['Card/backgroundHover', 'Card/borderHover']
                    }
                },
                'text': {
                    name: 'Text',
                    tokens: {
                        normal: ['Text/primary', 'Text/secondary', 'Text/tertiary', 'Text/brand', 'Text/link'],
                        hover: ['Text/linkHover'],
                        disabled: ['Text/disabled'],
                        normal: ['Text/inverse']
                    }
                },
                'status-success': {
                    name: 'Success Status',
                    tokens: {
                        normal: ['Status/success', 'Status/successSubtle', 'Status/successText', 'Status/successBorder']
                    }
                },
                'status-warning': {
                    name: 'Warning Status',
                    tokens: {
                        normal: ['Status/warning', 'Status/warningSubtle', 'Status/warningText', 'Status/warningBorder']
                    }
                },
                'status-error': {
                    name: 'Error Status',
                    tokens: {
                        normal: ['Status/error', 'Status/errorSubtle', 'Status/errorText', 'Status/errorBorder']
                    }
                },
                'status-info': {
                    name: 'Info Status',
                    tokens: {
                        normal: ['Status/info', 'Status/infoSubtle', 'Status/infoText', 'Status/infoBorder']
                    }
                }
            };

            const component = componentTokens[componentType];
            if (!component) {
                console.error('Unknown component type:', componentType);
                return;
            }

            // Set component name
            document.getElementById('editor-component-name').innerText = component.name;

            // Get all tokens for this component
            const allTokens = [];
            for (const [state, tokens] of Object.entries(component.tokens)) {
                tokens.forEach(tokenName => {
                    if (currentThemeData && currentThemeData.tokens[tokenName]) {
                        allTokens.push({ tokenName, state });
                    }
                });
            }

            // Render tokens function
            const renderTokens = (stateFilter, modeFilter) => {
                const container = document.getElementById('editor-tokens-container');
                container.innerHTML = '';

                // Filter tokens
                const filteredTokens = allTokens.filter(({ state }) => {
                    if (stateFilter === 'all') return true;
                    return state === stateFilter;
                });

                if (filteredTokens.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">No tokens match the current filters</div>';
                    return;
                }

                // Render each token
                filteredTokens.forEach(({ tokenName, state }) => {
                    const tokenData = currentThemeData.tokens[tokenName];
                    if (!tokenData) return;

                    // Determine palette type - IMPROVED logic to prevent mixing
                    let paletteType = 'neutral'; // Default

                    // Status tokens - check first (most specific)
                    if (tokenName.startsWith('Status/success')) {
                        paletteType = 'success';
                    } else if (tokenName.startsWith('Status/warning')) {
                        paletteType = 'warning';
                    } else if (tokenName.startsWith('Status/error')) {
                        paletteType = 'error';
                    } else if (tokenName.startsWith('Status/info')) {
                        paletteType = 'accent'; // Info uses accent palette
                    }
                    // Action/Button tokens
                    else if (tokenName.startsWith('Action/') || tokenName.startsWith('Button/')) {
                        paletteType = 'accent';
                    }
                    // Background tokens
                    else if (tokenName.startsWith('Background/brand') || tokenName.startsWith('Background/accent')) {
                        paletteType = 'accent';
                    }
                    // Text tokens
                    else if (tokenName.startsWith('Text/brand') || tokenName.startsWith('Text/link')) {
                        paletteType = 'accent';
                    }
                    // Badge tokens
                    else if (tokenName.startsWith('Badge/brand')) {
                        paletteType = 'accent';
                    }
                    // Nav tokens
                    else if (tokenName.startsWith('Nav/')) {
                        paletteType = 'accent';
                    }
                    // Icon tokens
                    else if (tokenName.startsWith('Icon/brand')) {
                        paletteType = 'accent';
                    }
                    // Border tokens
                    else if (tokenName.startsWith('Border/brand') || tokenName.startsWith('Border/focus')) {
                        paletteType = 'accent';
                    }
                    // Everything else uses neutral
                    else {
                        paletteType = 'neutral';
                    }

                    let palette = paletteCache[paletteType];

                    // Fallback logic - only if palette doesn't exist
                    if (!palette || Object.keys(palette).length === 0) {
                        console.warn(`Palette '${paletteType}' not found for token '${tokenName}', falling back to accent`);
                        palette = paletteCache['accent'];
                    }

                    // Last resort fallback
                    if (!palette || Object.keys(palette).length === 0) {
                        console.error(`No palette available for token '${tokenName}'`);
                        return;
                    }

                    // Token card
                    const tokenCard = document.createElement('div');
                    tokenCard.style.cssText = 'background: white; border: 1.5px solid #e5e7eb; border-radius: 8px; padding: 16px;';

                    // Token header
                    const header = document.createElement('div');
                    header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
                    header.innerHTML = `
                        <div>
                            <div style="font-size: 13px; font-weight: 600; color: #111;">${tokenName}</div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">State: ${state}</div>
                        </div>
                    `;
                    tokenCard.appendChild(header);

                    // Mode selection (both, light only, dark only)
                    const showLight = modeFilter === 'both' || modeFilter === 'light';
                    const showDark = modeFilter === 'both' || modeFilter === 'dark';

                    // Create mode sections
                    const modesContainer = document.createElement('div');
                    modesContainer.style.cssText = 'display: grid; grid-template-columns: ' + (showLight && showDark ? '1fr 1fr' : '1fr') + '; gap: 12px;';

                    const renderModeSection = (mode, emoji, bgColor, borderColor) => {
                        if ((mode === 'light' && !showLight) || (mode === 'dark' && !showDark)) return;

                        const section = document.createElement('div');
                        section.style.cssText = `background: ${bgColor}; padding: 12px; border-radius: 6px; border: 1.5px solid ${borderColor};`;

                        // Current value - FIXED to use correct palette
                        const getCurrentValue = () => {
                            let scale = '500'; // Default

                            // Check override first
                            if (tokenOverrides[tokenName] && tokenOverrides[tokenName][mode]) {
                                scale = tokenOverrides[tokenName][mode];
                            }
                            // Get from theme data
                            else {
                                const token = tokenData[mode];
                                const match = token.name.match(/[0-9]+/);
                                scale = match ? match[0] : '500';
                            }

                            // IMPORTANT: Always get hex from the CURRENT palette, not from stored data
                            const hex = palette[scale] || palette['500'] || '#808080';

                            return { scale, hex };
                        };

                        const currentValue = getCurrentValue();

                        section.innerHTML = `
                            <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px;">${emoji} ${mode.toUpperCase()}</div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <div style="width: 24px; height: 24px; border-radius: 4px; background: ${currentValue.hex}; border: 2px solid rgba(0,0,0,0.2);"></div>
                                <div>
                                    <div style="font-size: 12px; font-weight: 600;">${currentValue.scale}</div>
                                    <div style="font-size: 10px; font-family: monospace; color: #6b7280;">${currentValue.hex}</div>
                                </div>
                            </div>
                        `;

                        // Swatches (compact)
                        const swatchesContainer = document.createElement('div');
                        swatchesContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 6px;';

                        ['50', '100', '200', '300', '400', '500', '600', '700', '800', '900', '950'].forEach(step => {
                            const hex = palette[step];
                            if (!hex) return;

                            const chip = document.createElement('div');
                            chip.className = 'picker-chip';
                            chip.style.cssText = 'padding: 6px; cursor: pointer; border-radius: 6px; border: 2px solid transparent; transition: all 0.2s;';
                            if (step === currentValue.scale) {
                                chip.style.borderColor = '#18A0FB';
                                chip.style.background = '#eff6ff';
                            }

                            chip.innerHTML = `
                                <div style="width: 100%; height: 30px; background: ${hex}; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1);"></div>
                                <div style="font-size: 10px; font-weight: 600; text-align: center; margin-top: 4px;">${step}</div>
                            `;

                            chip.onclick = () => {
                                if (!tokenOverrides[tokenName]) tokenOverrides[tokenName] = {};
                                tokenOverrides[tokenName][mode] = step;
                                // Re-render to update
                                renderTokens(stateFilter, modeFilter);
                            };

                            swatchesContainer.appendChild(chip);
                        });

                        section.appendChild(swatchesContainer);
                        modesContainer.appendChild(section);
                    };

                    renderModeSection('light', '‚òÄÔ∏è', '#fefce8', '#fde047');
                    renderModeSection('dark', 'üåô', '#f3f4f6', '#9ca3af');

                    tokenCard.appendChild(modesContainer);
                    container.appendChild(tokenCard);
                });
            };

            // Initial render
            renderTokens('all', 'both');

            // Filter change handlers
            document.getElementById('editor-state-filter').onchange = (e) => {
                const modeFilter = document.getElementById('editor-mode-filter').value;
                renderTokens(e.target.value, modeFilter);
            };

            document.getElementById('editor-mode-filter').onchange = (e) => {
                const stateFilter = document.getElementById('editor-state-filter').value;
                renderTokens(stateFilter, e.target.value);
            };

            // Show modal
            document.getElementById('token-editor-modal').style.display = 'flex';
        }

        // Close button (X)
        document.getElementById('editor-close-x').onclick = () => {
            document.getElementById('token-editor-modal').style.display = 'none';
        };

        // Apply button - IMPROVED to update preview immediately
        document.getElementById('editor-apply').onclick = () => {
            document.getElementById('token-editor-modal').style.display = 'none';

            // Update preview immediately with overrides before regenerating
            if (currentThemeData) {
                const currentMode = themePreviewMode.value || 'light';

                // Apply overrides to currentThemeData temporarily for preview
                const updatedThemeData = JSON.parse(JSON.stringify(currentThemeData)); // Deep copy

                for (const [tokenName, modeOverrides] of Object.entries(tokenOverrides)) {
                    if (updatedThemeData.tokens[tokenName]) {
                        for (const [overrideMode, scale] of Object.entries(modeOverrides)) {
                            // Determine palette type for this token
                            let paletteType = 'neutral';
                            if (tokenName.startsWith('Status/success')) paletteType = 'success';
                            else if (tokenName.startsWith('Status/warning')) paletteType = 'warning';
                            else if (tokenName.startsWith('Status/error')) paletteType = 'error';
                            else if (tokenName.startsWith('Status/info')) paletteType = 'accent';
                            else if (tokenName.startsWith('Action/') || tokenName.startsWith('Button/')) paletteType = 'accent';
                            else if (tokenName.startsWith('Background/brand') || tokenName.startsWith('Background/accent')) paletteType = 'accent';
                            else if (tokenName.startsWith('Text/brand') || tokenName.startsWith('Text/link')) paletteType = 'accent';
                            else if (tokenName.startsWith('Badge/brand')) paletteType = 'accent';
                            else if (tokenName.startsWith('Nav/')) paletteType = 'accent';
                            else if (tokenName.startsWith('Icon/brand')) paletteType = 'accent';
                            else if (tokenName.startsWith('Border/brand') || tokenName.startsWith('Border/focus')) paletteType = 'accent';

                            const palette = paletteCache[paletteType] || paletteCache['accent'] || paletteCache['neutral'];
                            if (palette && palette[scale]) {
                                updatedThemeData.tokens[tokenName][overrideMode] = {
                                    name: `${paletteType}-${scale}`,
                                    hex: palette[scale]
                                };
                            }
                        }
                    }
                }

                // Update preview with modified data
                renderThemePreview(updatedThemeData, currentMode);
            }

            // Trigger Regenerate to apply changes permanently
            regenerateThemeBtn.click();
        };

        // Reset All button (for component editor)
        document.getElementById('editor-reset-all').onclick = () => {
            // Clear all overrides
            if (confirm('Reset all changes? This will restore all tokens to their default values.')) {
                tokenOverrides = {};
                document.getElementById('token-editor-modal').style.display = 'none';
                regenerateThemeBtn.click();
            }
        };

        // Close on outside click
        document.getElementById('token-editor-modal').onclick = (e) => {
            if (e.target.id === 'token-editor-modal') {
                document.getElementById('token-editor-modal').style.display = 'none';
            }
        };
    </script>
</body>

</html>